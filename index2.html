<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מערכת ניהול פרימיום - ח. סבן</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --background-start: #f8fafc; --background-end: #f1f5f9; 
            --text-primary: #0f172a; --text-secondary: #64748b; 
            --card-bg: #ffffff; --border-color: #e2e8f0; --accent-color: #2563eb; 
            --edge-bg: rgba(255, 255, 255, 0);
        }
        html.dark {
            --background-start: #0f172a; --background-end: #1e293b;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8;
            --card-bg: #1e293b; --border-color: #334155; --accent-color: #3b82f6;
            --edge-bg: rgba(30, 41, 59, 0);
        }
        body { 
            font-family: 'Heebo', sans-serif; 
            background-color: var(--background-start);
            color: var(--text-primary);
        }
        .view { display: none; }
        .view.active { display: block; }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900">

    <div id="app-container" class="max-w-4xl mx-auto p-4">
        
        <!-- Login View -->
        <div id="login-view" class="view active">
            <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg mt-20">
                <h1 class="text-3xl font-bold text-center text-slate-800 dark:text-slate-200">כניסה למערכת</h1>
                <p class="text-center text-slate-500 dark:text-slate-400 mt-2">אנא הזן את פרטי ההתחברות שלך</p>
                <div class="mt-8">
                    <input id="phone" type="tel" placeholder="מספר טלפון" class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="login-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold mt-4 hover:bg-blue-700 transition-colors">כניסה</button>
                    <div id="login-error" class="text-red-500 text-center mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="view">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-200">ברוך הבא, <span id="user-name"></span>!</h1>
                    <p class="text-slate-500 dark:text-slate-400">מערכת ניהול פרימיום</p>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </header>

            <!-- Navigation -->
            <nav class="flex items-center justify-center space-x-1 space-x-reverse bg-white dark:bg-slate-800 p-2 rounded-xl shadow-md mb-6">
                 <button data-view="dashboard-view" class="nav-btn flex-1 text-center p-2 rounded-lg font-semibold bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">ראשי</button>
                 <button data-view="containers-view" class="nav-btn flex-1 text-center p-2 rounded-lg font-semibold text-slate-600 dark:text-slate-300">מכולות</button>
                 <button data-view="orders-view" class="nav-btn flex-1 text-center p-2 rounded-lg font-semibold text-slate-600 dark:text-slate-300">הזמנות</button>
            </nav>

            <main>
                <!-- Dashboard View -->
                <div id="dashboard-view" class="page-view active">
                    <h2 class="text-xl font-bold mb-4">דוחות וסיכומים</h2>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold mb-4">הזמנות ב-7 הימים האחרונים</h3>
                        <canvas id="orders-chart"></canvas>
                    </div>
                </div>

                <!-- Containers View -->
                <div id="containers-view" class="page-view hidden">
                    <h2 class="text-xl font-bold mb-4">סטטוס מכולות</h2>
                    <div id="containers-list" class="space-y-4">
                        <!-- Container cards will be injected here -->
                    </div>
                </div>

                <!-- Orders View -->
                <div id="orders-view" class="page-view hidden">
                     <h2 class="text-xl font-bold mb-4">היסטוריית הזמנות</h2>
                     <div id="orders-list" class="space-y-4">
                        <!-- Order cards will be injected here -->
                     </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginView = document.getElementById('login-view');
            const mainAppView = document.getElementById('main-app-view');
            const loginBtn = document.getElementById('login-btn');
            const phoneInput = document.getElementById('phone');
            const loginError = document.getElementById('login-error');
            const userNameEl = document.getElementById('user-name');
            const navButtons = document.querySelectorAll('.nav-btn');
            const pageViews = document.querySelectorAll('.page-view');
            const containersList = document.getElementById('containers-list');
            const ordersList = document.getElementById('orders-list');

            let appData = {};
            let ordersChartInstance = null;
            
            // --- Event Listeners ---
            loginBtn.addEventListener('click', handleLogin);
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetViewId = e.currentTarget.dataset.view;
                    
                    // Update button styles
                    navButtons.forEach(b => {
                        b.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-600', 'dark:text-blue-300');
                        b.classList.add('text-slate-600', 'dark:text-slate-300');
                    });
                    e.currentTarget.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-600', 'dark:text-blue-300');

                    // Show target page view
                    pageViews.forEach(v => {
                        v.id === targetViewId ? v.classList.remove('hidden') : v.classList.add('hidden');
                    });
                });
            });

            // --- Functions ---
            function handleLogin() {
                const phone = phoneInput.value;
                loginError.textContent = '';
                loginBtn.disabled = true;
                loginBtn.textContent = 'מתחבר...';

                google.script.run
                    .withSuccessHandler(onLoginSuccess)
                    .withFailureHandler(onLoginFailure)
                    .loginUser(phone, ''); // Password not used currently
            }

            function onLoginSuccess(response) {
                userNameEl.textContent = response.name;
                loginView.classList.remove('active');
                mainAppView.classList.add('active');
                loadAppData(response.customerId);
            }

            function onLoginFailure(error) {
                loginError.textContent = error.message;
                loginBtn.disabled = false;
                loginBtn.textContent = 'כניסה';
            }

            function loadAppData(customerId) {
                 google.script.run
                    .withSuccessHandler(onAppDataLoaded)
                    .withFailureHandler(onLoginFailure) // Reuse for simplicity
                    .getAppData(customerId);
            }

            function onAppDataLoaded(data) {
                appData = data;
                renderAllComponents();
            }

            function renderAllComponents() {
                renderContainers();
                renderOrders();
                renderDashboardChart();
            }
            
            /**
             * NEW/FIXED: Renders the container list with correct data keys and date formatting.
             */
            function renderContainers() {
                if (!appData.containers || appData.containers.length === 0) {
                    containersList.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">אין מכולות להצגה.</p>`;
                    return;
                }
                
                containersList.innerHTML = appData.containers.map(container => {
                    const placementDate = new Date(container.תאריך_הצבה); // Parse ISO date string
                    const formattedDate = !isNaN(placementDate) ? placementDate.toLocaleDateString('he-IL') : 'תאריך לא תקין';

                    return `
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-slate-800 dark:text-slate-200">${container.projectName || 'לא משויך לפרויקט'}</p>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">${container.כתובת_אתר || ''}</p>
                                </div>
                                <span class="text-sm font-semibold py-1 px-3 rounded-full ${container.סטטוס === 'בקשה חדשה' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">
                                    ${container.סטטוס}
                                </span>
                            </div>
                            <div class="mt-4 text-sm text-slate-600 dark:text-slate-300">
                                תאריך הצבה: ${formattedDate}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            /**
             * NEW/FIXED: Renders the orders list with correct data keys and date formatting.
             */
            function renderOrders() {
                if (!appData.orders || appData.orders.length === 0) {
                    ordersList.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">אין הזמנות להצגה.</p>`;
                    return;
                }

                ordersList.innerHTML = appData.orders.map(order => {
                    const orderDate = new Date(order.תאריך_הזמנה);
                    const formattedDate = !isNaN(orderDate) ? orderDate.toLocaleDateString('he-IL') : 'תאריך לא תקין';
                    const items = order.פריטים_JSON ? JSON.parse(order.פריטים_JSON) : [];

                    return `
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md">
                             <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-slate-800 dark:text-slate-200">הזמנה #${order.מזהה_הזמנה}</p>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">${items.length} פריטים</p>
                                </div>
                                <span class="text-sm font-semibold py-1 px-3 rounded-full ${order.סטטוס === 'חדשה' ? 'bg-blue-200 text-blue-800' : 'bg-gray-200 text-gray-800'}">
                                    ${order.סטטוס}
                                </span>
                            </div>
                            <div class="mt-4 text-sm text-slate-600 dark:text-slate-300">
                                תאריך הזמנה: ${formattedDate}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            /**
             * NEW: Renders the dashboard chart for the last 7 days.
             */
            function renderDashboardChart() {
                const ctx = document.getElementById('orders-chart').getContext('2d');
                if (ordersChartInstance) {
                    ordersChartInstance.destroy();
                }

                // Prepare data for the chart
                const labels = [];
                const dataPoints = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    labels.push(date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' }));
                    
                    const ordersOnDate = (appData.orders || []).filter(order => {
                        const orderDate = new Date(order.תאריך_הזמנה);
                        orderDate.setHours(0, 0, 0, 0);
                        return orderDate.getTime() === date.getTime();
                    });
                    dataPoints.push(ordersOnDate.length);
                }

                ordersChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'כמות הזמנות',
                            data: dataPoints,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Theme toggling logic (remains the same)
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');

            function applySavedTheme() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            }

            themeToggle.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
                applySavedTheme();
            });
            
            applySavedTheme();

        });
    </script>
</body>
</html>
