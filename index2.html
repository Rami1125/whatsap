<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מערכת ניהול פרימיום - ח. סבן</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base Setup --- */
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }
        :root { 
            --background-start: #f8fafc; --background-end: #f1f5f9; 
            --text-primary: #0f172a; --text-secondary: #64748b; 
            --card-bg: #ffffff; --border-color: #e2e8f0; --accent-color: #2563eb; 
        }
        html.dark { 
            --background-start: #020617; --background-end: #0f172a; 
            --text-primary: #f8fafc; --text-secondary: #94a3b8; 
            --card-bg: #1e293b; --border-color: #334155; 
        }
        body { 
            font-family: 'Heebo', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
        }
        
        /* --- Stable Samsung Frame with Fixed Height --- */
        .samsung-frame {
            width: 100%;
            height: 100%; /* Fill parent (body) */
            max-width: 440px;
            max-height: 950px; /* Fixed height for desktop */
            margin: auto;
            border: 12px solid #1c1c1c;
            border-radius: 40px;
            box-shadow: 0 20px 60px -10px rgba(0,0,0,0.5);
            display: flex; /* Use flex to manage children */
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background-color: #000;
        }
        .samsung-screen { 
            flex: 1; /* Take all available space in the frame */
            overflow: hidden;
            position: relative; 
            background-color: var(--background-start); /* Fallback */
            background: linear-gradient(to bottom, var(--background-start), var(--background-end)); 
            color: var(--text-primary); 
            border-radius: 28px;
            display: flex; /* Crucial for internal layout */
            flex-direction: column;
        }
        .camera-punch-hole {
            position: absolute; top: 25px; left: 50%;
            transform: translateX(-50%); width: 12px; height: 12px;
            background: #111; border-radius: 50%; z-index: 100;
        }
        
        /* --- Page & Animation Logic --- */
        .page, .modal, .wizard-step { display: none; }
        .page.active, .wizard-step.active { display: block; animation: fadeInPage 0.5s; }
        .modal.active { display: flex; animation: fadeInOverlay 0.3s ease-out forwards; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        .modal.active .card { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .nav-btn.active { color: var(--accent-color); font-weight: 500; }
        .popup { transition: opacity 0.3s, transform 0.3s; }
        .popup.show { opacity: 1; transform: translateY(0); }
        
        /* --- REMOVED: Grid layout for the main app structure --- */
        /* #main-app {
            display: grid;
            grid-template-rows: auto 1fr auto; 
        } */
        
        /* --- Shine Effect --- */
        .interactive-shine { position: relative; overflow: hidden; }
        .interactive-shine::before {
            content: ''; position: absolute; left: var(--shine-x, -100px); top: var(--shine-y, -100px);
            transform: translate(-50%, -50%); width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 60%);
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        .interactive-shine:hover::before, .interactive-shine.touch-active::before { opacity: 1; }
        html.dark .interactive-shine::before { background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 60%); }

        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); }
        .nav-bar { background-color: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .text-secondary { color: var(--text-secondary); }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .form-luxury-bg { background-image: url('https://hetzroni.co.il/wp-content/uploads/2022/01/%D7%91%D7%9E%D7%97%D7%9C%D7%A7%D7%AA-%D7%90%D7%91%D7%99%D7%96%D7%A8%D7%99-%D7%91%D7%A0%D7%99%D7%99%D7%9F-%D7%95%D7%97%D7%95%D7%9E%D7%A8%D7%99-%D7%91%D7%A0%D7%99%D7%94-%D7%A9%D7%99%D7%A4%D7%95%D7%A6%D7%99%D7%9D-%D7%9C%D7%A7%D7%91%D7%9C%D7%A0%D7%99%D7%9D-%D7%91%D7%91%D7%A0%D7%99%D7%99%D7%A0%D7%99%D7%9D-%D7%95%D7%91%D7%91%D7%99%D7%AA-%D7%9C%D7%9C%D7%A7%D7%95%D7%97%D7%95%D7%AA-%D7%95%D7%9E%D7%A9%D7%9C%D7%95%D7%97%D7%99%D7%9D-%D7%91%D7%90%D7%99%D7%A0%D7%98%D7%A8%D7%A0%D7%98-%D7%A9%D7%9C-%D7%97%D7%95%D7%9E%D7%A8%D7%99-%D7%91%D7%A0%D7%99%D7%94-%D7%9E%D7%91%D7%A8%D7%A9%D7%95%D7%AA-%D7%95%D7%A8%D7%95%D7%9C%D7%A8%D7%99%D7%9D-%D7%9C%D7%A6%D7%91%D7%99%D7%A2%D7%94.jpg'); background-size: cover; background-position: center; }
        .form-luxury-bg::before { content: ''; position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(2px); z-index: 1; }
        html.dark .form-luxury-bg::before { background-color: rgba(0, 0, 0, 0.85); }
        .form-content { position: relative; z-index: 2; }
        .color-swatch { transition: transform 0.2s, box-shadow 0.2s; }
        .color-swatch:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="samsung-frame">
        <div id="app-screen" class="samsung-screen">
            <div class="camera-punch-hole"></div>
            
            <!-- Login Page -->
            <!-- FIX: Replaced h-full with flex-1 for robust height calculation within a flex container -->
            <div id="login-page" class="page active flex-1 flex flex-col justify-center items-center bg-slate-200 dark:bg-slate-900 p-8">
                <div class="w-full max-w-sm text-center space-y-6">
                    <img id="login-logo" src="https://placehold.co/150x50/1e293b/FFFFFF?text=H.SABAN" alt="Company Logo" class="mx-auto h-12">
                    <div class="relative inline-block">
                         <img id="user-avatar" src="https://placehold.co/100x100/FFFFFF/CCCCCC?text=" alt="User Avatar" class="w-28 h-28 rounded-full mx-auto border-4 border-white shadow-lg">
                         <div class="absolute -top-2 -right-2 text-4xl animate-wave">👋</div>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">ברוכים הבאים</h1>
                    <div><input id="phone-input" type="tel" placeholder="מספר טלפון" class="w-full bg-white/50 border-b-2 border-slate-300 text-center text-slate-800 placeholder-slate-500 focus:outline-none focus:border-blue-500 py-3 rounded-t-lg"></div>
                    <div><input id="password-input" type="password" placeholder="סיסמה" class="w-full bg-white/50 border-b-2 border-slate-300 text-center text-slate-800 placeholder-slate-500 focus:outline-none focus:border-blue-500 py-3 rounded-b-lg mb-4"></div>
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg shadow-blue-500/30 interactive-shine">כניסה</button>
                </div>
            </div>

            <!-- Main App Content -->
            <!-- FIX: Switched to a Flexbox layout for stability. `flex-1` makes this container fill the screen. -->
            <div id="main-app" class="hidden flex-1 flex flex-col">
                 <header class="p-4 pt-10 flex justify-between items-center z-20">
                    <h1 id="header-title" class="text-xl font-bold"></h1>
                    <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg class="w-6 h-6 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </header>
                <!-- FIX: Added `flex-1` to make the main content area expand and fill all available space. -->
                <main class="flex-1 overflow-y-auto p-4 pt-0">
                    <div id="home-page" class="page h-full">
                        <p class="text-secondary mb-6">מה תרצה לעשות היום?</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button class="quick-action-btn card p-4 rounded-2xl text-center aspect-square flex flex-col justify-center items-center transition-all duration-200 active:scale-95 active:bg-slate-100 interactive-shine" data-action="new-order"><span class="text-4xl mb-2">📦</span><span class="font-semibold">הזמנה חדשה</span></button>
                            <button class="nav-btn-link card p-4 rounded-2xl text-center aspect-square flex flex-col justify-center items-center transition-all duration-200 active:scale-95 active:bg-slate-100 interactive-shine" data-page="tinting-page"><span class="text-4xl mb-2">🎨</span><span class="font-semibold">הזמנת גיוון</span></button>
                            <button class="nav-btn-link card p-4 rounded-2xl text-center aspect-square flex flex-col justify-center items-center transition-all duration-200 active:scale-95 active:bg-slate-100 interactive-shine" data-page="containers-page"><span class="text-4xl mb-2">🏗️</span><span class="font-semibold">סטטוס מכולה</span></button>
                            <button class="nav-btn-link card p-4 rounded-2xl text-center aspect-square flex flex-col justify-center items-center transition-all duration-200 active:scale-95 active:bg-slate-100 interactive-shine" data-page="materials-page"><span class="text-4xl mb-2">📜</span><span class="font-semibold">היסטוריית הזמנות</span></button>
                        </div>
                    </div>
                    <div id="containers-page" class="page h-full"><p class="text-center p-8 text-secondary">בקרוב: מעקב אחר מכולות</p></div>
                    <div id="materials-page" class="page h-full"><p class="text-center p-8 text-secondary">בקרוב: היסטוריית הזמנות מפורטת</p></div>
                    <div id="reports-page" class="page h-full"><p class="text-center p-8 text-secondary">בקרוב: דוחות וניתוחים</p></div>

                    <div id="tinting-page" class="page h-full">
                        <p class="text-secondary mb-4">בחר את הגוון הרצוי מהמניפה. תוכל לסנן לפי מותג.</p>
                        <div class="flex gap-2 mb-4">
                            <button class="brand-filter-btn flex-1 p-2 rounded-lg border-2 border-blue-600 bg-blue-600 text-white transition-transform duration-150 active:scale-95" data-brand="all">הכל</button>
                            <button class="brand-filter-btn flex-1 p-2 rounded-lg border-2 border-slate-300 dark:border-slate-600 transition-transform duration-150 active:scale-95" data-brand="נירלט">נירלט</button>
                            <button class="brand-filter-btn flex-1 p-2 rounded-lg border-2 border-slate-300 dark:border-slate-600 transition-transform duration-150 active:scale-95" data-brand="טמבור">טמבור</button>
                        </div>
                        <div id="color-swatch-grid" class="grid grid-cols-3 gap-4"></div>
                    </div>
                </main>
                
                <nav class="nav-bar flex justify-around text-secondary text-xs z-30 rounded-b-[28px]"></nav>
                <div id="popup-container" class="absolute bottom-20 left-4 right-4 space-y-2 z-50"></div>
            </div>

            <!-- Full screen pages -->
            <div id="order-wizard-page" class="page absolute inset-0 form-luxury-bg z-40">
                 <div class="form-content h-full flex flex-col p-4 pt-10">
                    <div class="mb-6"><div class="w-full bg-slate-200 rounded-full h-4 dark:bg-slate-700 relative"><div id="order-progress-bar" class="bg-blue-600 h-4 rounded-full progress-bar flex items-center justify-center text-white text-xs font-bold" style="width: 33%">33%</div></div></div>
                    <div class="flex-1 overflow-y-auto">
                        <div id="order-step-1" class="wizard-step active">
                            <h2 class="text-3xl font-bold mb-2">שלב 1: למי ההזמנה?</h2><p class="text-secondary mb-6">בחר את הפרויקט או הכתובת למשלוח.</p>
                            <div class="space-y-6"><div><label class="font-semibold mb-2 block">בחירת פרויקט</label><input type="text" placeholder="התחל להקליד שם פרויקט..." class="w-full p-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 transition"></div><div><label class="font-semibold mb-2 block">כתובת</label><input type="text" value="אנקורים 2, רמת גן" class="w-full p-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 transition"></div></div>
                        </div>
                        <div id="order-step-2" class="wizard-step">
                             <h2 class="text-3xl font-bold mb-2">שלב 2: מה להביא?</h2><p class="text-secondary mb-6">הוסף פריטים וצרף קובץ במידת הצורך.</p>
                             <div class="space-y-6"><p class="text-center text-secondary py-8">מנגנון הוספת פריטים יופיע כאן</p><div><label for="file-upload" class="w-full flex items-center justify-center gap-2 p-4 border-2 border-dashed rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800"><span>📷</span><span>הוסף תמונה / קובץ</span></label><input id="file-upload" type="file" class="hidden"><p id="file-name" class="text-sm text-secondary mt-2 text-center"></p></div></div>
                        </div>
                        <div id="order-step-3" class="wizard-step">
                             <h2 class="text-3xl font-bold mb-2">שלב 3: סיכום ושליחה</h2><p class="text-secondary mb-6">בדוק שהכל נכון לפני השליחה.</p>
                             <div class="space-y-6"><div class="card p-4 rounded-lg min-h-[200px]"><p class="text-center text-secondary">סיכום ההזמנה יוצג כאן</p></div></div>
                        </div>
                    </div>
                     <div class="flex gap-4 mt-6">
                        <button id="order-back-btn" class="w-1/3 bg-slate-300 dark:bg-slate-600 font-bold py-3 rounded-lg" onclick="goToOrderStep('back')">הקודם</button>
                        <button id="order-next-btn" class="w-2/3 bg-blue-500 text-white font-bold py-3 rounded-lg" onclick="goToOrderStep('next')">הבא</button>
                        <button id="order-send-btn" class="w-2/3 bg-green-500 text-white font-bold py-3 rounded-lg hidden">אישור ושליחה</button>
                    </div>
                </div>
            </div>

            <!-- Modal Container -->
            <div id="modal-container" class="hidden absolute inset-0 z-[99]">
                <div id="paint-order-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4">
                    <div class="card rounded-2xl p-6 w-full max-w-sm relative">
                        <button id="close-tint-modal-btn" class="absolute top-2 right-2 p-1 rounded-full text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 focus:outline-none z-10">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <div id="paint-order-header" class="text-center mb-4 pb-4 border-b border-border-color"></div>
                        <h3 class="text-lg font-semibold mb-4 text-center">פרטי הזמנת גיוון</h3>
                        <div class="space-y-4">
                            <select id="paint-branch" class="w-full p-3 border-2 rounded-lg bg-transparent border-slate-300 focus:border-blue-500 outline-none"><option value="">בחר סניף</option><option value="התלמיד">סניף התלמיד</option><option value="החרש">סניף החרש</option></select>
                            <div><input id="paint-liters" type="number" min="1" max="18" placeholder="כמות (1-18 ליטר)" class="w-full p-3 border-2 bg-transparent rounded-lg border-slate-300 focus:border-blue-500 outline-none"><p class="text-xs text-secondary mt-1">כפוף לזמינות במלאי</p></div>
                            <button id="send-tint-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-transform active:scale-95">שליחת הזמנה</button>
                            <button id="cancel-tint-btn" class="w-full p-2 mt-2 text-secondary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-transform active:scale-95">ביטול</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbySlBiMdN2PyqG151h_urG7Hp_yz-v2XBhT9WCdrE7WEWKYAOHhJSIXeqZLRth5DvR_DA/exec';
            const loginPage = document.getElementById('login-page');
            const mainApp = document.getElementById('main-app');
            const loginBtn = document.getElementById('login-btn');
            const navContainer = document.querySelector('nav');
            const popupContainer = document.getElementById('popup-container');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const headerTitle = document.getElementById('header-title');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameDisplay = document.getElementById('file-name');
            const modalContainer = document.getElementById('modal-container');
            const cancelTintBtn = document.getElementById('cancel-tint-btn');
            const sendTintBtn = document.getElementById('send-tint-btn');
            const closeTintModalBtn = document.getElementById('close-tint-modal-btn');

            const orderWizardState = { currentStep: 1, totalSteps: 3 };
            let currentPaintOrder = {};
            let appData = { colors: [] };
            let currentUser = {};

            const encouragementMessages = ["יופי של התחלה!", "כבר כמעט שם...", "עבודה נהדרת!", "ממשיכים במלוא המרץ!"];
            
            async function apiCall(action, params = {}) {
                const formData = new FormData();
                formData.append('action', action);
                for (const key in params) {
                    formData.append(key, params[key]);
                }
                
                try {
                    const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.status === 'error') throw new Error(result.message);
                    return result.data;
                } catch (error) {
                    console.error('API Call Error:', action, error);
                    let userMessage = error.message.includes('Failed to fetch') 
                        ? 'שגיאת רשת. בדוק את החיבור לאינטרנט.'
                        : `שגיאה בפעולה: ${error.message}`;
                    showPopup(userMessage, 4000);
                    throw error;
                }
            }
            
            function showPopup(message, duration = 3000) {
                const popup = document.createElement('div');
                popup.className = 'popup bg-slate-800 text-white text-center py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-4';
                popup.textContent = message;
                popupContainer.appendChild(popup);
                setTimeout(() => { popup.classList.add('show'); }, 10);
                setTimeout(() => { popup.classList.remove('show'); setTimeout(() => popup.remove(), 300); }, duration);
            }
            
            function applySavedTheme() {
                if (localStorage.getItem('theme') === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            async function handleLogin() {
                const phone = document.getElementById('phone-input').value;
                const password = document.getElementById('password-input').value;
                loginBtn.disabled = true;
                loginBtn.textContent = 'מתחבר...';

                try {
                    const userData = await apiCall('login', { phone, password });
                    currentUser = userData;

                    loginPage.style.transition = 'opacity 0.5s, transform 0.5s';
                    loginPage.style.opacity = '0';
                    
                    setTimeout(async () => {
                        loginPage.classList.remove('active');
                        mainApp.classList.remove('hidden');
                        applySavedTheme();
                        
                        showPopup('טוען נתונים...');
                        const data = await apiCall('getAppData', { customerId: currentUser.customerId });
                        appData = data;
                        
                        switchPage('home-page');
                        showPopup(`ברוך השב, ${currentUser.name}!`);
                        setTimeout(() => showPopup(`כניסה אחרונה שלך: אתמול, 17:30`), 1500);

                    }, 500);

                } catch (error) {
                     showPopup('פרטי ההתחברות שגויים');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'כניסה';
                }
            }
            
            function switchPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
                
                const pageTitles = {'home-page': 'דף הבית', 'containers-page': 'מגדל הפיקוח', 'materials-page': 'היסטוריית הזמנות', 'reports-page': 'דוחות וניתוחים', 'order-wizard-page': 'הזמנה חדשה', 'tinting-page': 'מניפת גוונים'};
                headerTitle.textContent = pageTitles[pageId] || 'ח. סבן';
                
                if(pageId === 'tinting-page') renderColorSwatches();
            }

            window.goToOrderStep = function(direction) {
                const { currentStep, totalSteps } = orderWizardState; let nextStep = currentStep;
                if (direction === 'next' && currentStep < totalSteps) nextStep++;
                else if (direction === 'back' && currentStep > 1) nextStep--;
                else if (typeof direction === 'number') nextStep = direction;
                if (nextStep !== currentStep) {
                    orderWizardState.currentStep = nextStep;
                    updateOrderWizardView();
                    if (direction === 'next') showPopup(encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)], 2000);
                }
            }
            
            function updateOrderWizardView() {
                const { currentStep, totalSteps } = orderWizardState;
                document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
                document.getElementById(`order-step-${currentStep}`).classList.add('active');
                const percentage = Math.round((currentStep / totalSteps) * 100);
                const progressBar = document.getElementById('order-progress-bar');
                progressBar.style.width = `${percentage}%`; progressBar.textContent = `${percentage}%`;
                document.getElementById('order-back-btn').classList.toggle('hidden', currentStep === 1);
                document.getElementById('order-next-btn').classList.toggle('hidden', currentStep === totalSteps);
                document.getElementById('order-send-btn').classList.toggle('hidden', currentStep !== totalSteps);
            }
            
            function openModal(modalId) { 
                modalContainer.classList.remove('hidden');
                document.getElementById(modalId).classList.add('active'); 
            }
            function closeModal(modalId) { 
                document.getElementById(modalId).classList.remove('active');
                setTimeout(() => {
                    if (!modalContainer.querySelector('.modal.active')) {
                        modalContainer.classList.add('hidden');
                    }
                }, 300); 
            }
            
            function renderColorSwatches(brandFilter = 'all') {
                const grid = document.getElementById('color-swatch-grid');
                grid.innerHTML = '';
                const filteredColors = brandFilter === 'all' ? (appData.colors || []) : (appData.colors || []).filter(c => c.מותג === brandFilter);
                if (!filteredColors || filteredColors.length === 0) {
                    grid.innerHTML = `<p class="col-span-3 text-center text-secondary">לא נמצאו גוונים. ודא שהגדרת את גיליון 'גוונים' בחשבון Google שלך.</p>`;
                    return;
                }
                filteredColors.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch card rounded-lg text-center aspect-square flex flex-col justify-between shadow-sm cursor-pointer transition-transform duration-150 active:scale-95';
                    const colorData = { brand: color.מותג, name: color.שם_גוון, code: color.קוד_גוון, hex: color.hex };
                    swatch.innerHTML = `<div class="w-full h-2/3 rounded-t-lg" style="background-color: ${colorData.hex};"></div><div class="p-2 text-xs"><p class="font-bold">${colorData.name}</p><p class="text-secondary">${colorData.code}</p></div>`;
                    swatch.onclick = () => openTintOrderModal(colorData);
                    grid.appendChild(swatch);
                });
            }
            
            function openTintOrderModal(color) {
                currentPaintOrder = color;
                const header = document.getElementById('paint-order-header');
                header.innerHTML = `<div class="w-16 h-16 rounded-full mx-auto mb-2 border-4" style="background-color: ${color.hex};"></div><h2 class="text-xl font-bold">${color.name}</h2><p class="text-secondary">${color.code} - ${color.brand}</p>`;
                document.getElementById('paint-branch').value = '';
                document.getElementById('paint-liters').value = '';
                openModal('paint-order-modal');
            }

            async function sendTintOrder() {
                const orderData = { 
                    ...currentPaintOrder, 
                    branch: document.getElementById('paint-branch').value, 
                    liters: document.getElementById('paint-liters').value,
                    customerId: currentUser.customerId,
                    customerName: currentUser.name
                };

                if (!orderData.branch || !orderData.liters) { showPopup('יש למלא את כל הפרטים', 2500); return; }
                
                sendTintBtn.disabled = true;
                sendTintBtn.textContent = 'שולח...';

                try {
                    await apiCall('addNewTintOrder', { tintData: JSON.stringify(orderData) });
                    showPopup('הזמנת הגיוון נשלחה בהצלחה!');
                    closeModal('paint-order-modal');
                } catch (error) {
                    showPopup('שליחת ההזמנה נכשלה');
                } finally {
                    sendTintBtn.disabled = false;
                    sendTintBtn.textContent = 'שליחת הזמנה';
                }
            }
            
            function setupNavigation() {
                const navItems = [{ id: 'home-page', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'ראשי' }, { id: 'containers-page', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4', label: 'מכולות' }, { id: 'materials-page', icon: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4', label: 'היסטוריה' }, { id: 'reports-page', icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z', label: 'דוחות' }];
                navContainer.innerHTML = navItems.map(item => `<button data-page="${item.id}" class="nav-btn flex-1 flex flex-col items-center p-3"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"></path></svg>${item.label}</button>`).join('');
                document.querySelectorAll('.nav-btn, .nav-btn-link').forEach(btn => btn.addEventListener('click', () => switchPage(btn.dataset.page)));
            }
            
            function setupInteractiveShine() {
                document.querySelectorAll('.interactive-shine').forEach(el => {
                    const updateShine = (e) => {
                        const rect = el.getBoundingClientRect();
                        let x, y;
                        if (e.touches) {
                            x = e.touches[0].clientX - rect.left;
                            y = e.touches[0].clientY - rect.top;
                        } else {
                            x = e.clientX - rect.left;
                            y = e.clientY - rect.top;
                        }
                        el.style.setProperty('--shine-x', `${x}px`);
                        el.style.setProperty('--shine-y', `${y}px`);
                    };
                    el.addEventListener('mousemove', updateShine);
                    el.addEventListener('touchmove', updateShine, { passive: true });
                    el.addEventListener('touchstart', (e) => {
                        el.classList.add('touch-active');
                        updateShine(e);
                    }, { passive: true });
                    el.addEventListener('touchend', () => el.classList.remove('touch-active'));
                });
            }

            function setupEventListeners() {
                loginBtn.addEventListener('click', handleLogin);
                sendTintBtn.addEventListener('click', sendTintOrder);
                cancelTintBtn.addEventListener('click', () => closeModal('paint-order-modal'));
                closeTintModalBtn.addEventListener('click', () => closeModal('paint-order-modal'));

                const paintOrderModal = document.getElementById('paint-order-modal');
                paintOrderModal.addEventListener('click', (e) => {
                    if (e.target === paintOrderModal) { closeModal('paint-order-modal'); }
                });

                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (e.currentTarget.dataset.action === 'new-order') {
                            switchPage('order-wizard-page');
                            goToOrderStep(1);
                        }
                    });
                });
                document.querySelectorAll('.brand-filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.brand-filter-btn').forEach(b => {
                            b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                            b.classList.add('border-slate-300', 'dark:border-slate-600');
                        });
                        e.currentTarget.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                        e.currentTarget.classList.remove('border-slate-300', 'dark:border-slate-600');
                        renderColorSwatches(e.currentTarget.dataset.brand);
                    });
                });
                fileUploadInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) { fileNameDisplay.textContent = `קובץ שנבחר: ${file.name}`; console.log('File selected:', file); } 
                    else { fileNameDisplay.textContent = ''; }
                });
            }
            
            function setupThemeToggle() {
                 themeToggleBtn.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                });
            }
            
            // Initial Setup
            applySavedTheme();
            setupThemeToggle();
            setupNavigation();
            setupEventListeners();
            setupInteractiveShine();
            switchPage('login-page');
            document.querySelector('.nav-btn[data-page="home-page"]').classList.add('active');
        });
    </script>
</body>
</html>

