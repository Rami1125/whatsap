<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת CRM מתקדמת לניהול שכירות מכולות</title>
    
    <!-- Chosen Palette: Calm Neutral Harmony (Green, Blue, White) -->
    <!-- Application Structure Plan: The application retains the highly effective three-section structure: Dashboard, Container Inventory, and Treatment Board. Now with an added Reports section. This structure provides a clear user flow, starting with a high-level overview (Dashboard), allowing for detailed asset management (Inventory), focusing on actionable items (Treatment Board), and offering analytical insights (Reports). The main interactions involve filtering the central data table from KPI cards and charts, managing orders through modals, and using a drag-and-drop Kanban board for workflow. This task-oriented design was chosen because it aligns perfectly with the typical workflow of a rental manager, prioritizing clarity, efficiency, and quick access to critical information. -->
    <!-- Visualization & Content Choices: 
        - Dashboard KPIs: Goal: Inform. Method: Styled HTML cards. Interaction: Click to filter main table. Justification: Provides a quick, scannable summary of key business metrics.
        - Charts: Goal: Compare/Show Proportions/Trend. Method: Bar/Doughnut Charts (Chart.js on Canvas). Interaction: Click to filter table. Justification: Effective for visualizing distributions and comparisons.
        - Main Orders Table: Goal: Organize/Inform. Method: Interactive HTML Table. Interaction: Sort, search, filter, click row for details modal. Justification: Standard and effective method for displaying detailed tabular data.
        - Treatment Board: Goal: Organize/Manage Workflow. Method: HTML/CSS Kanban Board. Interaction: Drag-and-drop cards to update status. Justification: Highly intuitive and visual method for managing tasks and their lifecycle.
        - Reports Page: Goal: Analyze/Summarize. Method: Dynamic tables and interactive charts with date filtering. Justification: Provides deep insights into historical data.
    -->
    <!-- CONFIRMATION: NO SVG graphics used directly in HTML outside icons. NO Mermaid JS used. -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Global Variables for a Green, Blue, and White Palette */
        :root {
            --color-background: #E6F0E6; /* Light green-white */
            --color-surface: #FFFFFF;
            --color-primary: #2E8B57; /* Sea Green */
            --color-primary-light: #4CAF50; /* Brighter Green */
            --color-secondary: #A8D8B9; /* Lighter Green */
            --color-accent: #2196F3; /* Bright Blue for accent */
            --color-text-base: #2F4F4F; /* Dark Slate Gray */
            --color-text-muted: #607D8B; /* Blue-Grey */
            --color-border: #CFD8DC; /* Light Blue-Grey */
            --color-danger: #D64545; /* Red (for errors/overdue) */
            --color-warning: #FFC107; /* Amber (for warnings) */
            --color-success: #4CAF50; /* Green (for success) */
            --color-info: #2196F3; /* Blue (for info) */

            --font-main: 'Rubik', sans-serif;
        }

        /* Dark Mode adjustments */
        body.dark {
            --color-background: #1A3E4A; /* Darker blue-green */
            --color-surface: #294F5E; /* Darker blue-green surface */
            --color-primary: #5AB27F; /* Lighter sea green for dark mode */
            --color-primary-light: #7ED093;
            --color-secondary: #4A7A89;
            --color-accent: #64B5F6; /* Lighter blue */
            --color-text-base: #E0F2F7; /* Light text */
            --color-text-muted: #9BB8C5;
            --color-border: #3A6B7C;
            --color-danger: #F44336;
            --color-warning: #FFD54F;
            --color-success: #66BB6A;
            --color-info: #42A5F5;
        }

        /* General body styling */
        body {
            font-family: var(--font-main);
            background-color: var(--color-background);
            color: var(--color-text-base);
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
            line-height: 1.6;
        }
        
        /* Eco-friendly background elements (emojis for flair) */
        .eco-background-header {
            text-align: center;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        .eco-background-header span {
            font-size: 2.5rem; /* Larger emojis */
            margin: 0 0.5rem;
            display: inline-block;
            animation: float 6s ease-in-out infinite; /* Subtle floating animation */
        }
        .eco-background-header span:nth-child(2) { animation-delay: 1s; }
        .eco-background-header span:nth-child(3) { animation-delay: 2s; }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        /* Button styling */
        .btn {
            padding: 0.85rem 1.8rem;
            border-radius: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: 1px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            background-image: linear-gradient(to right, var(--color-primary), var(--color-primary-light));
            box-shadow: 0 6px 20px -5px rgba(46, 139, 87, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px -8px rgba(46, 139, 87, 0.6);
            background-image: linear-gradient(to left, var(--color-primary), var(--color-primary-light));
        }

        .btn-secondary {
            background-color: var(--color-surface);
            color: var(--color-text-base);
            border-color: var(--color-border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }
        body.dark .btn-secondary {
             color: var(--color-text-base);
        }
        .btn-secondary:hover {
            background-color: var(--color-background);
            border-color: var(--color-primary-light);
            color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
        }
        
        /* Card styling */
        .card {
            background-color: var(--color-surface);
            border-radius: 1.25rem;
            border: 1px solid var(--color-border);
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        /* Navigation tabs styling */
        .nav-tab-btn {
            font-size: 1.05rem;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: var(--color-text-muted);
            transition: all 0.3s ease;
        }
        .nav-tab-btn.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
            font-weight: 600;
            transform: translateY(-2px);
        }
        .nav-tab-btn:hover:not(.active) {
            color: var(--color-primary);
            background-color: var(--color-border);
        }
        
        /* Modal styling */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 1.5rem;
            box-shadow: 0 15px 45px rgba(0,0,0,0.25);
            border: 1px solid var(--color-border);
            transform: scale(0.9);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Input, Select, Textarea styling */
        input, select, textarea {
            background-color: var(--color-background);
            border-color: var(--color-border);
            border-radius: 0.8rem;
            transition: all 0.25s ease;
            padding: 0.75rem 1rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(46, 139, 87, 0.25);
            background-color: var(--color-surface);
        }
        
        /* Table styling */
        th {
            background-color: var(--color-background);
            font-weight: 600;
            padding: 1rem;
            text-align: right;
        }
        td {
            padding: 0.9rem;
        }
        
        tr:hover:not(.no-hover) {
            background-color: var(--color-border);
        }
        body.dark tr:hover:not(.no-hover) {
            background-color: var(--color-surface);
        }
        
        /* Status indicators */
        .status-open { color: var(--color-success); font-weight: 700; }
        .status-closed { color: var(--color-text-muted); }
        .status-overdue { color: var(--color-danger); font-weight: 700; }
        .status-pending { color: var(--color-info); font-weight: 700; }
        .status-warning { color: var(--color-warning); font-weight: 700; }
        
        /* Action type specific styling */
        .action-type-הורדה { background-color: rgba(76, 175, 80, 0.1); } /* Light green */
        body.dark .action-type-הורדה { background-color: rgba(102, 187, 106, 0.1); }
        .action-type-החלפה { background-color: rgba(255, 193, 7, 0.1); } /* Light yellow/gold */
        body.dark .action-type-החלפה { background-color: rgba(255, 215, 80, 0.1); }
        .action-type-העלאה { background-color: rgba(214, 69, 69, 0.1); } /* Light red */
        body.dark .action-type-העלאה { background-color: rgba(244, 67, 54, 0.1); }

        /* Overdue blinking effect (full row) */
        .overdue-blinking {
            animation: pulse-border 1.8s infinite alternate;
        }
        @keyframes pulse-border {
            from { box-shadow: 0 0 0 0 rgba(214, 69, 69, 0.4); }
            to { box-shadow: 0 0 0 6px rgba(214, 69, 69, 0.0); }
        }

        /* Overdue blinking effect (text) */
        .overdue-text-blinking {
            animation: text-pulse-red 1.8s infinite alternate;
            font-weight: 700;
        }
        @keyframes text-pulse-red {
            from { color: var(--color-danger); text-shadow: 0 0 4px rgba(214, 69, 69, 0.4); }
            to { color: #FF0000; text-shadow: 0 0 8px rgba(255, 0, 0, 0.8); }
        }


        /* Chart container */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }

        /* Action icon buttons */
        .action-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            padding: 0.4rem;
            margin: 0 0.2rem;
            transition: transform 0.25s ease-in-out, color 0.25s ease-in-out;
            border-radius: 50%;
        }
        .action-icon-btn:hover {
            transform: scale(1.3);
            background-color: rgba(0,0,0,0.05);
        }
        body.dark .action-icon-btn:hover {
            background-color: rgba(255,255,255,0.08);
        }
        
        /* Typing effect for message input */
        .typing-effect::after {
            content: '|';
            animation: blink-caret 0.75s step-end infinite;
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--color-primary); }
        }

        /* Scroll to top button */
        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--color-primary);
            color: white;
            cursor: pointer;
            padding: 18px;
            border-radius: 50%;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transition: background-color 0.3s, opacity 0.3s, transform 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: var(--color-primary-light);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* Loader styling */
        #loader-overlay {
            transition: opacity 0.3s ease;
        }
        #loader-overlay > div {
            border-top-color: var(--color-primary);
        }

        /* Kanban column title blinking effect */
        .neon-blinking-border-title {
            animation: neon-pulse-strong 1.8s infinite alternate;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.6), 0 0 20px rgba(255, 0, 0, 0.4);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 1rem;
            padding: 1rem;
            background-color: rgba(255, 0, 0, 0.05);
            color: #FF0000;
        }

        @keyframes neon-pulse-strong {
            0% {
                box-shadow: 0 0 5px rgba(255, 0, 0, 0.4), 0 0 15px rgba(255, 0, 0, 0.2);
                border-color: rgba(255, 0, 0, 0.3);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.6);
                border-color: rgba(255, 0, 0, 0.8);
            }
        }
        /* Kanban item styling */
        .kanban-item {
            font-weight: 500;
        }
        .kanban-item .font-bold {
            font-weight: 700;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                box-sizing: border-box;
                font-family: 'Rubik', sans-serif;
                color: black; /* Ensure black text on print */
            }
            #print-area img {
                max-width: 150px;
                margin-bottom: 20px;
            }
            #print-area h1 {
                font-size: 24px;
                color: #2F4F4F;
                margin-bottom: 20px;
            }
            #print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            #print-area th, #print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: right;
            }
            #print-area th {
                background-color: #f2f2f2;
            }
        }

        /* Mobile specific adjustments (example for responsiveness) */
        @media (max-width: 768px) {
            .nav-tab-btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.8rem;
            }
            .btn {
                padding: 0.7rem 1.4rem;
                font-size: 0.95rem;
            }
            .modal-content {
                border-radius: 1rem;
                padding: 1rem;
            }
            .table-auto th, .table-auto td {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            /* Adjust table layout for small screens if too many columns */
            #orders-table thead, #orders-table tbody, #orders-table th, #orders-table td, #orders-table tr { 
                display: block; 
            }
            #orders-table thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            #orders-table tr { 
                border: 1px solid var(--color-border);
                margin-bottom: 0.5rem;
                border-radius: 0.75rem;
                padding: 0.75rem;
            }
            #orders-table td { 
                border: none;
                position: relative;
                padding-left: 50%; 
                text-align: left;
            }
            #orders-table td:before { 
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%; 
                padding-right: 10px; 
                white-space: nowrap;
                content: attr(data-label);
                font-weight: 600;
                color: var(--color-text-muted);
            }
            /* Specific labels for mobile table columns */
            #orders-table td:nth-of-type(1):before { content: "תאריך"; }
            #orders-table td:nth-of-type(2):before { content: "תעודה"; }
            #orders-table td:nth-of-type(3):before { content: "לקוח"; }
            #orders-table td:nth-of-type(4):before { content: "כתובת"; }
            #orders-table td:nth-of-type(5):before { content: "סוג פעולה"; }
            #orders-table td:nth-of-type(6):before { content: "ימים שעברו"; }
            #orders-table td:nth-of-type(7):before { content: "מכולות"; }
            #orders-table td:nth-of-type(8):before { content: "סטטוס"; }
            #orders-table td:nth-of-type(9):before { content: "פעולות"; }
            
            .kanban-item {
                font-size: 0.9rem;
                padding: 0.8rem;
            }
            .kanban-item .action-icon-btn {
                font-size: 1.2rem;
                padding: 0.2rem;
            }
        }
        /* New styles for customer profile modal to prevent stretching */
        .profile-card-container {
            max-height: 40vh; /* Set a max height for the cards container */
            overflow-y: auto; /* Enable vertical scrolling */
            -webkit-overflow-scrolling: touch;
        }
        .customer-profile-chart-container {
            height: 300px;
            max-height: 300px;
        }
        .customer-profile-orders-container {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Fix for scrollable table headers */
        .customer-profile-orders-container table thead {
            position: sticky;
            top: 0;
            background-color: var(--color-background);
            z-index: 10;
        }
        
    </style>
</head>
<body class="text-base">

    <!-- Loader Overlay -->
    <div id="loader-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-[1000] opacity-0 pointer-events-none">
        <div class="w-20 h-20 border-6 border-t-6 border-gray-200 border-t-[var(--color-primary)] rounded-full animate-spin"></div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="fixed bottom-6 left-6 z-[1100] space-y-4"></div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-[var(--color-primary)]">הוסף הזמנה חדשה</h2>
                <button onclick="closeModal('order-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <form id="order-form" class="space-y-5 overflow-y-auto">
                 <div>
                    <label for="תאריך הזמנה" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">תאריך הזמנה</label>
                    <input type="date" id="תאריך הזמנה" name="תאריך הזמנה" class="w-full p-2 border" required>
                </div>
                <div>
                    <label for="תעודה" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">תעודה</label>
                    <input type="text" id="תעודה" name="תעודה" class="w-full p-2 border" required>
                </div>
                <div>
                    <label for="שם סוכן" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">שם סוכן</label>
                    <input type="text" id="שם סוכן" name="שם סוכן" class="w-full p-2 border" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="שם לקוח" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">שם לקוח</label>
                        <input type="text" id="שם לקוח" name="שם לקוח" class="w-full p-2 border" required onblur="checkCustomerExistenceAndAutofill()">
                    </div>
                    <div>
                        <label for="כתובת" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">כתובת</label>
                        <input type="text" id="כתובת" name="כתובת" class="w-full p-2 border" required onblur="checkCustomerExistenceAndAutofill()">
                    </div>
                </div>
                <div>
                    <label for="טלפון לקוח" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">טלפון לקוח</label>
                    <input type="tel" id="טלפון לקוח" name="טלפון לקוח" class="w-full p-2 border" onblur="checkCustomerExistenceAndAutofill()">
                </div>
                <div>
                    <label for="סוג פעולה" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">סוג פעולה</label>
                    <select id="סוג פעולה" name="סוג פעולה" class="w-full p-2 border" required onchange="handleActionTypeChange()">
                        <option value="הורדה">הורדה</option>
                        <option value="העלאה">העלאה</option>
                        <option value="החלפה">החלפה</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="container-taken-div">
                        <label for="מספר מכולה ירדה" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">מספר מכולה ירדה</label>
                        <input type="text" id="מספר מכולה ירדה" name="מספר מכולה ירדה" class="w-full p-2 border">
                    </div>
                    <div id="container-brought-div" class="hidden">
                        <label for="מספר מכולה עלתה" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">מספר מכולה עלתה</label>
                        <input type="text" id="מספר מכולה עלתה" name="מספר מכולה עלתה" class="w-full p-2 border">
                    </div>
                </div>
                <div>
                    <label for="תאריך סיום צפוי" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">תאריך סיום צפוי</label>
                    <input type="date" id="תאריך סיום צפוי" name="תאריך סיום צפוי" class="w-full p-2 border">
                </div>
                <div>
                    <label for="הערות" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">הערות</label>
                    <textarea id="הערות" name="הערות" rows="3" class="w-full p-2 border"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-[var(--color-border)]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('order-modal')">ביטול</button>
                    <button type="submit" class="btn btn-primary">שמור הזמנה</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">אישור מחיקה</h2>
            <p class="mb-6 text-[var(--color-text-muted)]">האם אתה בטוח שברצונך למחוק את הזמנה מספר <span id="delete-order-id" class="font-bold"></span>? פעולה זו אינה הפיכה.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeModal('delete-confirm-modal')">ביטול</button>
                <button type="button" class="btn bg-[var(--color-danger)] text-white" id="confirm-delete-btn">מחק</button>
            </div>
        </div>
    </div>

    <!-- Autofill Confirmation Modal -->
    <div id="autofill-confirm-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 id="autofill-customer-name-display" class="text-xl font-bold mb-4 text-[var(--color-primary)]"></h2>
            <p id="autofill-message" class="mb-6 text-[var(--color-text-muted)]"></p>
            <div class="flex justify-center gap-4">
                <button type="button" class="btn btn-primary" onclick="confirmAutofill(true)">כן ✅</button>
                <button type="button" class="btn btn-secondary" onclick="confirmAutofill(false)">לא ❌</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">פרטי הזמנה <span id="details-order-id"></span></h2>
                <button onclick="closeModal('order-details-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div id="order-details-content" class="space-y-3 overflow-y-auto text-[var(--color-text-base)] text-lg">
                <!-- Details will be populated here -->
            </div>
            <div class="flex justify-between items-center p-5 border-t border-[var(--color-border)] mt-4">
                <!-- New Share and Print Buttons -->
                <div class="flex gap-3">
                    <button type="button" class="btn btn-primary" onclick="shareOrderDetailsOnWhatsApp()" title="שתף בוואטסאפ">
                        <i class="fab fa-whatsapp"></i> שתף
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="printOrderDetails()" title="הדפס כרטיס לקוח">
                        <i class="fas fa-print"></i> הדפס
                    </button>
                </div>
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary" onclick="editOrderFromDetails()">ערוך 📝</button>
                    <button type="button" class="btn bg-[var(--color-danger)] text-white" onclick="deleteOrderFromDetails()">מחק 🗑️</button>
                    <button type="button" class="btn btn-primary" onclick="duplicateOrderFromDetails()">שכפל 📋</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container History Modal -->
    <div id="container-history-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-3xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">היסטוריית מכולה: <span id="history-container-number"></span></h2>
                <button onclick="closeModal('container-history-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr>
                            <th class="p-3">תעודה</th>
                            <th class="p-3">שם לקוח</th>
                            <th class="p-3">כתובת</th>
                            <th class="p-3">סוג פעולה</th>
                            <th class="p-3">תאריך התחלה</th>
                            <th class="p-3">תאריך סיום (צפוי/בפועל)</th>
                            <th class="p-3">משך שהייה (ימים)</th>
                        </tr>
                    </thead>
                    <tbody id="container-history-table-body">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
                <div id="no-container-history" class="text-center text-gray-500 mt-6 hidden text-lg">אין היסטוריה זמינה למכולה זו.</div>
            </div>
        </div>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">היסטוריית הזמנות ללקוח: <span id="history-customer-name"></span></h2>
                <button onclick="closeModal('customer-history-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr>
                            <th class="p-3">תאריך הזמנה</th>
                            <th class="p-3">תעודה</th>
                            <th class="p-3">סוג פעולה</th>
                            <th class="p-3">מכולה ירדה</th>
                            <th class="p-3">מכולה עלתה</th>
                            <th class="p-3">סטטוס</th>
                            <th class="p-3">הערות</th>
                        </tr>
                    </thead>
                    <tbody id="customer-history-table-body">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
                <div id="no-customer-history" class="text-center text-gray-500 mt-6 hidden text-lg">אין היסטוריה זמינה ללקוח זה.</div>
            </div>
            <!-- New Share and Print Buttons -->
            <div class="flex justify-center gap-3 p-5 border-t border-[var(--color-border)] mt-4">
                <button type="button" class="btn btn-primary" onclick="shareCustomerHistoryOnWhatsApp()" title="שתף היסטוריית לקוח בוואטסאפ">
                    <i class="fab fa-whatsapp"></i> שתף
                </button>
                <button type="button" class="btn btn-secondary" onclick="printCustomerHistory()" title="הדפס היסטוריית לקוח">
                    <i class="fas fa-print"></i> הדפס
                </button>
            </div>
        </div>
    </div>

    <!-- Close Order Modal -->
    <div id="close-order-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">סגירת הזמנה <span id="close-order-id-display"></span></h2>
            <p class="mb-4 text-[var(--color-text-muted)]">האם אתה בטוח שברצונך לסגור הזמנה זו?</p>
            <div>
                <label for="close-order-notes" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">הערות סגירה (אופציונלי)</label>
                <textarea id="close-order-notes" rows="3" class="w-full p-2 border rounded-lg"></textarea>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" class="btn btn-secondary" onclick="closeModal('close-order-modal')">ביטול</button>
                <button type="button" class="btn btn-primary" id="confirm-close-order-btn">אשר סגירה ✅</button>
            </div>
        </div>
    </div>
    
    <!-- Main Page Structure -->
    <div class="min-h-screen flex flex-col">
        <header class="p-6 text-center border-b border-[var(--color-border)] bg-white shadow-sm relative">
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-2">
                <!-- Company Logo -->
                <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="Company Logo" class="h-16 rounded-lg shadow-md border border-[var(--color-border)]">
                <h1 class="text-3xl md:text-4xl font-bold text-[var(--color-primary)] mt-2 md:mt-0">מערכת CRM מתקדמת לניהול שכירות מכולות</h1>
            </div>
            <p class="text-lg text-[var(--color-text-muted)] mb-4">ניהול קל ויעיל של כל הזמנות המכולות</p>
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="absolute top-5 left-5 text-2xl p-3 rounded-full hover:bg-[var(--color-border)] transition-colors duration-300">
                <i class="fas fa-sun"></i>
            </button>
        </header>

        <!-- Main Navigation Tabs -->
        <div class="flex justify-center p-4">
            <nav class="card flex gap-3 p-3 shadow-lg flex-wrap justify-center">
                <button id="nav-dashboard" class="nav-tab-btn active" onclick="showPage('dashboard')">
                    <i class="fas fa-chart-pie mr-2"></i>לוח מחוונים
                </button>
                <button id="nav-container-inventory" class="nav-tab-btn" onclick="showPage('container-inventory')">
                    <i class="fas fa-boxes-stacked mr-2"></i>מלאי מכולות
                </button>
                <button id="nav-treatment-board" class="nav-tab-btn" onclick="showPage('treatment-board')">
                    <i class="fas fa-clipboard-list mr-2"></i>לוח טיפול
                </button>
                <button id="nav-whatsapp-alerts" class="nav-tab-btn" onclick="showPage('whatsapp-alerts')">
                    <i class="fab fa-whatsapp mr-2"></i>התראות WhatsApp
                </button>
                <button id="nav-reports" class="nav-tab-btn" onclick="showPage('reports')">
                    <i class="fas fa-chart-line mr-2"></i>דוחות
                </button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page-content space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">סקירה כללית 📊</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">כאן ניתן לראות את הנתונים המרכזיים של המערכת, לנהל הזמנות קיימות וליצור חדשות.</p>
                    <div class="eco-background-header">
                        <span>🌱</span>
                        <span>🌍</span>
                        <span>🌳</span>
                    </div>
                </div>
                <!-- Quick Action Buttons -->
                <div class="flex flex-col md:flex-row justify-center items-center gap-5 flex-wrap">
                    <button class="btn btn-primary" onclick="openOrderModal('add')">
                        <i class="fas fa-plus"></i> הוסף הזמנה חדשה
                    </button>
                    <button class="btn bg-[var(--color-danger)] text-white hover:bg-[var(--color-danger)] hover:opacity-90" onclick="filterTable('חורג', null, true); scrollToOrdersTable();">
                        <i class="fas fa-triangle-exclamation"></i> הצג הזמנות חורגות
                        <span id="overdue-customers-badge" class="ml-2 bg-white text-[var(--color-danger)] px-3 py-1 rounded-full text-sm font-bold shadow-sm">0</span>
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> רענן נתונים
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable('פתוח', null, true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">הזמנות פתוחות<p id="open-orders-count" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-box-open text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable('חורג', null, true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">הזמנות חורגות<p id="overdue-orders-count" class="text-4xl font-bold text-[var(--color-danger)] mt-2">0</p></div><i class="fas fa-triangle-exclamation text-4xl text-[var(--color-danger)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, 'מכולה בשימוש', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">מכולות בשימוש<p id="containers-in-use" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-truck-moving text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, 'לקוח פעיל', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">לקוחות פעילים<p id="active-customers-count" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-users text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                </div>

                <!-- Action Type Buttons Row -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, 'הורדה', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">הורדה<p id="action-type-הורדה-count" class="text-4xl font-bold text-[var(--color-success)] mt-2">0</p></div><i class="fas fa-download text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, 'החלפה', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">החלפה<p id="action-type-החלפה-count" class="text-4xl font-bold text-[var(--color-warning)] mt-2">0</p></div><i class="fas fa-exchange-alt text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, 'העלאה', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">העלאה<p id="action-type-העלאה-count" class="text-4xl font-bold text-[var(--color-danger)] mt-2">0</p></div><i class="fas fa-upload text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">מכולות בשימוש לפי לקוח</h3>
                        <div class="chart-container">
                            <canvas id="chart-containers-by-customer"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">התפלגות הזמנות לפי סטטוס</h3>
                        <div class="chart-container">
                            <canvas id="chart-status-pie"></canvas>
                        </div>
                    </div>
                    <!-- New Action Type Chart -->
                    <div class="card p-6 lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">התפלגות הזמנות לפי סוג פעולה</h3>
                        <div class="chart-container">
                            <canvas id="chart-action-type"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Main Orders List -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-[var(--color-text-base)]">רשימת הזמנות 📋</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
                        <input type="text" id="search-input" placeholder="חיפוש חופשי (תעודה, לקוח, כתובת, מכולה)..." class="flex-grow p-3 border text-lg" onkeyup="filterTable()">
                        
                        <!-- New Filters -->
                        <select id="filter-status-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">כל הסטטוסים</option>
                            <option value="פתוח">פתוח</option>
                            <option value="חורג">חורג</option>
                            <option value="סגור">סגור</option>
                        </select>
                        <select id="filter-action-type-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">כל סוגי הפעולות</option>
                            <option value="הורדה">הורדה</option>
                            <option value="החלפה">החלפה</option>
                            <option value="העלאה">העלאה</option>
                        </select>
                        <select id="filter-agent-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">כל הסוכנים</option>
                            <!-- Agents will be populated by JS -->
                        </select>
                        <button class="btn btn-secondary" onclick="resetTableFilters()">
                            <i class="fas fa-filter-circle-xmark mr-2"></i>איפוס סינון
                        </button>
                        <div class="flex items-center gap-2">
                            <label for="show-closed-orders" class="text-sm font-medium text-[var(--color-text-muted)]">הצג סגורות</label>
                            <input type="checkbox" id="show-closed-orders" onchange="filterTable()" class="w-5 h-5 text-[var(--color-primary)] bg-gray-100 rounded border-gray-300 focus:ring-[var(--color-primary)]">
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-[var(--color-border)]">
                        <table id="orders-table" class="w-full text-right table-auto">
                            <thead class="bg-[var(--color-background)] border-b-2 border-[var(--color-border)] sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">תאריך</th>
                                    <th class="p-3">תעודה</th>
                                    <th class="p-3">לקוח</th>
                                    <th class="p-3">כתובת</th>
                                    <th class="p-3">סוג פעולה</th>
                                    <th class="p-3">ימים שעברו</th>
                                    <th class="p-3">מכולות</th>
                                    <th class="p-3">סטטוס</th>
                                    <th class="p-3">פעולות</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Container Inventory Page -->
            <section id="container-inventory-page" class="page-content hidden space-y-10">
                 <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">ניהול מלאי מכולות 📦</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">עקוב אחר המיקום והזמינות של כל המכולות במערכת.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-[var(--color-danger)]">מכולות בשימוש</h3>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-[var(--color-border)]">
                            <table id="containers-in-use-table" class="w-full text-right table-auto">
                                <thead class="bg-[var(--color-background)] sticky top-0 z-10"><tr><th class="p-3">מספר</th><th class="p-3">לקוח</th><th class="p-3">תאריך</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-[var(--color-success)]">מכולות פנויות</h3>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-[var(--color-border)]">
                            <table id="containers-available-table" class="w-full text-right table-auto">
                                <thead class="bg-[var(--color-background)] sticky top-0 z-10"><tr><th class="p-3">מספר</th><th class="p-3">תאריך התפנות</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Treatment Board Page -->
            <section id="treatment-board-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">לוח טיפול Kanban 🛠️</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">נהל את ההזמנות הדורשות טיפול באמצעות גרירה ושחרור בין הסטטוסים השונים.</p>
                </div>
                <div id="no-treatment-orders" class="text-center text-xl text-[var(--color-text-muted)] hidden p-8 card">אין הזמנות לטיפול כרגע. כל הכבוד! 🎉</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="column-overdue" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-danger)] mb-4 pb-2 border-b border-[var(--color-border)] neon-blinking-border-title">לקוחות חורגים שצריכים טיפול 🚨</h3>
                    </div>
                    <div id="column-in-progress" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-info)] mb-4 pb-2 border-b border-[var(--color-border)]">בטיפול ⚙️</h3>
                    </div>
                    <div id="column-resolved" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-success)] mb-4 pb-2 border-b border-[var(--color-border)]">טופלו ✅</h3>
                    </div>
                </div>
            </section>

            <!-- WhatsApp Alerts Page -->
            <section id="whatsapp-alerts-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">לוח התראות WhatsApp 💬</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">שלח הודעות מובנות ללקוחות על חריגות, סטטוס הזמנות והודעות חשובות נוספות.</p>
                </div>

                <div class="card p-8 space-y-5 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold mb-4 text-[var(--color-primary)]">שליחת הודעת WhatsApp</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="whatsapp-customer-name" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">שם לקוח</label>
                            <input type="text" id="whatsapp-customer-name" class="w-full p-2 border" readonly>
                        </div>
                        <div>
                            <label for="whatsapp-phone-number" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">מספר טלפון</label>
                            <input type="text" id="whatsapp-phone-number" class="w-full p-2 border" readonly>
                        </div>
                        <div class="md:col-span-2"> <!-- Single column for address -->
                            <label for="whatsapp-address" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">כתובת</label>
                            <input type="text" id="whatsapp-address" class="w-full p-2 border" readonly>
                        </div>
                    </div>

                    <div>
                        <label for="message-template-select" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">בחר תבנית הודעה</label>
                        <select id="message-template-select" class="w-full p-3 border text-lg" onchange="loadWhatsAppTemplate()">
                            <option value="">בחר תבנית...</option>
                            <!-- Templates will be populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="whatsapp-message-input" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">הודעה</label>
                        <textarea id="whatsapp-message-input" rows="8" class="w-full p-3 border text-lg typing-effect"></textarea>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button class="btn btn-secondary" onclick="clearWhatsAppMessage()">נקה</button>
                        <button class="btn btn-primary" onclick="sendWhatsAppMessage()">שלח הודעה</button>
                    </div>
                </div>
            </section>

            <!-- Reports Page -->
            <section id="reports-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">דוחות וניתוח נתונים 📊</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">נתח את פעילות המכולות ובחן סיכומים תקופתיים.</p>
                </div>

                <div class="card p-6 space-y-6">
                    <h3 class="text-2xl font-bold text-[var(--color-primary)] mb-4">סינון דוחות לפי תאריכים</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">תאריך התחלה</label>
                            <input type="date" id="report-start-date" class="w-full p-3 border text-lg" onchange="filterReports()">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">תאריך סיום</label>
                            <input type="date" id="report-end-date" class="w-full p-3 border text-lg" onchange="filterReports()">
                        </div>
                        <button class="btn btn-secondary w-full" onclick="resetReportFilters()">
                            <i class="fas fa-filter-circle-xmark mr-2"></i>איפוס פילטרים
                        </button>
                    </div>

                    <div id="report-summaries" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6">
                        <div class="p-4 bg-[var(--color-background)] rounded-lg text-center shadow-inner">
                            <p class="text-sm text-[var(--color-text-muted)]">סה"כ הורדות 📦⬇️</p>
                            <p id="summary-downloads" class="text-3xl font-bold text-[var(--color-success)] mt-1">0</p>
                        </div>
                        <div class="p-4 bg-[var(--color-background)] rounded-lg text-center shadow-inner">
                            <p class="text-sm text-[var(--color-text-muted)]">סה"כ החלפות 🔄</p>
                            <p id="summary-exchanges" class="text-3xl font-bold text-[var(--color-warning)] mt-1">0</p>
                        </div>
                        <div class="p-4 bg-[var(--color-background)] rounded-lg text-center shadow-inner">
                            <p id="summary-uploads" class="text-3xl font-bold text-[var(--color-danger)] mt-1">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">פעולות לפי חודש</h3>
                            <div class="chart-container">
                                <canvas id="chart-reports-monthly-actions"></canvas>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">התפלגות פעולות כוללת</h3>
                            <div class="chart-container">
                                <canvas id="chart-reports-action-distribution"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-[var(--color-primary)] mb-4">הזמנות בטווח התאריכים הנבחר</h3>
                    <div class="overflow-x-auto rounded-lg border border-[var(--color-border)]">
                        <table id="reports-orders-table" class="w-full text-right table-auto">
                            <thead class="bg-[var(--color-background)] border-b-2 border-[var(--color-border)] sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">תאריך</th>
                                    <th class="p-3">תעודה</th>
                                    <th class="p-3">לקוח</th>
                                    <th class="p-3">סוג פעולה</th>
                                    <th class="p-3">מכולות</th>
                                    <th class="p-3">סטטוס</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="reports-load-more-container" class="text-center mt-4 hidden">
                        <button class="btn btn-secondary" onclick="loadMoreReportOrders()">טען עוד...</button>
                    </div>
                    <div id="no-report-orders" class="text-center text-gray-500 mt-6 hidden text-lg">אין הזמנות בטווח התאריכים הנבחר.</div>
                </div>

                <div class="flex justify-center gap-3 mt-6">
                    <button class="btn btn-primary" onclick="sendReportsByEmail()">
                        <i class="fas fa-envelope"></i> שלח דוח במייל
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Floating Scroll to Top Button -->
    <button onclick="scrollToTop()" id="scroll-to-top-btn" title="חזור למעלה">
        <i class="fas fa-arrow-up"></i>
    </button>
<!-- Customer Profile Modal -->
<div id="customer-profile-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col p-6">
        <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
            <h2 id="profile-customer-name" class="text-2xl font-bold text-[var(--color-primary)]">פרופיל לקוח</h2>
            <button onclick="closeModal('customer-profile-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
        </div>
        <div class="overflow-y-auto">
            <div id="customer-profile-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Profile content will be dynamically generated here -->
            </div>
            <h3 class="text-xl font-bold text-[var(--color-text-base)] mt-8 mb-4">היסטוריית הזמנות</h3>
            <div class="overflow-x-auto rounded-lg border border-[var(--color-border)] customer-profile-orders-container">
                <table id="customer-profile-orders-table" class="w-full text-right table-auto">
                    <thead>
                        <tr>
                            <th class="p-3">תאריך</th>
                            <th class="p-3">תעודה</th>
                            <th class="p-3">סוג פעולה</th>
                            <th class="p-3">סטטוס</th>
                            <th class="p-3">ימים</th>
                            <th class="p-3">פעולות</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // URL of your Google Apps Script acting as the API
    const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
    // URL of a separate Apps Script for WhatsApp message logging (REPLACE WITH YOUR ACTUAL SCRIPT ID)
    const WHATSAPP_LOG_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_YOUR_WHATSAPP_SCRIPT_ID_HERE/exec'; 
    // URL of a separate Apps Script for sending emails (REPLACE WITH YOUR ACTUAL SCRIPT ID)
    const EMAIL_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_YOUR_EMAIL_SCRIPT_ID_HERE/exec';

    let allOrders = []; // Array containing all loaded orders
    let currentEditingOrder = null; // Variable for the order currently being edited
    let autoFillData = null; // Data for customer autofill
    let charts = {}; // Object to store Chart.js instances
    const OVERDUE_THRESHOLD_DAYS = 10; // Days after order date to be considered 'overdue'

    // --- Modal Utility Functions ---
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // --- Loader Functions ---
    function showLoader() { document.getElementById('loader-overlay').classList.remove('opacity-0', 'pointer-events-none'); }
    function hideLoader() { document.getElementById('loader-overlay').classList.add('opacity-0', 'pointer-events-none'); }

    // --- Theme Toggle Functions ---
    function toggleTheme() {
        const isDarkMode = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        document.querySelector('#theme-toggle i').className = isDarkMode ? 'fas fa-moon' : 'fas fa-sun';
        drawCharts(); // Redraw dashboard charts to match new theme colors
        if (currentPage === 'reports') { // Redraw report charts if on reports page
            filterReports(); // Re-filter and redraw report charts based on current filter
        }
    }

    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark');
            document.querySelector('#theme-toggle i').className = 'fas fa-moon';
        }
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    }

    // --- Alert Notification Function ---
    function showAlert(message, type = 'info') {
        const container = document.getElementById('alert-container');
        const alertItem = document.createElement('div');
        let bgColor, icon, textColor, borderColor;
        switch(type) {
            case 'success': bgColor = 'bg-green-50'; borderColor = 'border-green-500'; textColor = 'text-green-700'; icon = 'fa-check-circle'; break;
            case 'error': bgColor = 'bg-red-50'; borderColor = 'border-red-500'; textColor = 'text-red-700'; icon = 'fa-times-circle'; break;
            case 'warning': bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-500'; textColor = 'text-yellow-700'; icon = 'fa-exclamation-triangle'; break;
            default: bgColor = 'bg-blue-50'; borderColor = 'border-blue-500'; textColor = 'text-blue-700'; icon = 'fa-info-circle'; break;
        }
        alertItem.className = `p-4 rounded-lg border-l-4 shadow-md flex items-center gap-3 transform translate-x-full opacity-0 transition-all duration-500 ease-out ${bgColor} ${borderColor} ${textColor}`;
        alertItem.innerHTML = `<i class="fas ${icon}"></i><p>${message}</p>`;
        container.prepend(alertItem);
        
        setTimeout(() => {
            alertItem.style.transform = 'translateX(0)';
            alertItem.style.opacity = '1';
        }, 100);

        setTimeout(() => {
            alertItem.style.transform = 'translateX(100%)';
            alertItem.style.opacity = '0';
            setTimeout(() => alertItem.remove(), 500);
        }, 5000);
    }

    // --- API Communication Function (Exponential Backoff) ---
    async function fetchData(action, params = {}, retries = 0) {
        showLoader();
        const urlParams = new URLSearchParams({ action, ...params });
        const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
        console.log(`[fetchData] Request URL: ${url}`);
        try {
            const response = await fetch(url);
            console.log(`[fetchData] Response status: ${response.status}`);
            const data = await response.json();
            console.log(`[fetchData] Response data:`, data);

            if (!response.ok) {
                const errorMessage = data.message || `שגיאת שרת HTTP: ${response.status}`;
                showAlert(errorMessage, 'error');
                console.error("[fetchData] HTTP error:", errorMessage, data);
                return { success: false, message: errorMessage };
            }

            if (!data.success && data.message && data.message.includes('Service invoked too many times')) {
                const delay = Math.pow(2, retries) * 1000;
                if (retries < 5) {
                    console.warn(`[fetchData] Service invoked too many times, retrying in ${delay}ms... (Attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchData(action, params, retries + 1);
                } else {
                    showAlert('השרת עמוס מדי, אנא נסה שוב מאוחר יותר.', 'error');
                    return { success: false, message: 'Service too busy' };
                }
            } else if (!data.success) {
                showAlert(data.message || 'פעולה נכשלה בשרת.', 'error');
                console.error("[fetchData] Server-side operation failed:", data.message, data);
                return data;
            }

            return data;
        } catch (error) {
            showAlert('שגיאת תקשורת: לא ניתן להתחבר לשרת.', 'error');
            console.error("[fetchData] Network or parsing error:", error);
            return { success: false, message: error.message };
        } finally {
            hideLoader();
        }
    }

    // --- WhatsApp Logging and Sending ---
    async function logWhatsAppMessage(docId, message) {
        const url = `${WHATSAPP_LOG_SCRIPT_URL}?action=logMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.success) {
                console.log("[logWhatsAppMessage] WhatsApp message logged successfully.");
            } else {
                console.error("[logWhatsAppMessage] Failed to log WhatsApp message:", data.message);
            }
        } catch (error) {
            console.error("[logWhatsAppMessage] Error logging WhatsApp message:", error);
        }
    }

    function sendWhatsAppMessage() {
        const customerName = document.getElementById('whatsapp-customer-name').value;
        const phoneNumber = document.getElementById('whatsapp-phone-number').value;
        const message = document.getElementById('whatsapp-message-input').value;
        const orderDocId = document.getElementById('details-order-id').textContent;

        if (!phoneNumber) {
            showAlert('אנא בחר לקוח עם מספר טלפון או הזן מספר.', 'warning');
            return;
        }
        if (!message.trim()) {
            showAlert('ההודעה ריקה. אנא כתוב הודעה או בחר תבנית.', 'warning');
            return;
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        showAlert('פותח WhatsApp לשליחת הודעה...', 'info');
        logWhatsAppMessage(orderDocId, message);
    }

    function openWhatsAppAlertsForOrder(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) {
            showAlert('הזמנה לא נמצאה.', 'error');
            return;
        }
        
        showPage('whatsapp-alerts');
        document.getElementById('whatsapp-customer-name').value = order['שם לקוח'] || '';
        document.getElementById('whatsapp-phone-number').value = order['טלפון לקוח'] || '';
        document.getElementById('whatsapp-address').value = order['כתובת'] || '';
        document.getElementById('details-order-id').textContent = order['תעודה'] || '';

        if (order._effectiveStatus === 'חורג') {
            document.getElementById('message-template-select').value = whatsappTemplates.findIndex(t => t.name.includes('חורגת')).toString();
        } else if (order._daysPassedCalculated >= (OVERDUE_THRESHOLD_DAYS - 2) && order._effectiveStatus === 'פתוח') { 
            document.getElementById('message-template-select').value = whatsappTemplates.findIndex(t => t.name.includes('לפני חריגה')).toString();
        } else {
            document.getElementById('message-template-select').value = '';
        }
        loadWhatsAppTemplate();
    }

    // --- Main Data Loading and Processing ---
    async function loadOrders() {
        const response = await fetchData('list', { status: 'all' });
        if (response.success) {
            allOrders = response.data.map(order => {
                const orderDate = new Date(order['תאריך הזמנה']);
                const today = new Date();
                const daysPassed = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                order._daysPassedCalculated = daysPassed;

                if (order['סטטוס'] === 'סגור') {
                    order._effectiveStatus = 'סגור';
                } else if (daysPassed >= OVERDUE_THRESHOLD_DAYS) {
                    order._effectiveStatus = 'חורג';
                } else {
                    order._effectiveStatus = 'פתוח';
                }
                order.sheetRow = parseInt(order.sheetRow);
                order['Kanban Status'] = order['Kanban Status'] || null; 
                return order;
            });
            updateDashboard();
            filterTable();
            updateContainerInventory();
            renderTreatmentBoard();
            populateAgentFilter();
            if (currentPage === 'reports') {
                filterReports(); // Re-filter and display reports if on reports page
            }
        } else {
            showAlert(response.message || 'שגיאה בטעינת הזמנות.', 'error');
        }
    }

    // --- Dashboard Updates ---
    function updateDashboard() {
        const openOrders = allOrders.filter(o => o._effectiveStatus === 'פתוח');
        const overdueOrders = allOrders.filter(o => o._effectiveStatus === 'חורג');
        
        const containersInUse = new Set();
        allOrders.filter(o => o._effectiveStatus !== 'סגור').forEach(order => {
            String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(c => containersInUse.add(c));
            String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(c => containersInUse.delete(c));
        });
        
        const activeCustomers = new Set(allOrders.filter(o => o._effectiveStatus !== 'סגור').map(o => o['שם לקוח']).filter(Boolean));

        document.getElementById('open-orders-count').textContent = openOrders.length;
        document.getElementById('overdue-orders-count').textContent = overdueOrders.length;
        document.getElementById('containers-in-use').textContent = containersInUse.size;
        document.getElementById('active-customers-count').textContent = activeCustomers.size;
        document.getElementById('overdue-customers-badge').textContent = overdueOrders.length;
        
        const actionTypeCounts = allOrders.reduce((acc, order) => {
            const type = order['סוג פעולה'];
            if (type) {
                acc[type] = (acc[type] || 0) + 1;
            }
            return acc;
        }, {});

        document.getElementById('action-type-הורדה-count').textContent = actionTypeCounts['הורדה'] || 0;
        document.getElementById('action-type-החלפה-count').textContent = actionTypeCounts['החלפה'] || 0;
        document.getElementById('action-type-העלאה-count').textContent = actionTypeCounts['העלאה'] || 0;

        drawCharts();
    }

    // --- Order Table Rendering and Filtering ---
    function renderOrdersTable(ordersToRender) {
        const tableBody = document.querySelector('#orders-table tbody');
        tableBody.innerHTML = '';
        if (ordersToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-[var(--color-text-muted)]">אין הזמנות להצגה בסינון הנוכחי.</td></tr>`;
            return;
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            const actionTypeClass = order['סוג פעולה'] ? `action-type-${order['סוג פעולה']}` : '';
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer ${actionTypeClass}`;
            
            if (order._effectiveStatus === 'חורג') {
                row.classList.add('overdue-blinking');
            }

            row.dataset.sheetRow = order.sheetRow;
            row.onclick = (e) => {
                if (!e.target.closest('.action-icon-btn, .container-badge, .customer-name-link')) { 
                    showOrderDetailsModal(order.sheetRow);
                }
            };

            const containersTaken = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer hover:bg-[var(--color-primary)] hover:text-white transition-colors" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')"><i class="fas fa-box"></i> ${c.trim()}</span>`
            ).join(' ');

            const daysPassedHtml = order._effectiveStatus === 'חורג' ?
                `<span class="overdue-text-blinking">${order._daysPassedCalculated || ''}</span>` :
                `${order._daysPassedCalculated || ''}`;

            row.innerHTML = `
                <td class="p-3 font-medium" data-label="תאריך">${formatDate(order['תאריך הזמנה'])}</td>
                <td class="p-3 font-medium" data-label="תעודה">${order['תעודה'] || ''}</td>
                <td class="p-3 font-semibold customer-name-link cursor-pointer hover:text-[var(--color-primary)]" onclick="event.stopPropagation(); showCustomerProfile('${order['שם לקוח']}')" data-label="לקוח">${order['שם לקוח'] || ''}</td>
                <td class="p-3 font-medium" data-label="כתובת">${order['כתובת'] || ''}</td>
                <td class="p-3" data-label="סוג פעולה">${order['סוג פעולה'] || ''}</td>
                <td class="p-3" data-label="ימים שעברו">${daysPassedHtml}</td>
                <td class="p-3" data-label="מכולות">${containerHTML}</td>
                <td class="p-3" data-label="סטטוס"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3 whitespace-nowrap" data-label="פעולות">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="שלח WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="ערוך"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="שכפל"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    ${order._effectiveStatus !== 'סגור' ? `<button class="action-icon-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['תעודה']}')" title="סגור הזמנה"><i class="fas fa-check-circle text-[var(--color-success)]"></i></button>` : ''}
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['תעודה']}')" title="מחק"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </td>
            `;
        });
    }

    function filterTable(statusFilterParam = null, actionTypeFilterParam = null, isExplicitButtonFilter = false) {
        let searchText = document.getElementById('search-input').value.toLowerCase().trim();
        const selectedStatusFilter = document.getElementById('filter-status-select').value;
        const selectedActionTypeFilter = document.getElementById('filter-action-type-select').value;
        const selectedAgentFilter = document.getElementById('filter-agent-select').value;
        let showClosed = document.getElementById('show-closed-orders').checked;

        if (isExplicitButtonFilter) {
            if (statusFilterParam === 'חורג') {
                showClosed = false;
                document.getElementById('show-closed-orders').checked = false;
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = 'חורג';
                document.getElementById('filter-action-type-select').value = 'all';
                document.getElementById('filter-agent-select').value = 'all';
            } else if (actionTypeFilterParam) {
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = 'all';
                document.getElementById('filter-action-type-select').value = actionTypeFilterParam;
                document.getElementById('filter-agent-select').value = 'all';
                showClosed = document.getElementById('show-closed-orders').checked;
            } else if (statusFilterParam === 'פתוח' || actionTypeFilterParam === 'מכולה בשימוש' || actionTypeFilterParam === 'לקוח פעיל') {
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = statusFilterParam || 'all';
                document.getElementById('filter-action-type-select').value = 'all';
                document.getElementById('filter-agent-select').value = 'all';
                showClosed = false;
                document.getElementById('show-closed-orders').checked = false;
            }
        }

        const filtered = allOrders.filter(order => {
            let matchesSearch = true;
            if (searchText) {
                const isNumericSearch = !isNaN(parseFloat(searchText)) && isFinite(searchText);
                if (isNumericSearch) {
                    matchesSearch = String(order['תעודה'] || '').includes(searchText) ||
                                    String(order['מספר מכולה ירדה'] || '').includes(searchText) ||
                                    String(order['מספר מכולה עלתה'] || '').includes(searchText);
                } else {
                    matchesSearch = Object.values(order).some(val => 
                        String(val).toLowerCase().includes(searchText)
                    );
                }
            }
            
            let matchesStatus = true;
            const currentStatusFilter = isExplicitButtonFilter && statusFilterParam ? statusFilterParam : selectedStatusFilter;
            if (currentStatusFilter !== 'all') {
                matchesStatus = (order._effectiveStatus === currentStatusFilter);
            }

            let matchesActionType = true;
            const currentActionTypeFilter = isExplicitButtonFilter && actionTypeFilterParam ? actionTypeFilterParam : selectedActionTypeFilter;
            if (currentActionTypeFilter !== 'all') {
                if (currentActionTypeFilter === 'מכולה בשימוש') {
                    matchesActionType = (String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean).length > 0 && order._effectiveStatus !== 'סגור' && order['סוג פעולה'] !== 'העלאה');
                } else if (currentActionTypeFilter === 'לקוח פעיל') {
                     matchesActionType = (order._effectiveStatus !== 'סגור');
                }
                else {
                    matchesActionType = (order['סוג פעולה'] === currentActionTypeFilter);
                }
            }

            let matchesAgent = true;
            if (selectedAgentFilter !== 'all') {
                matchesAgent = (order['שם סוכן'] === selectedAgentFilter);
            }

            let matchesShowClosed = true;
            if (!showClosed) {
                matchesShowClosed = (order._effectiveStatus === 'פתוח' || order._effectiveStatus === 'חורג');
            }
            
            return matchesSearch && matchesStatus && matchesActionType && matchesAgent && matchesShowClosed;
        });
        renderOrdersTable(filtered);
    }
    
    function resetTableFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-status-select').value = 'all';
        document.getElementById('filter-action-type-select').value = 'all';
        document.getElementById('filter-agent-select').value = 'all';
        document.getElementById('show-closed-orders').checked = false;
        filterTable();
    }

    function populateAgentFilter() {
        const agentSelect = document.getElementById('filter-agent-select');
        agentSelect.innerHTML = '<option value="all">כל הסוכנים</option>';
        const uniqueAgents = [...new Set(allOrders.map(order => order['שם סוכן']))].filter(Boolean).sort();
        uniqueAgents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent;
            option.textContent = agent;
            agentSelect.appendChild(option);
        });
    }

    // --- Date Formatting Utility ---
    function formatDate(dateInput) {
        if (!dateInput) return '';
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return dateInput;
        return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // --- Container Usage Validation ---
    function validateContainerUsage(containerNum, currentOrderSheetRow = null) {
        if (!containerNum) return true;

        const isContainerCurrentlyInUse = allOrders.some(order => {
            if (order.sheetRow === currentOrderSheetRow) {
                return false;
            }
            const containersTakenByOrder = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBroughtByOrder = String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);

            const isTaken = containersTakenByOrder.includes(containerNum);
            const isBrought = containersBroughtByOrder.includes(containerNum);

            return (order._effectiveStatus === 'פתוח' || order._effectiveStatus === 'חורג') && isTaken && !isBrought;
        });
        
        return !isContainerCurrentlyInUse;
    }

    // --- Order Modal (Add/Edit/Duplicate) Functions ---
    function openOrderModal(mode, sheetRow = null) {
        const form = document.getElementById('order-form');
        form.reset();
        currentEditingOrder = null;
        autoFillData = null;

        if (mode === 'add') {
            document.getElementById('modal-title').textContent = 'הוסף הזמנה חדשה';
            document.getElementById('תאריך הזמנה').valueAsDate = new Date();
            form.onsubmit = async e => {
                e.preventDefault();
                await addOrder();
            };
        } else if (mode === 'edit' && sheetRow) {
            document.getElementById('modal-title').textContent = 'ערוך הזמנה';
            currentEditingOrder = allOrders.find(order => order.sheetRow === sheetRow);
            if (currentEditingOrder) {
                Object.keys(currentEditingOrder).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        if (input.type === 'date' && currentEditingOrder[key]) {
                            input.value = new Date(currentEditingOrder[key]).toISOString().split('T')[0];
                        } else {
                            input.value = currentEditingOrder[key];
                        }
                    }
                });
                form.onsubmit = async e => {
                    e.preventDefault();
                    await editOrder(sheetRow);
                };
            }
        } else if (mode === 'duplicate' && sheetRow) {
            document.getElementById('modal-title').textContent = 'שכפל הזמנה';
            const originalOrder = allOrders.find(o => o.sheetRow === sheetRow);
            if (originalOrder) {
                Object.keys(originalOrder).forEach(key => {
                    const input = form.elements[key];
                    if (input && !['תעודה', 'תאריך סגירה', 'ימים שעברו', 'מספרי מכולות', '_effectiveStatus', '_daysPassedCalculated', 'sheetRow', 'Kanban Status'].includes(key)) {
                         if (input.type === 'date' && originalOrder[key]) {
                            input.value = new Date(originalOrder[key]).toISOString().split('T')[0];
                        } else {
                            input.value = originalOrder[key];
                        }
                    }
                });
                document.getElementById('תאריך הזמנה').valueAsDate = new Date();
                document.getElementById('תעודה').value = '';
                form.onsubmit = async e => {
                    e.preventDefault();
                    await addOrder();
                };
            }
        }
        handleActionTypeChange();
        openModal('order-modal');
    }

    function handleActionTypeChange() {
        const actionType = document.getElementById('סוג פעולה').value;
        const takenDiv = document.getElementById('container-taken-div');
        const broughtDiv = document.getElementById('container-brought-div');
        takenDiv.classList.toggle('hidden', !['הורדה', 'החלפה'].includes(actionType));
        broughtDiv.classList.toggle('hidden', !['העלאה', 'החלפה'].includes(actionType));
    }

    async function addOrder() {
        const form = document.getElementById('order-form');
        const formData = new FormData(form);
        const orderData = Object.fromEntries(formData.entries());
        
        const requiredFields = ['תאריך הזמנה', 'תעודה', 'שם סוכן', 'שם לקוח', 'כתובת', 'סוג פעולה'];
        for (const field of requiredFields) {
            if (!orderData[field] || String(orderData[field]).trim() === '') {
                showAlert(`שדה חובה חסר: ${field}`, 'error');
                return;
            }
        }

        if (['הורדה', 'החלפה'].includes(orderData['סוג פעולה'])) {
            const containerTaken = String(orderData['מספר מכולה ירדה'] || '').trim();
            if (containerTaken && !validateContainerUsage(containerTaken)) {
                showAlert(`שימו לב: מכולה ${containerTaken} נראית כבר בשימוש בהזמנה פתוחה אחרת. ודאו שזו הפעולה הרצויה.`, 'warning');
            }
        }

        orderData['סטטוס'] = 'פתוח';
        orderData['Kanban Status'] = null;

        const response = await fetchData('add', { data: JSON.stringify(orderData) });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('order-modal');
            await loadOrders();
            
            if (['העלאה', 'החלפה'].includes(orderData['סוג פעולה'])) {
                const containerBrought = String(orderData['מספר מכולה עלתה'] || '').trim();
                if (containerBrought) {
                    await closePreviousContainerOrders(containerBrought, orderData['תאריך הזמנה']);
                }
            }
        } else {
            showAlert(response.message || 'שגיאה בהוספת הזמנה', 'error');
        }
    }

    async function editOrder(sheetRow) {
        const form = document.getElementById('order-form');
        const formData = new FormData(form);
        const updateData = Object.fromEntries(formData.entries());
        
        const requiredFields = ['תאריך הזמנה', 'תעודה', 'שם סוכן', 'שם לקוח', 'כתובת', 'סוג פעולה'];
        for (const field of requiredFields) {
            if (!updateData[field] || String(updateData[field]).trim() === '') {
                showAlert(`שדה חובה חסר: ${field}`, 'error');
                return;
            }
        }

        if (['הורדה', 'החלפה'].includes(updateData['סוג פעולה'])) {
            const containerTaken = String(updateData['מספר מכולה ירדה'] || '').trim();
            if (containerTaken && !validateContainerUsage(containerTaken, sheetRow)) {
                showAlert(`מכולה ${containerTaken} כבר בשימוש בהזמנה פתוחה אחרת. אנא ודא שהיא פנויה.`, 'error');
                return;
            }
        }

        if (updateData.hasOwnProperty('סטטוס')) {
            delete updateData['סטטוס'];
        }
        if (updateData.hasOwnProperty('Kanban Status')) {
            delete updateData['Kanban Status'];
        }
        
        const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('order-modal');
            await loadOrders();

            if (['העלאה', 'החלפה'].includes(updateData['סוג פעולה'])) {
                const containerBrought = String(updateData['מספר מכולה עלתה'] || '').trim();
                if (containerBrought) {
                    await closePreviousContainerOrders(containerBrought, updateData['תאריך הזמנה']);
                }
            }
        } else {
            showAlert(response.message || 'שגיאה בעדכון הזמנה', 'error');
        }
    }

    async function closePreviousContainerOrders(containerNumber, closeDate) {
        const response = await fetchData('closePreviousContainerOrders', { containerNumber, closeDate });
        if (!response.success) {
            console.error("[closePreviousContainerOrders] Failed to update previous orders for container:", containerNumber, response.message);
        }
    }

    async function duplicateOrder(sheetRow) {
        openOrderModal('duplicate', sheetRow);
    }

    function openDeleteConfirmModal(sheetRow, orderId) {
        document.getElementById('delete-order-id').textContent = orderId;
        document.getElementById('confirm-delete-btn').onclick = () => deleteOrder(sheetRow);
        openModal('delete-confirm-modal');
    }

    async function deleteOrder(sheetRow) {
        const response = await fetchData('delete', { id: sheetRow });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('delete-confirm-modal');
            loadOrders();
        } else {
            showAlert(response.message || 'שגיאה במחיקת הזמנה', 'error');
        }
    }
    
    // --- Autofill Customer Details ---
    function checkCustomerExistenceAndAutofill() {
        const customerName = document.getElementById('שם לקוח').value.trim();
        const address = document.getElementById('כתובת').value.trim();
        const phone = document.getElementById('טלפון לקוח').value.trim();

        if (!customerName && !address && !phone) return;

        let latestOrder = allOrders
            .filter(o => {
                const matchesName = customerName ? o['שם לקוח'] === customerName : true;
                const matchesAddress = address ? o['כתובת'] === address : true;
                const matchesPhone = phone ? o['טלפון לקוח'] === phone : true;
                return matchesName && matchesAddress && matchesPhone;
            })
            .sort((a, b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']))[0];

        if (latestOrder && !currentEditingOrder) {
            autoFillData = latestOrder;
            document.getElementById('autofill-customer-name-display').textContent = `הלקוח ${latestOrder['שם לקוח']} זוהה!`;
            document.getElementById('autofill-message').innerHTML = `הלקוח <b>${latestOrder['שם לקוח']}</b> זוהה מהזמנה קודמת מתאריך <b>${formatDate(latestOrder['תאריך הזמנה'])}</b>. האם ברצונך למלא את פרטיו אוטומטית?`;
            openModal('autofill-confirm-modal');
        }
    }

    function confirmAutofill(confirm) {
        if (confirm && autoFillData) {
            Object.keys(autoFillData).forEach(key => {
                const input = document.getElementById(key);
                if (input && !['תעודה', 'תאריך הזמנה', 'תאריך סגירה', 'ימים שעברו', 'מספרי מכולות', '_effectiveStatus', '_daysPassedCalculated', 'sheetRow', 'Kanban Status'].includes(key)) {
                     if (input.type === 'date' && autoFillData[key]) {
                        input.value = new Date(autoFillData[key]).toISOString().split('T')[0];
                    } else {
                        input.value = autoFillData[key];
                    }
                }
            });
            document.getElementById('תאריך הזמנה').valueAsDate = new Date();
            document.getElementById('תעודה').value = '';
            handleActionTypeChange();
        }
        closeModal('autofill-confirm-modal');
        autoFillData = null;
    }

    // --- Order Details Modal ---
    function showOrderDetailsModal(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) {
            showAlert('פרטי הזמנה לא נמצאו.', 'error');
            return;
        }

        document.getElementById('details-order-id').textContent = order['תעודה'] || 'לא ידוע';
        const detailsContent = document.getElementById('order-details-content');
        detailsContent.innerHTML = `
            <p><strong>תאריך הזמנה:</strong> ${formatDate(order['תאריך הזמנה'])}</p>
            <p><strong>סטטוס:</strong> <span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></p>
            <p><strong>סטטוס קנבן:</strong> ${order['Kanban Status'] || 'לא נקבע'}</p>
            <p><strong>לקוח:</strong> ${order['שם לקוח'] || ''}</p>
            <p><strong>כתובת:</strong> ${order['כתובת'] || ''}</p>
            <p><strong>טלפון לקוח:</strong> ${order['טלפון לקוח'] || ''}</p>
            <p><strong>סוכן:</strong> ${order['שם סוכן'] || ''}</p>
            <p><strong>סוג פעולה:</strong> ${order['סוג פעולה'] || ''}</p>
            <p><strong>מכולה ירדה:</strong> ${order['מספר מכולה ירדה'] || ''}</p>
            <p><strong>מכולה עלתה:</strong> ${order['מספר מכולה עלתה'] || ''}</p>
            <p><strong>ימים שעברו:</strong> ${order._daysPassedCalculated || ''}</p>
            <p><strong>תאריך סיום צפוי:</strong> ${formatDate(order['תאריך סיום צפוי'])}</p>
            <p><strong>הערות:</strong> ${order['הערות'] || ''}</p>
            ${order['תאריך סגירה'] ? `<p><strong>תאריך סגירה:</strong> ${formatDate(order['תאריך סגירה'])}</p>` : ''}
        `;
        
        const actionButtonsDiv = document.querySelector('#order-details-modal .flex.justify-between.items-center');
        actionButtonsDiv.dataset.sheetRow = sheetRow;

        openModal('order-details-modal');
    }

    function editOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        closeModal('order-details-modal');
        openOrderModal('edit', parseInt(sheetRow));
    }

    function deleteOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        closeModal('order-details-modal');
        if (order) {
            openDeleteConfirmModal(parseInt(sheetRow), order['תעודה']);
        }
    }

    function duplicateOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        closeModal('order-details-modal');
        openOrderModal('duplicate', parseInt(sheetRow));
    }

    // --- WhatsApp Sharing from Order Details ---
    function shareOrderDetailsOnWhatsApp() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        if (!order) {
            showAlert('לא ניתן לשתף: פרטי הזמנה לא נמצאו.', 'error');
            return;
        }

        let message = `*פרטי הזמנה - ח. סבן חומרי בניין*\n\n`;
        message += `*תעודה:* ${order['תעודה'] || ''}\n`;
        message += `*לקוח:* ${order['שם לקוח'] || ''}\n`;
        message += `*כתובת:* ${order['כתובת'] || ''}\n`;
        message += `*טלפון:* ${order['טלפון לקוח'] || ''}\n`;
        message += `*סוג פעולה:* ${order['סוג פעולה'] || ''}\n`;
        if (order['מספר מכולה ירדה']) { message += `*מכולה ירדה:* ${order['מספר מכולה ירדה']}\n`; }
        if (order['מספר מכולה עלתה']) { message += `*מכולה עלתה:* ${order['מספר מכולה עלתה']}\n`; }
        message += `*סטטוס:* ${order._effectiveStatus || ''}\n`;
        message += `*תאריך הזמנה:* ${formatDate(order['תאריך הזמנה'])}\n`;
        if (order['תאריך סיום צפוי']) { message += `*תאריך סיום צפוי:* ${formatDate(order['תאריך סיום צפוי'])}\n`; }
        if (order['הערות']) { message += `*הערות:* ${order['הערות']}\n`; }

        const whatsappUrl = `https://wa.me/${order['טלפון לקוח'] || ''}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        showAlert('פותח WhatsApp לשיתוף פרטי הזמנה...', 'info');
        logWhatsAppMessage(order['תעודה'], message); // Log the shared message
    }

    // --- Printing Order Details ---
    function printOrderDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        if (!order) {
            showAlert('לא ניתן להדפיס: פרטי הזמנה לא נמצאו.', 'error');
            return;
        }
        
        printOrderDocument(order); // Call the new, advanced printing function
    }


    // --- Container & Customer History Modals ---
    function showContainerHistory(containerNumber) {
        document.getElementById('history-container-number').textContent = containerNumber;
        const historyTableBody = document.getElementById('container-history-table-body');
        historyTableBody.innerHTML = '';
        document.getElementById('no-container-history').classList.add('hidden');

        const containerMovements = allOrders
            .filter(order => {
                const containersTaken = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                return containersTaken.includes(containerNumber) || containersBrought.includes(containerNumber);
            })
            .sort((a, b) => new Date(a['תאריך הזמנה']) - new Date(b['תאריך הזמנה']));

        if (containerMovements.length === 0) {
            document.getElementById('no-container-history').classList.remove('hidden');
        } else {
            containerMovements.forEach(order => {
                const startDate = new Date(order['תאריך הזמנה']);
                const endDate = order['תאריך סגירה'] ? new Date(order['תאריך סגירה']) : (order['תאריך סיום צפוי'] ? new Date(order['תאריך סיום צפוי']) : new Date());
                
                let durationDays = 'N/A';
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    durationDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
                    durationDays = Math.max(0, durationDays);
                }

                const row = historyTableBody.insertRow();
                row.className = 'border-b border-[var(--color-border)]';
                row.innerHTML = `
                    <td class="p-2">${order['תעודה'] || ''}</td>
                    <td class="p-2 font-medium">${order['שם לקוח'] || ''}</td>
                    <td class="p-2">${order['כתובת'] || ''}</td>
                    <td class="p-2">${order['סוג פעולה'] || ''}</td>
                    <td class="p-2">${formatDate(order['תאריך הזמנה'])}</td>
                    <td class="p-2">${order['תאריך סגירה'] ? formatDate(order['תאריך סגירה']) : (order['תאריך סיום צפוי'] ? formatDate(order['תאריך סיום צפוי']) : 'טרם נסגר')}</td>
                    <td class="p-2">${durationDays !== 'N/A' ? `${durationDays} ימים` : 'N/A'}</td>
                `;
            });
        }
        openModal('container-history-modal');
    }

    function showCustomerHistory(customerName) {
        document.getElementById('history-customer-name').textContent = customerName;
        const historyTableBody = document.getElementById('customer-history-table-body');
        historyTableBody.innerHTML = '';
        document.getElementById('no-customer-history').classList.add('hidden');

        const customerOrders = allOrders
            .filter(order => order['שם לקוח'] === customerName)
            .sort((a, b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']));

        if (customerOrders.length === 0) {
            document.getElementById('no-customer-history').classList.remove('hidden');
        } else {
            customerOrders.forEach(order => {
                const row = historyTableBody.insertRow();
                row.className = 'border-b border-[var(--color-border)] cursor-pointer';
                row.onclick = () => {
                    closeModal('customer-history-modal');
                    showOrderDetailsModal(order.sheetRow);
                };
                row.innerHTML = `
                    <td class="p-2">${formatDate(order['תאריך הזמנה'])}</td>
                    <td class="p-2">${order['תעודה'] || ''}</td>
                    <td class="p-2">${order['סוג פעולה'] || ''}</td>
                    <td class="p-2">${order['מספר מכולה ירדה'] || ''}</td>
                    <td class="p-2">${order['מספר מכולה עלתה'] || ''}</td>
                    <td class="p-2"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                    <td class="p-2">${order['הערות'] || ''}</td>
                `;
            });
        }
        openModal('customer-history-modal');
    }

    // --- WhatsApp Sharing from Customer History ---
    function shareCustomerHistoryOnWhatsApp() {
        const customerName = document.getElementById('history-customer-name').textContent;
        const customerOrders = allOrders.filter(order => order['שם לקוח'] === customerName);
        
        if (!customerOrders.length) {
            showAlert('אין היסטוריית הזמנות לשתף עבור לקוח זה.', 'warning');
            return;
        }

        let message = `*היסטוריית הזמנות ללקוח: ${customerName}*\n\n`;
        customerOrders.slice(0, 5).forEach(order => { // Share up to 5 latest orders for brevity
            message += `*תעודה:* ${order['תעודה']}, *פעולה:* ${order['סוג פעולה']}, *תאריך:* ${formatDate(order['תאריך הזמנה'])}, *סטטוס:* ${order._effectiveStatus}\n`;
        });
        if (customerOrders.length > 5) {
            message += `ועוד ${customerOrders.length - 5} הזמנות...\n`;
        }
        message += `\nלפרטים נוספים, צור קשר.`;

        const phoneNumber = customerOrders[0]['טלפון לקוח'] || ''; // Get phone from first order
        if (!phoneNumber) {
            showAlert('לא נמצא מספר טלפון ללקוח זה.', 'warning');
            return;
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        showAlert('פותח WhatsApp לשיתוף היסטוריית לקוח...', 'info');
        // No doc ID for logging customer history, can log with customer name if needed
        logWhatsAppMessage(`CustomerHistory_${customerName}`, message);
    }

    // --- Printing Customer History ---
    function printCustomerHistory() {
        const customerName = document.getElementById('history-customer-name').textContent;
        const customerOrders = allOrders.filter(order => order['שם לקוח'] === customerName);
        
        if (!customerOrders.length) {
            showAlert('אין היסטוריית הזמנות להדפסה עבור לקוח זה.', 'warning');
            return;
        }

        let tableRowsHtml = customerOrders.map(order => `
            <tr>
                <td>${formatDate(order['תאריך הזמנה'])}</td>
                <td>${order['תעודה'] || ''}</td>
                <td>${order['סוג פעולה'] || ''}</td>
                <td>${order['מספר מכולה ירדה'] || ''}</td>
                <td>${order['מספר מכולה עלתה'] || ''}</td>
                <td>${order._effectiveStatus || ''}</td>
                <td>${order['הערות'] || ''}</td>
            </tr>
        `).join('');

        let printContent = `
            <div id="print-area" style="direction: rtl; text-align: right; margin: 0 auto; max-width: 900px;">
                <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="Company Logo" style="max-width: 150px; margin-bottom: 20px; display: block;">
                <h1 style="font-size: 24px; color: #2F4F4F; margin-bottom: 20px;">היסטוריית הזמנות ללקוח: ${customerName}</h1>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">תאריך הזמנה</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">תעודה</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">סוג פעולה</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">מכולה ירדה</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">מכולה עלתה</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">סטטוס</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">הערות</th>
                        </tr>
                    </thead>
                    <tbody>${tableRowsHtml}</tbody>
                </table>
            </div>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>הדפסת היסטוריית לקוח</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            body { font-family: 'Rubik', sans-serif; margin: 0; padding: 0; }
            #print-area { width: 100%; padding: 20px; box-sizing: border-box; }
            #print-area img { max-width: 150px; margin-bottom: 20px; }
            #print-area h1 { font-size: 24px; color: #2F4F4F; margin-bottom: 20px; }
            #print-area table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            #print-area th, #print-area td { border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 13px; }
            #print-area th { background-color: #f2f2f2; }
            @media print {
                body { margin: 0; }
            }
        `);
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }


    // --- Close Order Modal ---
    function openCloseOrderModal(sheetRow, orderId) {
        const confirmBtn = document.getElementById('confirm-close-order-btn');
        confirmBtn.dataset.sheetRow = sheetRow;
        
        document.getElementById('close-order-id-display').textContent = orderId;
        document.getElementById('close-order-notes').value = '';
        
        confirmBtn.onclick = async () => {
            const notes = document.getElementById('close-order-notes').value;
            const sheetRowToClose = parseInt(confirmBtn.dataset.sheetRow);
            if (isNaN(sheetRowToClose)) {
                showAlert('שגיאה: מספר הזמנה לא חוקי. אנא רענן ונסה שוב.', 'error');
                return;
            }
            await closeOrderConfirmation(sheetRowToClose, notes);
        };
        openModal('close-order-modal');
    }

    async function closeOrderConfirmation(sheetRow, notes) {
        const response = await fetchData('close', { sheetRow: sheetRow, notes: notes });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('close-order-modal');
            loadOrders();
        } else {
            showAlert(response.message || 'שגיאה בסגירת הזמנה', 'error');
        }
    }


    // --- Chart.js Rendering for Dashboard ---
    function drawCharts() {
        const customerData = allOrders.reduce((acc, order) => {
            if (order._effectiveStatus !== 'סגור') {
                const count = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean).length;
                if (count > 0 && order['סוג פעולה'] !== 'העלאה') {
                    acc[order['שם לקוח']] = (acc[order['שם לקוח']] || 0) + count;
                }
            }
            return acc;
        }, {});
        const sortedCustomers = Object.entries(customerData).sort((a, b) => b[1] - a[1]).slice(0, 10);

        const statusData = allOrders.reduce((acc, order) => {
            const status = order._effectiveStatus || 'לא ידוע';
            acc[status] = (acc[status] || 0) + 1;
            return acc;
        }, {});

        const actionTypeChartData = allOrders.reduce((acc, order) => {
            const actionType = order['סוג פעולה'] || 'לא ידוע';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        const computedStyle = getComputedStyle(document.documentElement);
        const surfaceColor = computedStyle.getPropertyValue('--color-surface').trim();
        const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
        const dangerColor = computedStyle.getPropertyValue('--color-danger').trim();
        const successColor = computedStyle.getPropertyValue('--color-success').trim();
        const warningColor = computedStyle.getPropertyValue('--color-warning').trim();
        const textBaseColor = computedStyle.getPropertyValue('--color-text-base').trim();

        const chartColors = {
            'פתוח': successColor,
            'חורג': dangerColor,
            'סגור': 'rgba(108, 117, 125, 0.8)',
            'הורדה': successColor,
            'החלפה': warningColor,
            'העלאה': dangerColor
        };

        const getOpaqueColor = (color) => {
            if (color.startsWith('rgba')) {
                return color.replace(/, ?\d(\.\d+)?\)$/, ')').replace('rgba', 'rgb');
            }
            return color;
        };


        if (charts.customerChart) charts.customerChart.destroy();
        charts.customerChart = new Chart(document.getElementById('chart-containers-by-customer').getContext('2d'), {
            type: 'bar',
            data: {
                labels: sortedCustomers.map(c => c[0]),
                datasets: [{
                    label: 'מספר מכולות בשימוש',
                    data: sortedCustomers.map(c => c[1]),
                    backgroundColor: primaryColor,
                    borderColor: getOpaqueColor(primaryColor),
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false }
                    },
                    y: {
                        grid: { display: false }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const customerName = sortedCustomers[index][0];
                        document.getElementById('search-input').value = customerName;
                        filterTable();
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });

        if (charts.statusChart) charts.statusChart.destroy();
        charts.statusChart = new Chart(document.getElementById('chart-status-pie').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: Object.keys(statusData).map(status => chartColors[status] || '#bdc3c7'),
                    borderColor: surfaceColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            color: textBaseColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const statusClicked = Object.keys(statusData)[index];
                        document.getElementById('search-input').value = '';
                        document.getElementById('show-closed-orders').checked = (statusClicked === 'סגור');
                        document.getElementById('filter-status-select').value = statusClicked;
                        filterTable(statusClicked, null, true);
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });

        if (charts.actionTypeChart) charts.actionTypeChart.destroy();
        charts.actionTypeChart = new Chart(document.getElementById('chart-action-type').getContext('2d'), {
            type: 'bar',
            data: {
                labels: Object.keys(actionTypeChartData),
                datasets: [{
                    label: 'מספר פעולות',
                    data: Object.values(actionTypeChartData),
                    backgroundColor: Object.keys(actionTypeChartData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: Object.keys(actionTypeChartData).map(type => getOpaqueColor(chartColors[type] || '#bdc3c7')),
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { display: false }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const actionTypeClicked = Object.keys(actionTypeChartData)[index];
                        document.getElementById('search-input').value = '';
                        document.getElementById('filter-action-type-select').value = actionTypeClicked;
                        filterTable(null, actionTypeClicked, true);
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });
    }

    // --- Container Inventory Updates ---
    function updateContainerInventory() {
        const inUseTableBody = document.querySelector('#containers-in-use-table tbody');
        const availableTableBody = document.querySelector('#containers-available-table tbody');
        inUseTableBody.innerHTML = '';
        availableTableBody.innerHTML = '';

        const containerStates = {};

        [...allOrders].sort((a, b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה'])).forEach(order => {
            const orderDate = new Date(order['תאריך הזמנה']);
            const containersTaken = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);

            containersBrought.forEach(c => {
                 if (c && (!containerStates[c] || orderDate > containerStates[c].lastRelevantActivityDate)) {
                    containerStates[c] = {
                        status: 'available',
                        lastRelevantActivityDate: orderDate
                    };
                }
            });
            containersTaken.forEach(c => {
                if (c && !containersBrought.includes(c)) {
                    if (!containerStates[c] || orderDate > containerStates[c].lastRelevantActivityDate) {
                        if (order._effectiveStatus !== 'סגור') {
                            containerStates[c] = {
                                status: 'in-use',
                                lastRelevantActivityDate: orderDate,
                                currentOrder: order
                            };
                        } else {
                            containerStates[c] = {
                                status: 'available',
                                lastRelevantActivityDate: orderDate
                            };
                        }
                    }
                }
            });
        });

        Object.entries(containerStates).sort((a,b) => a[0].localeCompare(b[0])).forEach(([num, state]) => {
            const row = document.createElement('tr');
            row.className = 'border-b border-[var(--color-border)]';
            if (state.status === 'in-use') {
                row.innerHTML = `<td class="p-3"><span class="cursor-pointer hover:text-[var(--color-primary)]" onclick="showContainerHistory('${num}')"><i class="fas fa-box"></i> ${num}</span></td><td class="p-3">${state.currentOrder['שם לקוח']}</td><td class="p-3">${formatDate(state.currentOrder['תאריך הזמנה'])}</td>`;
                inUseTableBody.appendChild(row);
            } else {
                let estimatedAvailableDate = new Date(state.lastRelevantActivityDate);
                
                row.innerHTML = `<td class="p-3"><span class="cursor-pointer hover:text-[var(--color-primary)]" onclick="showContainerHistory('${num}')"><i class="fas fa-box"></i> ${num}</span></td><td class="p-3">${formatDate(estimatedAvailableDate)}</td>`;
                availableTableBody.appendChild(row);
            }
        });
    }


    // --- Kanban Board (Treatment Board) ---
    function renderTreatmentBoard() {
        const columns = {
            overdue: document.getElementById('column-overdue'),
            'in-progress': document.getElementById('column-in-progress'),
            resolved: document.getElementById('column-resolved'),
        };
        Object.values(columns).forEach(col => col.querySelectorAll('.kanban-item').forEach(item => item.remove()));

        const ordersForTreatment = allOrders.filter(o => 
            (o._effectiveStatus === 'חורג' && o['Kanban Status'] !== 'טופלו') || 
            (o['Kanban Status'] === 'בטיפול')
        ); 

        document.getElementById('no-treatment-orders').classList.toggle('hidden', ordersForTreatment.length > 0);

        ordersForTreatment.forEach(order => {
            const item = document.createElement('div');
            item.className = 'kanban-item card p-4 cursor-grab bg-white border border-[var(--color-border)] rounded-lg shadow-sm';
            item.draggable = true;
            item.dataset.sheetRow = order.sheetRow;
            item.ondragstart = e => e.dataTransfer.setData('text/plain', order.sheetRow);
            
            const daysPassedHtml = order._effectiveStatus === 'חורג' ?
                `<span class="overdue-text-blinking">${order._daysPassedCalculated || 0}</span>` :
                `${order._daysPassedCalculated || 0}`;

            item.innerHTML = `
                <p class="font-bold text-lg text-[var(--color-text-base)]">${order['שם לקוח']}</p>
                <p class="text-sm text-[var(--color-text-muted)]">תעודה: ${order['תעודה']}</p>
                <p class="text-sm mt-2"><span class="font-semibold text-[var(--color-danger)]">${daysPassedHtml}</span> ימים שעברו</p>
                <div class="flex justify-end gap-1 mt-3">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="שלח WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="ערוך"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="שכפל"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    ${order._effectiveStatus !== 'סגור' ? `<button class="action-icon-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['תעודה']}')" title="סגור הזמנה"><i class="fas fa-check-circle text-[var(--color-success)]"></i></button>` : ''}
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['תעודה']}')" title="מחק"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </div>
            `;
            
            let targetColumnElement;
            if (order['Kanban Status'] === 'בטיפול') {
                targetColumnElement = columns['in-progress'];
            } else if (order._effectiveStatus === 'חורג' && order['Kanban Status'] !== 'טופלו') {
                targetColumnElement = columns['overdue'];
            } else {
                return; 
            }
            targetColumnElement.appendChild(item);
        });
    }
    
    function allowDrop(event) { event.preventDefault(); }

    async function drop(event) {
        event.preventDefault();
        const sheetRow = event.dataTransfer.getData('text/plain');
        const targetColumn = event.currentTarget;
        const currentOrder = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        if (!currentOrder) {
            return;
        }

        let updateData = {};
        if (targetColumn.id === 'column-overdue') {
            updateData['Kanban Status'] = null;
        } else if (targetColumn.id === 'column-in-progress') {
            updateData['Kanban Status'] = 'בטיפול';
        } else if (targetColumn.id === 'column-resolved') {
            updateData['Kanban Status'] = 'טופלו';
            updateData['סטטוס'] = 'סגור';
            updateData['תאריך סגירה'] = new Date().toISOString().split('T')[0];
            updateData['הערות סיום'] = 'נסגר אוטומטית מלוח הקנבן.';
        }

        const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
        if (response.success) {
            showAlert('סטטוס הזמנה עודכן בהצלחה!', 'success');
            loadOrders();
        } else {
            showAlert(response.message || 'שגיאה בעדכון סטטוס', 'error');
        }
    }

    // --- Data Refresh ---
    function refreshData() {
        showAlert('מרענן נתונים... אנא המתן.', 'info');
        loadOrders();
    }

    // --- Page Navigation ---
    let currentPage = 'dashboard'; // Track current page

    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        document.querySelectorAll('.nav-tab-btn').forEach(b => b.classList.toggle('active', b.id === `nav-${pageId}`));
        
        currentPage = pageId; // Update current page tracker

        if (pageId === 'whatsapp-alerts') {
            populateWhatsAppTemplates();
        } else if (pageId === 'reports') {
            // Set default date range for reports to current month
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('report-start-date').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = lastDayOfMonth.toISOString().split('T')[0];
            filterReports(); // Automatically filter reports for current month
        }
    }

    // --- WhatsApp Templates and Typing Effect ---
    const whatsappTemplates = [
        { name: 'ברכה - ח. סבן', message: 'שלום [שם לקוח] יקר/ה, תודה שבחרת ב-ח. סבן חומרי בניין! אנו לרשותך בכל שאלה. 🤔👷‍♂️🏗️' },
        { name: 'הצבת מכולה - הנחיות', message: 'שלום [שם לקוח], המכולה להזמנה [תעודה] הוצבה בהצלחה. אנא וודא גישה נוחה לפינוי. לשאלות: [טלפון עסק].' },
        { name: 'התראה - לפני חריגה (8 ימים)', message: 'שלום [שם לקוח], המכולה בהזמנה [תעודה] נמצאת אצלך כ-8 ימים. לתשומת לבך, מעל 10 ימים מתאריך הזמנה, המכולה נחשבת חורגת. אנא צור קשר לתיאום המשך. ⚠️' },
        { name: 'התראה - חורגת (10 ימים +)', message: 'הודעה חשובה: המכולה בהזמנה [תעודה] חורגת ממועד השכירות ב-[ימים חורגים] ימים. אנא צור קשר בהקדם לתיאום החלפה/פינוי דחוף: [טלפון עסק]. 🚨' },
        { name: 'תיאום החלפה', message: 'שלום [שם לקוח], לגבי הזמנה [תעודה], נשמח לתאם החלפה. מתי נוח לך שנגיע? אנא השב להודעה זו. 🗓️' },
        { name: 'תיאום הוצאה', message: 'שלום [שם לקוח], נשמח לתאם הוצאת מכולה עבור הזמנה [תעודה]. מתי נוח לך שנגיע? אנא השב להודעה זו. 🗓️' },
        { name: 'תזכורת - תאריך סיום צפוי', message: 'שלום [שם לקוח], תזכורת: תאריך הסיום הצפוי של המכולה בהזמנה [תעודה] הוא ב-[תאריך סיום צפוי]. אנא צור קשר אם תרצה להאריך או לתאם פינוי. 🔔' },
        { name: 'הודעה כללית', message: 'שלום [שם לקוח], בהמשך להזמנה [תעודה], רציתי לעדכן...' },
        { name: 'הודעה על הגעת מכולה', message: 'שלום [שם לקוח], המכולה בהזמנה [תעודה] הגיעה ליעדה. תודה שבחרת בנו! 🎉' },
        { name: 'הודעה על איסוף מכולה', message: 'שלום [שם לקוח], המכולה בהזמנה [תעודה] נאספה בהצלחה. נשמח לשרת אותך שוב בעתיד! 👋' },
        { name: 'שאלות כלליות', message: 'שלום [שם לקוח], אנו עומדים לרשותך לכל שאלה או בקשה לגבי השירות שלנו. ❓' },
        { name: 'תלונה/בעיה', message: 'שלום [שם לקוח], הבנו שיש לך בעיה עם הזמנה [תעודה]. אנו מצטערים על אי הנוחות ונחזור אליך בהקדם לטפל בעניין. 😔' },
        { name: 'בקשת חוות דעת', message: 'שלום [שם לקוח], אנו מקווים שנהנית מהשירות שלנו בהזמנה [תעודה]. נשמח אם תוכל/י להשאיר חוות דעת קצרה. ⭐' },
        { name: 'הצעת שירותים נוספים', message: 'שלום [שם לקוח], ראינו שאתה לקוח פעיל. אולי יעניין אותך ללמוד על השירותים החדשים שלנו? ✨' },
        { name: 'עדכון זמינות', message: 'שלום [שם לקוח], רצינו לעדכן לגבי זמינות המכולות. כרגע יש לנו... ℹ️' },
        { name: 'אישור הזמנה', message: 'שלום [שם לקוח], הזמנתך מספר [תעודה] אושרה בהצלחה! תאריך אספקה צפוי: [תאריך סיום צפוי]. ✅' },
        { name: 'הודעה על עיכוב', message: 'שלום [שם לקוח], אנו מתנצלים על עיכוב קל באספקת המכולה להזמנה [תעודה]. אנו צופים שתגיע ב-[תאריך חדש]. ⏳' },
        { name: 'תודה על תשלום', message: 'שלום [שם לקוח], קיבלנו את התשלום עבור הזמנה [תעודה]. תודה רבה! 🙏' },
        { name: 'בקשת תשלום', message: 'שלום [שם לקוח], תזכורת לגבי תשלום עבור הזמנה [תעודה]. אנא בצע את התשלום בהקדם. 💸' },
        { name: 'פנוי במקום', message: 'שלום [שם לקוח], לגבי הזמנה [תעודה], נאשר כי בוצע פינוי מכולה באתר. אנו מעריכים את שיתוף הפעולה. 👍' },
        { name: 'אישור קבלת מסמכים', message: 'שלום [שם לקוח], אישור קבלת המסמכים הדרושים עבור הזמנה [תעודה]. תודה על שיתוף הפעולה. 📄' },
        { name: 'עדכון שעות פעילות', message: 'שלום [שם לקוח], לתשומת ליבך, שעות הפעילות שלנו עודכנו. פרטים באתר: [קישור לאתר]. ⏰' },
        { name: 'הודעה על שירות חדש', message: 'שלום [שם לקוח], אנו שמחים להודיע על שירות חדש שלנו: [שם שירות]. לפרטים נוספים: [קישור]. 🆕' },
        { name: 'אירוע חברה', message: 'שלום [שם לקוח], אנו מזמינים אותך לאירוע חברה מיוחד שיתקיים ב-[תאריך אירוע]. פרטים והרשמה: [קישור]. 🥳' },
        { name: 'טיפים לתחזוקה', message: 'שלום [שם לקוח], הנה כמה טיפים חשובים לתחזוקה נכונה של המכולה שלך. 💡' },
        { name: 'שינוי פרטי קשר', message: 'שלום [שם לקוח], אם שינית פרטי קשר, אנא עדכן אותנו כדי שנוכל להמשיך לתת שירות מיטבי. 📞' },
        { name: 'סקר שביעות רצון', message: 'שלום [שם לקוח], אנו מבקשים את עזרתך במילוי סקר שביעות רצון קצר כדי שנוכל להשתפר. 😊' },
        { name: 'חג שמח', message: 'חג שמח [שם לקוח]! מכולנו ב-ח. סבן חומרי בניין. 🎊' },
        { name: 'שנה טובה', message: 'שנה טובה ומבורכת [שם לקוח]! מאחלים לך שנה של הצלחה ושגשוג. 🌟' },
        { name: 'סוף שנה אזרחית', message: 'שלום [שם לקוח], תודה על שנה נפלאה של שיתוף פעולה. נשמח להמשיך לשרת אותך גם בשנה הבאה! 👋' }
    ];

    let currentTypingIndex = 0;
    let currentTypingTemplateMessage = '';
    let typingInterval = null;

    function populateWhatsAppTemplates() {
        const select = document.getElementById('message-template-select');
        select.innerHTML = '<option value="">בחר תבנית...</option>';
        whatsappTemplates.forEach((template, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = template.name;
            select.appendChild(option);
        });
    }

    function loadWhatsAppTemplate() {
        const select = document.getElementById('message-template-select');
        const messageInput = document.getElementById('whatsapp-message-input');
        const selectedIndex = select.value;

        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        messageInput.value = '';

        if (selectedIndex !== "") {
            const template = whatsappTemplates[parseInt(selectedIndex)];
            let message = template.message;
            
            const customerName = document.getElementById('whatsapp-customer-name').value;
            const address = document.getElementById('whatsapp-address').value;
            const orderId = document.getElementById('details-order-id').textContent;
            
            message = message.replace('[שם לקוח]', customerName || 'הלקוח');
            message = message.replace('[תעודה]', orderId || 'לא ידוע');
            message = message.replace('[טלפון עסק]', '050-1234567');
            message = message.replace('[כתובת]', address || '');
            
            const selectedOrder = allOrders.find(o => o['תעודה'] === orderId);
            if (selectedOrder) {
                if (selectedOrder._effectiveStatus === 'חורג' && selectedOrder._daysPassedCalculated) {
                    message = message.replace('[ימים חורגים]', selectedOrder._daysPassedCalculated);
                }
                if (selectedOrder['תאריך סיום צפוי']) {
                    message = message.replace('[תאריך סיום צפוי]', formatDate(selectedOrder['תאריך סיום צפוי']));
                }
                 if (selectedOrder['תאריך חדש']) { 
                    message = message.replace('[תאריך חדש]', formatDate(selectedOrder['תאריך חדש']));
                }
            }

            message = message.replace(/\[.*?\]/g, ''); 

            currentTypingTemplateMessage = message;
            currentTypingIndex = 0;
            messageInput.classList.add('typing-effect');
            typingInterval = setInterval(() => {
                if (currentTypingIndex < currentTypingTemplateMessage.length) {
                    messageInput.value += currentTypingTemplateMessage.charAt(currentTypingIndex);
                    currentTypingIndex++;
                    messageInput.scrollTop = messageInput.scrollHeight;
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    messageInput.classList.remove('typing-effect');
                }
            }, 30);
        } else {
            messageInput.value = '';
            messageInput.classList.remove('typing-effect');
        }
    }

    function clearWhatsAppMessage() {
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        document.getElementById('whatsapp-message-input').value = '';
        document.getElementById('whatsapp-message-input').classList.remove('typing-effect');
        document.getElementById('message-template-select').value = '';
        document.getElementById('whatsapp-customer-name').value = '';
        document.getElementById('whatsapp-phone-number').value = '';
        document.getElementById('whatsapp-address').value = '';
        document.getElementById('details-order-id').textContent = '';
    }

    // --- Reports Page Logic ---
    let reportsOrdersToDisplay = [];
    const REPORTS_INITIAL_DISPLAY_LIMIT = 20;
    let currentReportsDisplayCount = 0;

    function filterReports() {
        const startDateInput = document.getElementById('report-start-date').value;
        const endDateInput = document.getElementById('report-end-date').value;

        let filteredReports = allOrders;

        if (startDateInput) {
            const startDate = new Date(startDateInput);
            filteredReports = filteredReports.filter(order => new Date(order['תאריך הזמנה']) >= startDate);
        }
        if (endDateInput) {
            const endDate = new Date(endDateInput);
            filteredReports = filteredReports.filter(order => new Date(order['תאריך הזמנה']) <= endDate);
        }

        // Sort by date (newest first) for reports
        filteredReports.sort((a, b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']));
        
        reportsOrdersToDisplay = filteredReports;
        currentReportsDisplayCount = REPORTS_INITIAL_DISPLAY_LIMIT;

        updateReportSummaries(filteredReports);
        drawReportCharts(filteredReports);
        renderReportTable(reportsOrdersToDisplay.slice(0, currentReportsDisplayCount));
    }

    function resetReportFilters() {
        document.getElementById('report-start-date').value = '';
        document.getElementById('report-end-date').value = '';
        filterReports(); // Re-filter with no dates
    }

    function updateReportSummaries(orders) {
        let downloads = 0;
        let exchanges = 0;
        let uploads = 0;

        orders.forEach(order => {
            if (order['סוג פעולה'] === 'הורדה') downloads++;
            if (order['סוג פעולה'] === 'החלפה') exchanges++;
            if (order['סוג פעולה'] === 'העלאה') uploads++;
        });

        document.getElementById('summary-downloads').textContent = downloads;
        document.getElementById('summary-exchanges').textContent = exchanges;
        document.getElementById('summary-uploads').textContent = uploads;
    }

    function drawReportCharts(orders) {
        const computedStyle = getComputedStyle(document.documentElement);
        const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
        const dangerColor = computedStyle.getPropertyValue('--color-danger').trim();
        const successColor = computedStyle.getPropertyValue('--color-success').trim();
        const warningColor = computedStyle.getPropertyValue('--color-warning').trim();
        const textBaseColor = computedStyle.getPropertyValue('--color-text-base').trim();
        const surfaceColor = computedStyle.getPropertyValue('--color-surface').trim();

        const chartColors = {
            'הורדה': successColor,
            'החלפה': warningColor,
            'העלאה': dangerColor
        };
        const getOpaqueColor = (color) => {
            if (color.startsWith('rgba')) {
                return color.replace(/, ?\d(\.\d+)?\)$/, ')').replace('rgba', 'rgb');
            }
            return color;
        };

        // Monthly Actions Chart
        const monthlyData = orders.reduce((acc, order) => {
            const date = new Date(order['תאריך הזמנה']);
            const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            if (!acc[monthYear]) {
                acc[monthYear] = { 'הורדה': 0, 'החלפה': 0, 'העלאה': 0 };
            }
            if (order['סוג פעולה']) {
                acc[monthYear][order['סוג פעולה']]++;
            }
            return acc;
        }, {});

        const sortedMonths = Object.keys(monthlyData).sort();
        const monthlyDownloads = sortedMonths.map(month => monthlyData[month]['הורדה']);
        const monthlyExchanges = sortedMonths.map(month => monthlyData[month]['החלפה']);
        const monthlyUploads = sortedMonths.map(month => monthlyData[month]['העלאה']);

        if (charts.reportsMonthlyActions) charts.reportsMonthlyActions.destroy();
        charts.reportsMonthlyActions = new Chart(document.getElementById('chart-reports-monthly-actions').getContext('2d'), {
            type: 'bar',
            data: {
                labels: sortedMonths,
                datasets: [
                    {
                        label: 'הורדות 📦⬇️',
                        data: monthlyDownloads,
                        backgroundColor: chartColors['הורדה'],
                        borderColor: getOpaqueColor(chartColors['הורדה']),
                        borderWidth: 1,
                        borderRadius: 5
                    },
                    {
                        label: 'החלפות 🔄',
                        data: monthlyExchanges,
                        backgroundColor: chartColors['החלפה'],
                        borderColor: getOpaqueColor(chartColors['החלפה']),
                        borderWidth: 1,
                        borderRadius: 5
                    },
                    {
                        label: 'העלאות ⬆️',
                        data: monthlyUploads,
                        backgroundColor: chartColors['העלאה'],
                        borderColor: getOpaqueColor(chartColors['העלאה']),
                        borderWidth: 1,
                        borderRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textBaseColor
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                        grid: { display: false }
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        grid: { display: true, color: 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });

        // Action Distribution Chart (Pie/Doughnut)
        const actionDistributionData = orders.reduce((acc, order) => {
            const actionType = order['סוג פעולה'];
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        if (charts.reportsActionDistribution) charts.reportsActionDistribution.destroy();
        charts.reportsActionDistribution = new Chart(document.getElementById('chart-reports-action-distribution').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(actionDistributionData),
                datasets: [{
                    data: Object.values(actionDistributionData),
                    backgroundColor: Object.keys(actionDistributionData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: surfaceColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textBaseColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderReportTable(ordersToRender) {
        const tableBody = document.querySelector('#reports-orders-table tbody');
        tableBody.innerHTML = '';
        const noOrdersMessage = document.getElementById('no-report-orders');
        const loadMoreContainer = document.getElementById('reports-load-more-container');

        if (reportsOrdersToDisplay.length === 0) {
            noOrdersMessage.classList.remove('hidden');
            loadMoreContainer.classList.add('hidden');
            return;
        } else {
            noOrdersMessage.classList.add('hidden');
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer`;
            row.onclick = () => showOrderDetailsModal(order.sheetRow);

            const containersTaken = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')"><i class="fas fa-box"></i> ${c.trim()}</span>`
            ).join(' ');

            let actionEmoji = '';
            if (order['סוג פעולה'] === 'הורדה') actionEmoji = '📦⬇️';
            else if (order['סוג פעולה'] === 'החלפה') actionEmoji = '🔄';
            else if (order['סוג פעולה'] === 'העלאה') actionEmoji = '⬆️';

            row.innerHTML = `
                <td class="p-3">${formatDate(order['תאריך הזמנה'])}</td>
                <td class="p-3">${order['תעודה'] || ''}</td>
                <td class="p-3">${order['שם לקוח'] || ''}</td>
                <td class="p-3">${order['סוג פעולה'] || ''} ${actionEmoji}</td>
                <td class="p-3">${containerHTML}</td>
                <td class="p-3"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
            `;
        });

        // Show/hide Load More button
        if (currentReportsDisplayCount < reportsOrdersToDisplay.length) {
            loadMoreContainer.classList.remove('hidden');
        } else {
            loadMoreContainer.classList.add('hidden');
        }
    }

    function loadMoreReportOrders() {
        currentReportsDisplayCount += REPORTS_INITIAL_DISPLAY_LIMIT;
        renderReportTable(reportsOrdersToDisplay.slice(0, currentReportsDisplayCount));
    }

    async function sendReportsByEmail() {
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const filteredOrders = reportsOrdersToDisplay; // Use the already filtered data

        if (filteredOrders.length === 0) {
            showAlert('אין נתונים בדוח לשליחה במייל.', 'warning');
            return;
        }

        // Prepare email content (simplified for this example, a full HTML report would be complex)
        let emailBody = `
            שלום רב,
            מצ"ב סיכום פעילות מכולות לתקופה: ${formatDate(startDate || 'התחלה')} - ${formatDate(endDate || 'היום')}.

            *סיכומים:*
            סה"כ הורדות: ${document.getElementById('summary-downloads').textContent}
            סה"כ החלפות: ${document.getElementById('summary-exchanges').textContent}
            סה"כ העלאות: ${document.getElementById('summary-uploads').textContent}

            *הזמנות רלוונטיות:*
        `;

        filteredOrders.forEach(order => {
            emailBody += `
            - תעודה: ${order['תעודה']}, לקוח: ${order['שם לקוח']}, פעולה: ${order['סוג פעולה']}, תאריך: ${formatDate(order['תאריך הזמנה'])}, סטטוס: ${order._effectiveStatus}
            `;
        });

        emailBody += `
            \nבברכה,
            צוות ח. סבן חומרי בניין
        `;

        const recipientEmail = prompt("הזן כתובת אימייל לשליחת הדוח:");
        if (!recipientEmail || !recipientEmail.includes('@')) {
            showAlert('כתובת אימייל לא חוקית.', 'error');
            return;
        }

        showAlert('שולח דוח במייל... אנא המתן.', 'info');
        const response = await fetchData('sendReportEmail', {
            recipient: recipientEmail,
            subject: `דוח פעילות מכולות: ${formatDate(startDate || 'התחלה')} - ${formatDate(endDate || 'היום')}`,
            body: emailBody
        }, EMAIL_SCRIPT_URL); // Pass the email script URL specifically

        if (response.success) {
            showAlert('הדוח נשלח בהצלחה למייל!', 'success');
        } else {
            showAlert(response.message || 'שגיאה בשליחת הדוח.', 'error');
        }
    }


    // --- Scroll to Top Functionality ---
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

    window.onscroll = function() {
        if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
            scrollToTopBtn.style.display = "block";
            scrollToTopBtn.style.opacity = "1";
        } else {
            scrollToTopBtn.style.opacity = "0";
            setTimeout(() => { scrollToTopBtn.style.display = "none"; }, 300);
        }
    };

    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });
    }

    function scrollToOrdersTable() {
        document.getElementById('orders-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // --- New Function: Show Customer Profile ---
    function showCustomerProfile(customerName) {
        const customerOrders = allOrders.filter(o => o['שם לקוח'] === customerName);
        if (customerOrders.length === 0) {
            showAlert('לא נמצאו הזמנות עבור לקוח זה.', 'warning');
            return;
        }

        const openOrders = customerOrders.filter(o => o._effectiveStatus === 'פתוח').length;
        const overdueOrders = customerOrders.filter(o => o._effectiveStatus === 'חורג').length;
        const totalOrders = customerOrders.length;
        
        const lastOrder = customerOrders.sort((a,b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']))[0];
        const lastOrderDate = lastOrder ? formatDate(lastOrder['תאריך הזמנה']) : 'N/A';

        // Update modal title and stats
        document.getElementById('profile-customer-name').textContent = `פרופיל לקוח: ${customerName}`;
        const profileContent = document.getElementById('customer-profile-content');
        profileContent.innerHTML = `
            <div class="card p-6 bg-gray-50 border border-gray-200">
                <p class="text-sm font-medium text-gray-500">מספר הזמנות כולל</p>
                <p class="text-4xl font-bold text-gray-800 mt-2">${totalOrders}</p>
            </div>
            <div class="card p-6 bg-green-50 border border-green-200">
                <p class="text-sm font-medium text-green-700">הזמנות פתוחות כרגע</p>
                <p class="text-4xl font-bold text-green-800 mt-2">${openOrders}</p>
            </div>
            <div class="card p-6 bg-red-50 border border-red-200">
                <p class="text-sm font-medium text-red-700">הזמנות חורגות</p>
                <p class="text-4xl font-bold text-red-800 mt-2">${overdueOrders}</p>
            </div>
            <div class="card p-6 bg-blue-50 border border-blue-200">
                <p class="text-sm font-medium text-blue-700">תאריך הזמנה אחרונה</p>
                <p class="text-xl font-bold text-blue-800 mt-2">${lastOrderDate}</p>
            </div>
            <div class="card p-6 md:col-span-2">
                <h3 class="text-lg font-bold text-gray-800 mb-4">התפלגות סוגי פעולות</h3>
                <canvas id="profile-action-type-chart"></canvas>
            </div>
        `;
        
        // Render orders table in the profile modal
        const tableBody = document.querySelector('#customer-profile-orders-table tbody');
        tableBody.innerHTML = '';
        customerOrders.forEach(order => {
             const row = tableBody.insertRow();
             row.className = `border-b border-gray-200 cursor-pointer`;
             row.onclick = () => {
                 closeModal('customer-profile-modal');
                 showOrderDetailsModal(order.sheetRow);
             };
             row.innerHTML = `
                <td class="p-3">${formatDate(order['תאריך הזמנה'])}</td>
                <td class="p-3">${order['תעודה'] || ''}</td>
                <td class="p-3">${order['סוג פעולה'] || ''}</td>
                <td class="p-3"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3">${order._daysPassedCalculated || ''}</td>
                <td class="p-3">
                    <button class="action-icon-btn" onclick="event.stopPropagation(); printOrderDocument(allOrders.find(o => o.sheetRow === ${order.sheetRow}))" title="הדפס">
                        <i class="fas fa-print"></i>
                    </button>
                </td>
            `;
        });
        
        // Draw the chart
        drawCustomerProfileCharts(customerOrders);

        openModal('customer-profile-modal');
    }

    // --- New Function: Draw Customer Profile Charts ---
    function drawCustomerProfileCharts(orders) {
        if (charts.customerProfileActionChart) {
            charts.customerProfileActionChart.destroy();
        }

        const actionTypeData = orders.reduce((acc, order) => {
            const actionType = order['סוג פעולה'] || 'לא ידוע';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        const chartColors = {
            'הורדה': 'rgb(76, 175, 80)',
            'החלפה': 'rgb(255, 193, 7)',
            'העלאה': 'rgb(214, 69, 69)'
        };

        const ctx = document.getElementById('profile-action-type-chart').getContext('2d');
        charts.customerProfileActionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(actionTypeData),
                datasets: [{
                    data: Object.values(actionTypeData),
                    backgroundColor: Object.keys(actionTypeData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#2F4F4F'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- New Function: Update `renderOrdersTable` to include the customer profile link ---
    // The previous implementation of renderOrdersTable is now replaced with this.
    // The change is in the <td> for the customer name.
    function renderOrdersTable(ordersToRender) {
        const tableBody = document.querySelector('#orders-table tbody');
        tableBody.innerHTML = '';
        if (ordersToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-[var(--color-text-muted)]">אין הזמנות להצגה בסינון הנוכחי.</td></tr>`;
            return;
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            const actionTypeClass = order['סוג פעולה'] ? `action-type-${order['סוג פעולה']}` : '';
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer ${actionTypeClass}`;
            
            if (order._effectiveStatus === 'חורג') {
                row.classList.add('overdue-blinking');
            }

            row.dataset.sheetRow = order.sheetRow;
            row.onclick = (e) => {
                if (!e.target.closest('.action-icon-btn, .container-badge, .customer-name-link')) { 
                    showOrderDetailsModal(order.sheetRow);
                }
            };

            const containersTaken = String(order['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer hover:bg-[var(--color-primary)] hover:text-white transition-colors" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')"><i class="fas fa-box"></i> ${c.trim()}</span>`
            ).join(' ');

            const daysPassedHtml = order._effectiveStatus === 'חורג' ?
                `<span class="overdue-text-blinking">${order._daysPassedCalculated || ''}</span>` :
                `${order._daysPassedCalculated || ''}`;

            row.innerHTML = `
                <td class="p-3 font-medium" data-label="תאריך">${formatDate(order['תאריך הזמנה'])}</td>
                <td class="p-3 font-medium" data-label="תעודה">${order['תעודה'] || ''}</td>
                <td class="p-3 font-semibold customer-name-link cursor-pointer hover:text-[var(--color-primary)]" onclick="event.stopPropagation(); showCustomerProfile('${order['שם לקוח']}')" data-label="לקוח">${order['שם לקוח'] || ''}</td>
                <td class="p-3 font-medium" data-label="כתובת">${order['כתובת'] || ''}</td>
                <td class="p-3" data-label="סוג פעולה">${order['סוג פעולה'] || ''}</td>
                <td class="p-3" data-label="ימים שעברו">${daysPassedHtml}</td>
                <td class="p-3" data-label="מכולות">${containerHTML}</td>
                <td class="p-3" data-label="סטטוס"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3 whitespace-nowrap" data-label="פעולות">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="שלח WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="ערוך"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="שכפל"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    ${order._effectiveStatus !== 'סגור' ? `<button class="action-icon-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['תעודה']}')" title="סגור הזמנה"><i class="fas fa-check-circle text-[var(--color-success)]"></i></button>` : ''}
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['תעודה']}')" title="מחק"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </td>
            `;
        });
    }

    // --- New Function: Draw Customer Profile Charts ---
    function drawCustomerProfileCharts(orders) {
        if (charts.customerProfileActionChart) {
            charts.customerProfileActionChart.destroy();
        }

        const actionTypeData = orders.reduce((acc, order) => {
            const actionType = order['סוג פעולה'] || 'לא ידוע';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        const chartColors = {
            'הורדה': 'rgb(76, 175, 80)',
            'החלפה': 'rgb(255, 193, 7)',
            'העלאה': 'rgb(214, 69, 69)'
        };

        const ctx = document.getElementById('profile-action-type-chart').getContext('2d');
        charts.customerProfileActionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(actionTypeData),
                datasets: [{
                    data: Object.values(actionTypeData),
                    backgroundColor: Object.keys(actionTypeData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#2F4F4F'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Initial Application Load ---
    window.onload = () => {
        initializeTheme();
        loadOrders();
        populateWhatsAppTemplates();
    };

    // --- Printing Order Document (New Function) ---
    function printOrderDocument(order) {
        if (!order) {
            showAlert('לא ניתן להדפיס: פרטי הזמנה לא נמצאו.', 'error');
            return;
        }

        // Calculate overdue days
        const orderDate = new Date(order['תאריך הזמנה']);
        const today = new Date();
        const overdueDays = Math.max(0, Math.floor((today - orderDate) / (1000 * 60 * 60 * 24)));
        const isOverdue = overdueDays > 10; // Assuming 10 days is the threshold

        // Generate the HTML for the print document
        const printContent = `
            <div class="print-area-container ${isOverdue ? 'overdue-document' : ''}">
                <div class="header">
                    <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="לוגו חברה" class="logo">
                    <div class="text-left">
                        <p class="text-sm font-medium text-gray-700">תאריך: ${formatDate(today)}</p>
                        <p class="text-sm font-medium text-gray-700">מספר הזמנה: ${order['תעודה'] || 'N/A'}</p>
                    </div>
                </div>

                ${isOverdue ? `
                <div class="mb-4 text-center">
                    <h2 class="overdue-title">הזמנה חורגת</h2>
                </div>` : ''}

                <div class="details-grid">
                    <div class="detail-item">
                        <p><strong>שם לקוח:</strong> ${order['שם לקוח'] || ''}</p>
                        <p><strong>כתובת:</strong> ${order['כתובת'] || ''}</p>
                        <p><strong>טלפון:</strong> ${order['טלפון לקוח'] || ''}</p>
                    </div>
                    <div class="detail-item">
                        <p><strong>סוכן מכירות:</strong> ${order['שם סוכן'] || ''}</p>
                        <p><strong>תאריך הזמנה:</strong> ${formatDate(order['תאריך הזמנה'])}</p>
                        ${isOverdue ? `
                        <p><strong>מספר ימים חריגים:</strong> <span class="overdue-marker">${overdueDays}</span> ימים</p>
                        ` : ''}
                    </div>
                </div>

                <h3 class="section-title">פרטי הזמנה</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>תיאור פריט</th>
                                <th>כמות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    השכרת מכולה: ${order['מספר מכולה ירדה'] || 'N/A'}
                                    <br>
                                    <span class="text-sm text-gray-500">
                                        סוג פעולה: ${order['סוג פעולה'] || ''}
                                    </span>
                                </td>
                                <td>1</td>
                            </tr>
                            ${isOverdue ? `
                            <tr>
                                <td class="text-red-600 font-bold">תוספת עבור חריגה בימים</td>
                                <td>1</td>
                            </tr>` : ''}
                        </tbody>
                    </table>
                </div>

                <div class="mt-6">
                    <h3 class="section-title">הערות</h3>
                    <div class="detail-item">
                        <p>${order['הערות'] || ''}</p>
                        ${isOverdue ? `<p class="mt-2 text-red-600 font-bold">הערה חשובה: בשל חריגה מהמועד המקורי, יש לתאם פינוי בהקדם.</p>` : ''}
                    </div>
                </div>

                <div class="footer">
                    <p>ח. סבן חומרי בניין בע"מ | רח' המלאכה 10, הרצליה | טל: 09-1234567 | אימייל: info@hsaban.co.il</p>
                    <p>© ${new Date().getFullYear()} כל הזכויות שמורות.</p>
                </div>
            </div>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>הדפסת מסמך הזמנה</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap');
            body { font-family: 'Rubik', sans-serif; background-color: #ffffff; margin: 0; padding: 0; }
            .print-area-container {
                direction: rtl; 
                text-align: right; 
                margin: 0 auto; 
                max-width: 800px;
                padding: 2rem;
                box-sizing: border-box;
            }
            .overdue-document {
                border: 2px solid #dc2626; /* Add a red border for overdue documents */
                padding: 1.5rem;
                box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
            }
            .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem; }
            .logo { max-width: 150px; height: auto; }
            .overdue-title { font-size: 1.75rem; color: #dc2626 !important; -webkit-print-color-adjust: exact; text-shadow: none; font-weight: 700; }
            .overdue-marker { font-weight: 700; color: #dc2626 !important; -webkit-print-color-adjust: exact; background-color: #fef2f2; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
            .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
            .detail-item { background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem; }
            .detail-item strong { color: #475569; }
            .section-title { font-size: 1.5rem; font-weight: 600; color: #334155; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; }
            .table-container { border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
            table { width: 100%; border-collapse: collapse; text-align: right; }
            th, td { padding: 1rem; border-bottom: 1px solid #e2e8f0; }
            th { background-color: #e2e8f0; font-weight: 600; color: #334155; }
            .footer { margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 0.875rem; }
            /* Hide non-print elements */
            @media print {
                body * { visibility: hidden; }
                .print-area-container, .print-area-container * { visibility: visible; }
                .print-area-container { position: absolute; left: 0; top: 0; width: 100%; box-sizing: border-box; }
            }
        `);
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }
</script>

</body>
</html>
