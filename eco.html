<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª CRM ××ª×§×“××ª ×œ× ×™×”×•×œ ×©×›×™×¨×•×ª ××›×•×œ×•×ª</title>
    
    <!-- Chosen Palette: Calm Neutral Harmony (Green, Blue, White) -->
    <!-- Application Structure Plan: The application retains the highly effective three-section structure: Dashboard, Container Inventory, and Treatment Board. Now with an added Reports section. This structure provides a clear user flow, starting with a high-level overview (Dashboard), allowing for detailed asset management (Inventory), focusing on actionable items (Treatment Board), and offering analytical insights (Reports). The main interactions involve filtering the central data table from KPI cards and charts, managing orders through modals, and using a drag-and-drop Kanban board for workflow. This task-oriented design was chosen because it aligns perfectly with the typical workflow of a rental manager, prioritizing clarity, efficiency, and quick access to critical information. -->
    <!-- Visualization & Content Choices: 
        - Dashboard KPIs: Goal: Inform. Method: Styled HTML cards. Interaction: Click to filter main table. Justification: Provides a quick, scannable summary of key business metrics.
        - Charts: Goal: Compare/Show Proportions/Trend. Method: Bar/Doughnut Charts (Chart.js on Canvas). Interaction: Click to filter table. Justification: Effective for visualizing distributions and comparisons.
        - Main Orders Table: Goal: Organize/Inform. Method: Interactive HTML Table. Interaction: Sort, search, filter, click row for details modal. Justification: Standard and effective method for displaying detailed tabular data.
        - Treatment Board: Goal: Organize/Manage Workflow. Method: HTML/CSS Kanban Board. Interaction: Drag-and-drop cards to update status. Justification: Highly intuitive and visual method for managing tasks and their lifecycle.
        - Reports Page: Goal: Analyze/Summarize. Method: Dynamic tables and interactive charts with date filtering. Justification: Provides deep insights into historical data.
    -->
    <!-- CONFIRMATION: NO SVG graphics used directly in HTML outside icons. NO Mermaid JS used. -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Global Variables for a Green, Blue, and White Palette */
        :root {
            --color-background: #E6F0E6; /* Light green-white */
            --color-surface: #FFFFFF;
            --color-primary: #2E8B57; /* Sea Green */
            --color-primary-light: #4CAF50; /* Brighter Green */
            --color-secondary: #A8D8B9; /* Lighter Green */
            --color-accent: #2196F3; /* Bright Blue for accent */
            --color-text-base: #2F4F4F; /* Dark Slate Gray */
            --color-text-muted: #607D8B; /* Blue-Grey */
            --color-border: #CFD8DC; /* Light Blue-Grey */
            --color-danger: #D64545; /* Red (for errors/overdue) */
            --color-warning: #FFC107; /* Amber (for warnings) */
            --color-success: #4CAF50; /* Green (for success) */
            --color-info: #2196F3; /* Blue (for info) */

            --font-main: 'Rubik', sans-serif;
        }

        /* Dark Mode adjustments */
        body.dark {
            --color-background: #1A3E4A; /* Darker blue-green */
            --color-surface: #294F5E; /* Darker blue-green surface */
            --color-primary: #5AB27F; /* Lighter sea green for dark mode */
            --color-primary-light: #7ED093;
            --color-secondary: #4A7A89;
            --color-accent: #64B5F6; /* Lighter blue */
            --color-text-base: #E0F2F7; /* Light text */
            --color-text-muted: #9BB8C5;
            --color-border: #3A6B7C;
            --color-danger: #F44336;
            --color-warning: #FFD54F;
            --color-success: #66BB6A;
            --color-info: #42A5F5;
        }

        /* General body styling */
        body {
            font-family: var(--font-main);
            background-color: var(--color-background);
            color: var(--color-text-base);
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
            line-height: 1.6;
        }
        
        /* Eco-friendly background elements (emojis for flair) */
        .eco-background-header {
            text-align: center;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        .eco-background-header span {
            font-size: 2.5rem; /* Larger emojis */
            margin: 0 0.5rem;
            display: inline-block;
            animation: float 6s ease-in-out infinite; /* Subtle floating animation */
        }
        .eco-background-header span:nth-child(2) { animation-delay: 1s; }
        .eco-background-header span:nth-child(3) { animation-delay: 2s; }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        /* Button styling */
        .btn {
            padding: 0.85rem 1.8rem;
            border-radius: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: 1px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            background-image: linear-gradient(to right, var(--color-primary), var(--color-primary-light));
            box-shadow: 0 6px 20px -5px rgba(46, 139, 87, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px -8px rgba(46, 139, 87, 0.6);
            background-image: linear-gradient(to left, var(--color-primary), var(--color-primary-light));
        }

        .btn-secondary {
            background-color: var(--color-surface);
            color: var(--color-text-base);
            border-color: var(--color-border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }
        body.dark .btn-secondary {
             color: var(--color-text-base);
        }
        .btn-secondary:hover {
            background-color: var(--color-background);
            border-color: var(--color-primary-light);
            color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
        }
        
        /* Card styling */
        .card {
            background-color: var(--color-surface);
            border-radius: 1.25rem;
            border: 1px solid var(--color-border);
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        /* Navigation tabs styling */
        .nav-tab-btn {
            font-size: 1.05rem;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: var(--color-text-muted);
            transition: all 0.3s ease;
        }
        .nav-tab-btn.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
            font-weight: 600;
            transform: translateY(-2px);
        }
        .nav-tab-btn:hover:not(.active) {
            color: var(--color-primary);
            background-color: var(--color-border);
        }
        
        /* Modal styling */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 1.5rem;
            box-shadow: 0 15px 45px rgba(0,0,0,0.25);
            border: 1px solid var(--color-border);
            transform: scale(0.9);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Input, Select, Textarea styling */
        input, select, textarea {
            background-color: var(--color-background);
            border-color: var(--color-border);
            border-radius: 0.8rem;
            transition: all 0.25s ease;
            padding: 0.75rem 1rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(46, 139, 87, 0.25);
            background-color: var(--color-surface);
        }
        
        /* Table styling */
        th {
            background-color: var(--color-background);
            font-weight: 600;
            padding: 1rem;
            text-align: right;
        }
        td {
            padding: 0.9rem;
        }
        
        tr:hover:not(.no-hover) {
            background-color: var(--color-border);
        }
        body.dark tr:hover:not(.no-hover) {
            background-color: var(--color-surface);
        }
        
        /* Status indicators */
        .status-open { color: var(--color-success); font-weight: 700; }
        .status-closed { color: var(--color-text-muted); }
        .status-overdue { color: var(--color-danger); font-weight: 700; }
        .status-pending { color: var(--color-info); font-weight: 700; }
        .status-warning { color: var(--color-warning); font-weight: 700; }
        
        /* Action type specific styling */
        .action-type-×”×•×¨×“×” { background-color: rgba(76, 175, 80, 0.1); } /* Light green */
        body.dark .action-type-×”×•×¨×“×” { background-color: rgba(102, 187, 106, 0.1); }
        .action-type-×”×—×œ×¤×” { background-color: rgba(255, 193, 7, 0.1); } /* Light yellow/gold */
        body.dark .action-type-×”×—×œ×¤×” { background-color: rgba(255, 215, 80, 0.1); }
        .action-type-×”×¢×œ××” { background-color: rgba(214, 69, 69, 0.1); } /* Light red */
        body.dark .action-type-×”×¢×œ××” { background-color: rgba(244, 67, 54, 0.1); }

        /* Overdue blinking effect (full row) */
        .overdue-blinking {
            animation: pulse-border 1.8s infinite alternate;
        }
        @keyframes pulse-border {
            from { box-shadow: 0 0 0 0 rgba(214, 69, 69, 0.4); }
            to { box-shadow: 0 0 0 6px rgba(214, 69, 69, 0.0); }
        }

        /* Overdue blinking effect (text) */
        .overdue-text-blinking {
            animation: text-pulse-red 1.8s infinite alternate;
            font-weight: 700;
        }
        @keyframes text-pulse-red {
            from { color: var(--color-danger); text-shadow: 0 0 4px rgba(214, 69, 69, 0.4); }
            to { color: #FF0000; text-shadow: 0 0 8px rgba(255, 0, 0, 0.8); }
        }


        /* Chart container */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }

        /* Action icon buttons */
        .action-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            padding: 0.4rem;
            margin: 0 0.2rem;
            transition: transform 0.25s ease-in-out, color 0.25s ease-in-out;
            border-radius: 50%;
        }
        .action-icon-btn:hover {
            transform: scale(1.3);
            background-color: rgba(0,0,0,0.05);
        }
        body.dark .action-icon-btn:hover {
            background-color: rgba(255,255,255,0.08);
        }
        
        /* Typing effect for message input */
        .typing-effect::after {
            content: '|';
            animation: blink-caret 0.75s step-end infinite;
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--color-primary); }
        }

        /* Scroll to top button */
        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--color-primary);
            color: white;
            cursor: pointer;
            padding: 18px;
            border-radius: 50%;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transition: background-color 0.3s, opacity 0.3s, transform 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: var(--color-primary-light);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* Loader styling */
        #loader-overlay {
            transition: opacity 0.3s ease;
        }
        #loader-overlay > div {
            border-top-color: var(--color-primary);
        }

        /* Kanban column title blinking effect */
        .neon-blinking-border-title {
            animation: neon-pulse-strong 1.8s infinite alternate;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.6), 0 0 20px rgba(255, 0, 0, 0.4);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 1rem;
            padding: 1rem;
            background-color: rgba(255, 0, 0, 0.05);
            color: #FF0000;
        }

        @keyframes neon-pulse-strong {
            0% {
                box-shadow: 0 0 5px rgba(255, 0, 0, 0.4), 0 0 15px rgba(255, 0, 0, 0.2);
                border-color: rgba(255, 0, 0, 0.3);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.6);
                border-color: rgba(255, 0, 0, 0.8);
            }
        }
        /* Kanban item styling */
        .kanban-item {
            font-weight: 500;
        }
        .kanban-item .font-bold {
            font-weight: 700;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                box-sizing: border-box;
                font-family: 'Rubik', sans-serif;
                color: black; /* Ensure black text on print */
            }
            #print-area img {
                max-width: 150px;
                margin-bottom: 20px;
            }
            #print-area h1 {
                font-size: 24px;
                color: #2F4F4F;
                margin-bottom: 20px;
            }
            #print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            #print-area th, #print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: right;
            }
            #print-area th {
                background-color: #f2f2f2;
            }
        }

        /* Mobile specific adjustments (example for responsiveness) */
        @media (max-width: 768px) {
            .nav-tab-btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.8rem;
            }
            .btn {
                padding: 0.7rem 1.4rem;
                font-size: 0.95rem;
            }
            .modal-content {
                border-radius: 1rem;
                padding: 1rem;
            }
            .table-auto th, .table-auto td {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            /* Adjust table layout for small screens if too many columns */
            #orders-table thead, #orders-table tbody, #orders-table th, #orders-table td, #orders-table tr { 
                display: block; 
            }
            #orders-table thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            #orders-table tr { 
                border: 1px solid var(--color-border);
                margin-bottom: 0.5rem;
                border-radius: 0.75rem;
                padding: 0.75rem;
            }
            #orders-table td { 
                border: none;
                position: relative;
                padding-left: 50%; 
                text-align: left;
            }
            #orders-table td:before { 
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%; 
                padding-right: 10px; 
                white-space: nowrap;
                content: attr(data-label);
                font-weight: 600;
                color: var(--color-text-muted);
            }
            /* Specific labels for mobile table columns */
            #orders-table td:nth-of-type(1):before { content: "×ª××¨×™×š"; }
            #orders-table td:nth-of-type(2):before { content: "×ª×¢×•×“×”"; }
            #orders-table td:nth-of-type(3):before { content: "×œ×§×•×—"; }
            #orders-table td:nth-of-type(4):before { content: "×›×ª×•×‘×ª"; }
            #orders-table td:nth-of-type(5):before { content: "×¡×•×’ ×¤×¢×•×œ×”"; }
            #orders-table td:nth-of-type(6):before { content: "×™××™× ×©×¢×‘×¨×•"; }
            #orders-table td:nth-of-type(7):before { content: "××›×•×œ×•×ª"; }
            #orders-table td:nth-of-type(8):before { content: "×¡×˜×˜×•×¡"; }
            #orders-table td:nth-of-type(9):before { content: "×¤×¢×•×œ×•×ª"; }
            
            .kanban-item {
                font-size: 0.9rem;
                padding: 0.8rem;
            }
            .kanban-item .action-icon-btn {
                font-size: 1.2rem;
                padding: 0.2rem;
            }
        }
        /* New styles for customer profile modal to prevent stretching */
        .profile-card-container {
            max-height: 40vh; /* Set a max height for the cards container */
            overflow-y: auto; /* Enable vertical scrolling */
            -webkit-overflow-scrolling: touch;
        }
        .customer-profile-chart-container {
            height: 300px;
            max-height: 300px;
        }
        .customer-profile-orders-container {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Fix for scrollable table headers */
        .customer-profile-orders-container table thead {
            position: sticky;
            top: 0;
            background-color: var(--color-background);
            z-index: 10;
        }
        
    </style>
</head>
<body class="text-base">

    <!-- Loader Overlay -->
    <div id="loader-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-[1000] opacity-0 pointer-events-none">
        <div class="w-20 h-20 border-6 border-t-6 border-gray-200 border-t-[var(--color-primary)] rounded-full animate-spin"></div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="fixed bottom-6 left-6 z-[1100] space-y-4"></div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-[var(--color-primary)]">×”×•×¡×£ ×”×–×× ×” ×—×“×©×”</h2>
                <button onclick="closeModal('order-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <form id="order-form" class="space-y-5 overflow-y-auto">
                 <div>
                    <label for="×ª××¨×™×š ×”×–×× ×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª××¨×™×š ×”×–×× ×”</label>
                    <input type="date" id="×ª××¨×™×š ×”×–×× ×”" name="×ª××¨×™×š ×”×–×× ×”" class="w-full p-2 border" required>
                </div>
                <div>
                    <label for="×ª×¢×•×“×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª×¢×•×“×”</label>
                    <input type="text" id="×ª×¢×•×“×”" name="×ª×¢×•×“×”" class="w-full p-2 border" required>
                </div>
                <div>
                    <label for="×©× ×¡×•×›×Ÿ" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×©× ×¡×•×›×Ÿ</label>
                    <input type="text" id="×©× ×¡×•×›×Ÿ" name="×©× ×¡×•×›×Ÿ" class="w-full p-2 border" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="×©× ×œ×§×•×—" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×©× ×œ×§×•×—</label>
                        <input type="text" id="×©× ×œ×§×•×—" name="×©× ×œ×§×•×—" class="w-full p-2 border" required onblur="checkCustomerExistenceAndAutofill()">
                    </div>
                    <div>
                        <label for="×›×ª×•×‘×ª" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×›×ª×•×‘×ª</label>
                        <input type="text" id="×›×ª×•×‘×ª" name="×›×ª×•×‘×ª" class="w-full p-2 border" required onblur="checkCustomerExistenceAndAutofill()">
                    </div>
                </div>
                <div>
                    <label for="×˜×œ×¤×•×Ÿ ×œ×§×•×—" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×˜×œ×¤×•×Ÿ ×œ×§×•×—</label>
                    <input type="tel" id="×˜×œ×¤×•×Ÿ ×œ×§×•×—" name="×˜×œ×¤×•×Ÿ ×œ×§×•×—" class="w-full p-2 border" onblur="checkCustomerExistenceAndAutofill()">
                </div>
                <div>
                    <label for="×¡×•×’ ×¤×¢×•×œ×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×¡×•×’ ×¤×¢×•×œ×”</label>
                    <select id="×¡×•×’ ×¤×¢×•×œ×”" name="×¡×•×’ ×¤×¢×•×œ×”" class="w-full p-2 border" required onchange="handleActionTypeChange()">
                        <option value="×”×•×¨×“×”">×”×•×¨×“×”</option>
                        <option value="×”×¢×œ××”">×”×¢×œ××”</option>
                        <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="container-taken-div">
                        <label for="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”</label>
                        <input type="text" id="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" name="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" class="w-full p-2 border">
                    </div>
                    <div id="container-brought-div" class="hidden">
                        <label for="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”</label>
                        <input type="text" id="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" name="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" class="w-full p-2 border">
                    </div>
                </div>
                <div>
                    <label for="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™</label>
                    <input type="date" id="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" name="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" class="w-full p-2 border">
                </div>
                <div>
                    <label for="×”×¢×¨×•×ª" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×”×¢×¨×•×ª</label>
                    <textarea id="×”×¢×¨×•×ª" name="×”×¢×¨×•×ª" rows="3" class="w-full p-2 border"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-[var(--color-border)]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('order-modal')">×‘×™×˜×•×œ</button>
                    <button type="submit" class="btn btn-primary">×©××•×¨ ×”×–×× ×”</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">××™×©×•×¨ ××—×™×§×”</h2>
            <p class="mb-6 text-[var(--color-text-muted)]">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×–×× ×” ××¡×¤×¨ <span id="delete-order-id" class="font-bold"></span>? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="btn btn-secondary" onclick="closeModal('delete-confirm-modal')">×‘×™×˜×•×œ</button>
                <button type="button" class="btn bg-[var(--color-danger)] text-white" id="confirm-delete-btn">××—×§</button>
            </div>
        </div>
    </div>

    <!-- Autofill Confirmation Modal -->
    <div id="autofill-confirm-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 id="autofill-customer-name-display" class="text-xl font-bold mb-4 text-[var(--color-primary)]"></h2>
            <p id="autofill-message" class="mb-6 text-[var(--color-text-muted)]"></p>
            <div class="flex justify-center gap-4">
                <button type="button" class="btn btn-primary" onclick="confirmAutofill(true)">×›×Ÿ âœ…</button>
                <button type="button" class="btn btn-secondary" onclick="confirmAutofill(false)">×œ× âŒ</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">×¤×¨×˜×™ ×”×–×× ×” <span id="details-order-id"></span></h2>
                <button onclick="closeModal('order-details-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div id="order-details-content" class="space-y-3 overflow-y-auto text-[var(--color-text-base)] text-lg">
                <!-- Details will be populated here -->
            </div>
            <div class="flex justify-between items-center p-5 border-t border-[var(--color-border)] mt-4">
                <!-- New Share and Print Buttons -->
                <div class="flex gap-3">
                    <button type="button" class="btn btn-primary" onclick="shareOrderDetailsOnWhatsApp()" title="×©×ª×£ ×‘×•×•××˜×¡××¤">
                        <i class="fab fa-whatsapp"></i> ×©×ª×£
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="printOrderDetails()" title="×”×“×¤×¡ ×›×¨×˜×™×¡ ×œ×§×•×—">
                        <i class="fas fa-print"></i> ×”×“×¤×¡
                    </button>
                </div>
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary" onclick="editOrderFromDetails()">×¢×¨×•×š ğŸ“</button>
                    <button type="button" class="btn bg-[var(--color-danger)] text-white" onclick="deleteOrderFromDetails()">××—×§ ğŸ—‘ï¸</button>
                    <button type="button" class="btn btn-primary" onclick="duplicateOrderFromDetails()">×©×›×¤×œ ğŸ“‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container History Modal -->
    <div id="container-history-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-3xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">×”×™×¡×˜×•×¨×™×™×ª ××›×•×œ×”: <span id="history-container-number"></span></h2>
                <button onclick="closeModal('container-history-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr>
                            <th class="p-3">×ª×¢×•×“×”</th>
                            <th class="p-3">×©× ×œ×§×•×—</th>
                            <th class="p-3">×›×ª×•×‘×ª</th>
                            <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                            <th class="p-3">×ª××¨×™×š ×”×ª×—×œ×”</th>
                            <th class="p-3">×ª××¨×™×š ×¡×™×•× (×¦×¤×•×™/×‘×¤×•×¢×œ)</th>
                            <th class="p-3">××©×š ×©×”×™×™×” (×™××™×)</th>
                        </tr>
                    </thead>
                    <tbody id="container-history-table-body">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
                <div id="no-container-history" class="text-center text-gray-500 mt-6 hidden text-lg">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×–××™× ×” ×œ××›×•×œ×” ×–×•.</div>
            </div>
        </div>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col p-6">
            <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
                <h2 class="text-2xl font-bold text-[var(--color-primary)]">×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ×œ×§×•×—: <span id="history-customer-name"></span></h2>
                <button onclick="closeModal('customer-history-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr>
                            <th class="p-3">×ª××¨×™×š ×”×–×× ×”</th>
                            <th class="p-3">×ª×¢×•×“×”</th>
                            <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                            <th class="p-3">××›×•×œ×” ×™×¨×“×”</th>
                            <th class="p-3">××›×•×œ×” ×¢×œ×ª×”</th>
                            <th class="p-3">×¡×˜×˜×•×¡</th>
                            <th class="p-3">×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="customer-history-table-body">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
                <div id="no-customer-history" class="text-center text-gray-500 mt-6 hidden text-lg">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×–××™× ×” ×œ×œ×§×•×— ×–×”.</div>
            </div>
            <!-- New Share and Print Buttons -->
            <div class="flex justify-center gap-3 p-5 border-t border-[var(--color-border)] mt-4">
                <button type="button" class="btn btn-primary" onclick="shareCustomerHistoryOnWhatsApp()" title="×©×ª×£ ×”×™×¡×˜×•×¨×™×™×ª ×œ×§×•×— ×‘×•×•××˜×¡××¤">
                    <i class="fab fa-whatsapp"></i> ×©×ª×£
                </button>
                <button type="button" class="btn btn-secondary" onclick="printCustomerHistory()" title="×”×“×¤×¡ ×”×™×¡×˜×•×¨×™×™×ª ×œ×§×•×—">
                    <i class="fas fa-print"></i> ×”×“×¤×¡
                </button>
            </div>
        </div>
    </div>

    <!-- Close Order Modal -->
    <div id="close-order-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">×¡×’×™×¨×ª ×”×–×× ×” <span id="close-order-id-display"></span></h2>
            <p class="mb-4 text-[var(--color-text-muted)]">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¡×’×•×¨ ×”×–×× ×” ×–×•?</p>
            <div>
                <label for="close-order-notes" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×”×¢×¨×•×ª ×¡×’×™×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
                <textarea id="close-order-notes" rows="3" class="w-full p-2 border rounded-lg"></textarea>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" class="btn btn-secondary" onclick="closeModal('close-order-modal')">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="confirm-close-order-btn">××©×¨ ×¡×’×™×¨×” âœ…</button>
            </div>
        </div>
    </div>
    
    <!-- Main Page Structure -->
    <div class="min-h-screen flex flex-col">
        <header class="p-6 text-center border-b border-[var(--color-border)] bg-white shadow-sm relative">
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-2">
                <!-- Company Logo -->
                <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="Company Logo" class="h-16 rounded-lg shadow-md border border-[var(--color-border)]">
                <h1 class="text-3xl md:text-4xl font-bold text-[var(--color-primary)] mt-2 md:mt-0">××¢×¨×›×ª CRM ××ª×§×“××ª ×œ× ×™×”×•×œ ×©×›×™×¨×•×ª ××›×•×œ×•×ª</h1>
            </div>
            <p class="text-lg text-[var(--color-text-muted)] mb-4">× ×™×”×•×œ ×§×œ ×•×™×¢×™×œ ×©×œ ×›×œ ×”×–×× ×•×ª ×”××›×•×œ×•×ª</p>
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="absolute top-5 left-5 text-2xl p-3 rounded-full hover:bg-[var(--color-border)] transition-colors duration-300">
                <i class="fas fa-sun"></i>
            </button>
        </header>

        <!-- Main Navigation Tabs -->
        <div class="flex justify-center p-4">
            <nav class="card flex gap-3 p-3 shadow-lg flex-wrap justify-center">
                <button id="nav-dashboard" class="nav-tab-btn active" onclick="showPage('dashboard')">
                    <i class="fas fa-chart-pie mr-2"></i>×œ×•×— ××—×•×•× ×™×
                </button>
                <button id="nav-container-inventory" class="nav-tab-btn" onclick="showPage('container-inventory')">
                    <i class="fas fa-boxes-stacked mr-2"></i>××œ××™ ××›×•×œ×•×ª
                </button>
                <button id="nav-treatment-board" class="nav-tab-btn" onclick="showPage('treatment-board')">
                    <i class="fas fa-clipboard-list mr-2"></i>×œ×•×— ×˜×™×¤×•×œ
                </button>
                <button id="nav-whatsapp-alerts" class="nav-tab-btn" onclick="showPage('whatsapp-alerts')">
                    <i class="fab fa-whatsapp mr-2"></i>×”×ª×¨××•×ª WhatsApp
                </button>
                <button id="nav-reports" class="nav-tab-btn" onclick="showPage('reports')">
                    <i class="fas fa-chart-line mr-2"></i>×“×•×—×•×ª
                </button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page-content space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×¡×§×™×¨×” ×›×œ×œ×™×ª ğŸ“Š</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">×›××Ÿ × ×™×ª×Ÿ ×œ×¨××•×ª ××ª ×”× ×ª×•× ×™× ×”××¨×›×–×™×™× ×©×œ ×”××¢×¨×›×ª, ×œ× ×”×œ ×”×–×× ×•×ª ×§×™×™××•×ª ×•×œ×™×¦×•×¨ ×—×“×©×•×ª.</p>
                    <div class="eco-background-header">
                        <span>ğŸŒ±</span>
                        <span>ğŸŒ</span>
                        <span>ğŸŒ³</span>
                    </div>
                </div>
                <!-- Quick Action Buttons -->
                <div class="flex flex-col md:flex-row justify-center items-center gap-5 flex-wrap">
                    <button class="btn btn-primary" onclick="openOrderModal('add')">
                        <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×–×× ×” ×—×“×©×”
                    </button>
                    <button class="btn bg-[var(--color-danger)] text-white hover:bg-[var(--color-danger)] hover:opacity-90" onclick="filterTable('×—×•×¨×’', null, true); scrollToOrdersTable();">
                        <i class="fas fa-triangle-exclamation"></i> ×”×¦×’ ×”×–×× ×•×ª ×—×•×¨×’×•×ª
                        <span id="overdue-customers-badge" class="ml-2 bg-white text-[var(--color-danger)] px-3 py-1 rounded-full text-sm font-bold shadow-sm">0</span>
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> ×¨×¢× ×Ÿ × ×ª×•× ×™×
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable('×¤×ª×•×—', null, true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×–×× ×•×ª ×¤×ª×•×—×•×ª<p id="open-orders-count" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-box-open text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable('×—×•×¨×’', null, true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×–×× ×•×ª ×—×•×¨×’×•×ª<p id="overdue-orders-count" class="text-4xl font-bold text-[var(--color-danger)] mt-2">0</p></div><i class="fas fa-triangle-exclamation text-4xl text-[var(--color-danger)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '××›×•×œ×” ×‘×©×™××•×©', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">××›×•×œ×•×ª ×‘×©×™××•×©<p id="containers-in-use" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-truck-moving text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×œ×§×•×— ×¤×¢×™×œ', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×œ×§×•×—×•×ª ×¤×¢×™×œ×™×<p id="active-customers-count" class="text-4xl font-bold text-[var(--color-primary)] mt-2">0</p></div><i class="fas fa-users text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                </div>

                <!-- Action Type Buttons Row -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×”×•×¨×“×”', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×•×¨×“×”<p id="action-type-×”×•×¨×“×”-count" class="text-4xl font-bold text-[var(--color-success)] mt-2">0</p></div><i class="fas fa-download text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×”×—×œ×¤×”', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×—×œ×¤×”<p id="action-type-×”×—×œ×¤×”-count" class="text-4xl font-bold text-[var(--color-warning)] mt-2">0</p></div><i class="fas fa-exchange-alt text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                    <button class="card p-6 flex items-center justify-between" onclick="filterTable(null, '×”×¢×œ××”', true); scrollToOrdersTable();">
                        <div class="font-semibold text-lg">×”×¢×œ××”<p id="action-type-×”×¢×œ××”-count" class="text-4xl font-bold text-[var(--color-danger)] mt-2">0</p></div><i class="fas fa-upload text-4xl text-[var(--color-secondary)]"></i>
                    </button>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">××›×•×œ×•×ª ×‘×©×™××•×© ×œ×¤×™ ×œ×§×•×—</h3>
                        <div class="chart-container">
                            <canvas id="chart-containers-by-customer"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">×”×ª×¤×œ×’×•×ª ×”×–×× ×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡</h3>
                        <div class="chart-container">
                            <canvas id="chart-status-pie"></canvas>
                        </div>
                    </div>
                    <!-- New Action Type Chart -->
                    <div class="card p-6 lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">×”×ª×¤×œ×’×•×ª ×”×–×× ×•×ª ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×”</h3>
                        <div class="chart-container">
                            <canvas id="chart-action-type"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Main Orders List -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-[var(--color-text-base)]">×¨×©×™××ª ×”×–×× ×•×ª ğŸ“‹</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
                        <input type="text" id="search-input" placeholder="×—×™×¤×•×© ×—×•×¤×©×™ (×ª×¢×•×“×”, ×œ×§×•×—, ×›×ª×•×‘×ª, ××›×•×œ×”)..." class="flex-grow p-3 border text-lg" onkeyup="filterTable()">
                        
                        <!-- New Filters -->
                        <select id="filter-status-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                            <option value="×¤×ª×•×—">×¤×ª×•×—</option>
                            <option value="×—×•×¨×’">×—×•×¨×’</option>
                            <option value="×¡×’×•×¨">×¡×’×•×¨</option>
                        </select>
                        <select id="filter-action-type-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">×›×œ ×¡×•×’×™ ×”×¤×¢×•×œ×•×ª</option>
                            <option value="×”×•×¨×“×”">×”×•×¨×“×”</option>
                            <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                            <option value="×”×¢×œ××”">×”×¢×œ××”</option>
                        </select>
                        <select id="filter-agent-select" class="p-3 border rounded-lg text-lg" onchange="filterTable()">
                            <option value="all">×›×œ ×”×¡×•×›× ×™×</option>
                            <!-- Agents will be populated by JS -->
                        </select>
                        <button class="btn btn-secondary" onclick="resetTableFilters()">
                            <i class="fas fa-filter-circle-xmark mr-2"></i>××™×¤×•×¡ ×¡×™× ×•×Ÿ
                        </button>
                        <div class="flex items-center gap-2">
                            <label for="show-closed-orders" class="text-sm font-medium text-[var(--color-text-muted)]">×”×¦×’ ×¡×’×•×¨×•×ª</label>
                            <input type="checkbox" id="show-closed-orders" onchange="filterTable()" class="w-5 h-5 text-[var(--color-primary)] bg-gray-100 rounded border-gray-300 focus:ring-[var(--color-primary)]">
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-[var(--color-border)]">
                        <table id="orders-table" class="w-full text-right table-auto">
                            <thead class="bg-[var(--color-background)] border-b-2 border-[var(--color-border)] sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">×ª××¨×™×š</th>
                                    <th class="p-3">×ª×¢×•×“×”</th>
                                    <th class="p-3">×œ×§×•×—</th>
                                    <th class="p-3">×›×ª×•×‘×ª</th>
                                    <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                                    <th class="p-3">×™××™× ×©×¢×‘×¨×•</th>
                                    <th class="p-3">××›×•×œ×•×ª</th>
                                    <th class="p-3">×¡×˜×˜×•×¡</th>
                                    <th class="p-3">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Container Inventory Page -->
            <section id="container-inventory-page" class="page-content hidden space-y-10">
                 <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">× ×™×”×•×œ ××œ××™ ××›×•×œ×•×ª ğŸ“¦</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">×¢×§×•×‘ ××—×¨ ×”××™×§×•× ×•×”×–××™× ×•×ª ×©×œ ×›×œ ×”××›×•×œ×•×ª ×‘××¢×¨×›×ª.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-[var(--color-danger)]">××›×•×œ×•×ª ×‘×©×™××•×©</h3>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-[var(--color-border)]">
                            <table id="containers-in-use-table" class="w-full text-right table-auto">
                                <thead class="bg-[var(--color-background)] sticky top-0 z-10"><tr><th class="p-3">××¡×¤×¨</th><th class="p-3">×œ×§×•×—</th><th class="p-3">×ª××¨×™×š</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-[var(--color-success)]">××›×•×œ×•×ª ×¤× ×•×™×•×ª</h3>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-[var(--color-border)]">
                            <table id="containers-available-table" class="w-full text-right table-auto">
                                <thead class="bg-[var(--color-background)] sticky top-0 z-10"><tr><th class="p-3">××¡×¤×¨</th><th class="p-3">×ª××¨×™×š ×”×ª×¤× ×•×ª</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Treatment Board Page -->
            <section id="treatment-board-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×œ×•×— ×˜×™×¤×•×œ Kanban ğŸ› ï¸</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">× ×”×œ ××ª ×”×”×–×× ×•×ª ×”×“×•×¨×©×•×ª ×˜×™×¤×•×œ ×‘×××¦×¢×•×ª ×’×¨×™×¨×” ×•×©×—×¨×•×¨ ×‘×™×Ÿ ×”×¡×˜×˜×•×¡×™× ×”×©×•× ×™×.</p>
                </div>
                <div id="no-treatment-orders" class="text-center text-xl text-[var(--color-text-muted)] hidden p-8 card">××™×Ÿ ×”×–×× ×•×ª ×œ×˜×™×¤×•×œ ×›×¨×’×¢. ×›×œ ×”×›×‘×•×“! ğŸ‰</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="column-overdue" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-danger)] mb-4 pb-2 border-b border-[var(--color-border)] neon-blinking-border-title">×œ×§×•×—×•×ª ×—×•×¨×’×™× ×©×¦×¨×™×›×™× ×˜×™×¤×•×œ ğŸš¨</h3>
                    </div>
                    <div id="column-in-progress" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-info)] mb-4 pb-2 border-b border-[var(--color-border)]">×‘×˜×™×¤×•×œ âš™ï¸</h3>
                    </div>
                    <div id="column-resolved" ondrop="drop(event)" ondragover="allowDrop(event)" class="p-5 rounded-xl bg-[var(--color-surface)] space-y-4 min-h-[300px] border border-[var(--color-border)] shadow-inner">
                        <h3 class="font-bold text-xl text-center text-[var(--color-success)] mb-4 pb-2 border-b border-[var(--color-border)]">×˜×•×¤×œ×• âœ…</h3>
                    </div>
                </div>
            </section>

            <!-- WhatsApp Alerts Page -->
            <section id="whatsapp-alerts-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×œ×•×— ×”×ª×¨××•×ª WhatsApp ğŸ’¬</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">×©×œ×— ×”×•×“×¢×•×ª ××•×‘× ×•×ª ×œ×œ×§×•×—×•×ª ×¢×œ ×—×¨×™×’×•×ª, ×¡×˜×˜×•×¡ ×”×–×× ×•×ª ×•×”×•×“×¢×•×ª ×—×©×•×‘×•×ª × ×•×¡×¤×•×ª.</p>
                </div>

                <div class="card p-8 space-y-5 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold mb-4 text-[var(--color-primary)]">×©×œ×™×—×ª ×”×•×“×¢×ª WhatsApp</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="whatsapp-customer-name" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×©× ×œ×§×•×—</label>
                            <input type="text" id="whatsapp-customer-name" class="w-full p-2 border" readonly>
                        </div>
                        <div>
                            <label for="whatsapp-phone-number" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                            <input type="text" id="whatsapp-phone-number" class="w-full p-2 border" readonly>
                        </div>
                        <div class="md:col-span-2"> <!-- Single column for address -->
                            <label for="whatsapp-address" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×›×ª×•×‘×ª</label>
                            <input type="text" id="whatsapp-address" class="w-full p-2 border" readonly>
                        </div>
                    </div>

                    <div>
                        <label for="message-template-select" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×‘×—×¨ ×ª×‘× ×™×ª ×”×•×“×¢×”</label>
                        <select id="message-template-select" class="w-full p-3 border text-lg" onchange="loadWhatsAppTemplate()">
                            <option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>
                            <!-- Templates will be populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="whatsapp-message-input" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×”×•×“×¢×”</label>
                        <textarea id="whatsapp-message-input" rows="8" class="w-full p-3 border text-lg typing-effect"></textarea>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button class="btn btn-secondary" onclick="clearWhatsAppMessage()">× ×§×”</button>
                        <button class="btn btn-primary" onclick="sendWhatsAppMessage()">×©×œ×— ×”×•×“×¢×”</button>
                    </div>
                </div>
            </section>

            <!-- Reports Page -->
            <section id="reports-page" class="page-content hidden space-y-10">
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-3 text-[var(--color-text-base)]">×“×•×—×•×ª ×•× ×™×ª×•×— × ×ª×•× ×™× ğŸ“Š</h2>
                    <p class="text-lg text-[var(--color-text-muted)]">× ×ª×— ××ª ×¤×¢×™×œ×•×ª ×”××›×•×œ×•×ª ×•×‘×—×Ÿ ×¡×™×›×•××™× ×ª×§×•×¤×ª×™×™×.</p>
                </div>

                <div class="card p-6 space-y-6">
                    <h3 class="text-2xl font-bold text-[var(--color-primary)] mb-4">×¡×™× ×•×Ÿ ×“×•×—×•×ª ×œ×¤×™ ×ª××¨×™×›×™×</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª××¨×™×š ×”×ª×—×œ×”</label>
                            <input type="date" id="report-start-date" class="w-full p-3 border text-lg" onchange="filterReports()">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-[var(--color-text-muted)] mb-1">×ª××¨×™×š ×¡×™×•×</label>
                            <input type="date" id="report-end-date" class="w-full p-3 border text-lg" onchange="filterReports()">
                        </div>
                        <button class="btn btn-secondary w-full" onclick="resetReportFilters()">
                            <i class="fas fa-filter-circle-xmark mr-2"></i>××™×¤×•×¡ ×¤×™×œ×˜×¨×™×
                        </button>
                    </div>

                    <div id="report-summaries" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6">
                        <div class="p-4 bg-[var(--color-background)] rounded-lg text-center shadow-inner">
                            <p class="text-sm text-[var(--color-text-muted)]">×¡×”"×› ×”×•×¨×“×•×ª ğŸ“¦â¬‡ï¸</p>
                            <p id="summary-downloads" class="text-3xl font-bold text-[var(--color-success)] mt-1">0</p>
                        </div>
                        <div class="p-4 bg-[var(--color-background)] rounded-lg text-center shadow-inner">
                            <p class="text-sm text-[var(--color-text-muted)]">×¡×”"×› ×”×—×œ×¤×•×ª ğŸ”„</p>
                            <p id="summary-exchanges" class="text-3xl font-bold text-[var(--color-warning)] mt-1">0</p>
                        </div>
                        <div class="p-4 bg-[var(--color-background)] rounded-lg text-center shadow-inner">
                            <p id="summary-uploads" class="text-3xl font-bold text-[var(--color-danger)] mt-1">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">×¤×¢×•×œ×•×ª ×œ×¤×™ ×—×•×“×©</h3>
                            <div class="chart-container">
                                <canvas id="chart-reports-monthly-actions"></canvas>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-base)]">×”×ª×¤×œ×’×•×ª ×¤×¢×•×œ×•×ª ×›×•×œ×œ×ª</h3>
                            <div class="chart-container">
                                <canvas id="chart-reports-action-distribution"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-[var(--color-primary)] mb-4">×”×–×× ×•×ª ×‘×˜×•×•×— ×”×ª××¨×™×›×™× ×”× ×‘×—×¨</h3>
                    <div class="overflow-x-auto rounded-lg border border-[var(--color-border)]">
                        <table id="reports-orders-table" class="w-full text-right table-auto">
                            <thead class="bg-[var(--color-background)] border-b-2 border-[var(--color-border)] sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">×ª××¨×™×š</th>
                                    <th class="p-3">×ª×¢×•×“×”</th>
                                    <th class="p-3">×œ×§×•×—</th>
                                    <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                                    <th class="p-3">××›×•×œ×•×ª</th>
                                    <th class="p-3">×¡×˜×˜×•×¡</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="reports-load-more-container" class="text-center mt-4 hidden">
                        <button class="btn btn-secondary" onclick="loadMoreReportOrders()">×˜×¢×Ÿ ×¢×•×“...</button>
                    </div>
                    <div id="no-report-orders" class="text-center text-gray-500 mt-6 hidden text-lg">××™×Ÿ ×”×–×× ×•×ª ×‘×˜×•×•×— ×”×ª××¨×™×›×™× ×”× ×‘×—×¨.</div>
                </div>

                <div class="flex justify-center gap-3 mt-6">
                    <button class="btn btn-primary" onclick="sendReportsByEmail()">
                        <i class="fas fa-envelope"></i> ×©×œ×— ×“×•×— ×‘××™×™×œ
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Floating Scroll to Top Button -->
    <button onclick="scrollToTop()" id="scroll-to-top-btn" title="×—×–×•×¨ ×œ××¢×œ×”">
        <i class="fas fa-arrow-up"></i>
    </button>
<!-- Customer Profile Modal -->
<div id="customer-profile-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col p-6">
        <div class="flex items-center justify-between pb-5 border-b border-[var(--color-border)] mb-4">
            <h2 id="profile-customer-name" class="text-2xl font-bold text-[var(--color-primary)]">×¤×¨×•×¤×™×œ ×œ×§×•×—</h2>
            <button onclick="closeModal('customer-profile-modal')" class="text-3xl text-[var(--color-text-muted)] hover:text-[var(--color-danger)] transition-colors">&times;</button>
        </div>
        <div class="overflow-y-auto">
            <div id="customer-profile-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Profile content will be dynamically generated here -->
            </div>
            <h3 class="text-xl font-bold text-[var(--color-text-base)] mt-8 mb-4">×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª</h3>
            <div class="overflow-x-auto rounded-lg border border-[var(--color-border)] customer-profile-orders-container">
                <table id="customer-profile-orders-table" class="w-full text-right table-auto">
                    <thead>
                        <tr>
                            <th class="p-3">×ª××¨×™×š</th>
                            <th class="p-3">×ª×¢×•×“×”</th>
                            <th class="p-3">×¡×•×’ ×¤×¢×•×œ×”</th>
                            <th class="p-3">×¡×˜×˜×•×¡</th>
                            <th class="p-3">×™××™×</th>
                            <th class="p-3">×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // URL of your Google Apps Script acting as the API
    const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
    // URL of a separate Apps Script for WhatsApp message logging (REPLACE WITH YOUR ACTUAL SCRIPT ID)
    const WHATSAPP_LOG_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_YOUR_WHATSAPP_SCRIPT_ID_HERE/exec'; 
    // URL of a separate Apps Script for sending emails (REPLACE WITH YOUR ACTUAL SCRIPT ID)
    const EMAIL_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_YOUR_EMAIL_SCRIPT_ID_HERE/exec';

    let allOrders = []; // Array containing all loaded orders
    let currentEditingOrder = null; // Variable for the order currently being edited
    let autoFillData = null; // Data for customer autofill
    let charts = {}; // Object to store Chart.js instances
    const OVERDUE_THRESHOLD_DAYS = 10; // Days after order date to be considered 'overdue'

    // --- Modal Utility Functions ---
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // --- Loader Functions ---
    function showLoader() { document.getElementById('loader-overlay').classList.remove('opacity-0', 'pointer-events-none'); }
    function hideLoader() { document.getElementById('loader-overlay').classList.add('opacity-0', 'pointer-events-none'); }

    // --- Theme Toggle Functions ---
    function toggleTheme() {
        const isDarkMode = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        document.querySelector('#theme-toggle i').className = isDarkMode ? 'fas fa-moon' : 'fas fa-sun';
        drawCharts(); // Redraw dashboard charts to match new theme colors
        if (currentPage === 'reports') { // Redraw report charts if on reports page
            filterReports(); // Re-filter and redraw report charts based on current filter
        }
    }

    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark');
            document.querySelector('#theme-toggle i').className = 'fas fa-moon';
        }
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    }

    // --- Alert Notification Function ---
    function showAlert(message, type = 'info') {
        const container = document.getElementById('alert-container');
        const alertItem = document.createElement('div');
        let bgColor, icon, textColor, borderColor;
        switch(type) {
            case 'success': bgColor = 'bg-green-50'; borderColor = 'border-green-500'; textColor = 'text-green-700'; icon = 'fa-check-circle'; break;
            case 'error': bgColor = 'bg-red-50'; borderColor = 'border-red-500'; textColor = 'text-red-700'; icon = 'fa-times-circle'; break;
            case 'warning': bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-500'; textColor = 'text-yellow-700'; icon = 'fa-exclamation-triangle'; break;
            default: bgColor = 'bg-blue-50'; borderColor = 'border-blue-500'; textColor = 'text-blue-700'; icon = 'fa-info-circle'; break;
        }
        alertItem.className = `p-4 rounded-lg border-l-4 shadow-md flex items-center gap-3 transform translate-x-full opacity-0 transition-all duration-500 ease-out ${bgColor} ${borderColor} ${textColor}`;
        alertItem.innerHTML = `<i class="fas ${icon}"></i><p>${message}</p>`;
        container.prepend(alertItem);
        
        setTimeout(() => {
            alertItem.style.transform = 'translateX(0)';
            alertItem.style.opacity = '1';
        }, 100);

        setTimeout(() => {
            alertItem.style.transform = 'translateX(100%)';
            alertItem.style.opacity = '0';
            setTimeout(() => alertItem.remove(), 500);
        }, 5000);
    }

    // --- API Communication Function (Exponential Backoff) ---
    async function fetchData(action, params = {}, retries = 0) {
        showLoader();
        const urlParams = new URLSearchParams({ action, ...params });
        const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
        console.log(`[fetchData] Request URL: ${url}`);
        try {
            const response = await fetch(url);
            console.log(`[fetchData] Response status: ${response.status}`);
            const data = await response.json();
            console.log(`[fetchData] Response data:`, data);

            if (!response.ok) {
                const errorMessage = data.message || `×©×’×™××ª ×©×¨×ª HTTP: ${response.status}`;
                showAlert(errorMessage, 'error');
                console.error("[fetchData] HTTP error:", errorMessage, data);
                return { success: false, message: errorMessage };
            }

            if (!data.success && data.message && data.message.includes('Service invoked too many times')) {
                const delay = Math.pow(2, retries) * 1000;
                if (retries < 5) {
                    console.warn(`[fetchData] Service invoked too many times, retrying in ${delay}ms... (Attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchData(action, params, retries + 1);
                } else {
                    showAlert('×”×©×¨×ª ×¢××•×¡ ××“×™, ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'error');
                    return { success: false, message: 'Service too busy' };
                }
            } else if (!data.success) {
                showAlert(data.message || '×¤×¢×•×œ×” × ×›×©×œ×” ×‘×©×¨×ª.', 'error');
                console.error("[fetchData] Server-side operation failed:", data.message, data);
                return data;
            }

            return data;
        } catch (error) {
            showAlert('×©×’×™××ª ×ª×§×©×•×¨×ª: ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª.', 'error');
            console.error("[fetchData] Network or parsing error:", error);
            return { success: false, message: error.message };
        } finally {
            hideLoader();
        }
    }

    // --- WhatsApp Logging and Sending ---
    async function logWhatsAppMessage(docId, message) {
        const url = `${WHATSAPP_LOG_SCRIPT_URL}?action=logMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.success) {
                console.log("[logWhatsAppMessage] WhatsApp message logged successfully.");
            } else {
                console.error("[logWhatsAppMessage] Failed to log WhatsApp message:", data.message);
            }
        } catch (error) {
            console.error("[logWhatsAppMessage] Error logging WhatsApp message:", error);
        }
    }

    function sendWhatsAppMessage() {
        const customerName = document.getElementById('whatsapp-customer-name').value;
        const phoneNumber = document.getElementById('whatsapp-phone-number').value;
        const message = document.getElementById('whatsapp-message-input').value;
        const orderDocId = document.getElementById('details-order-id').textContent;

        if (!phoneNumber) {
            showAlert('×× × ×‘×—×¨ ×œ×§×•×— ×¢× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××• ×”×–×Ÿ ××¡×¤×¨.', 'warning');
            return;
        }
        if (!message.trim()) {
            showAlert('×”×”×•×“×¢×” ×¨×™×§×”. ×× × ×›×ª×•×‘ ×”×•×“×¢×” ××• ×‘×—×¨ ×ª×‘× ×™×ª.', 'warning');
            return;
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        showAlert('×¤×•×ª×— WhatsApp ×œ×©×œ×™×—×ª ×”×•×“×¢×”...', 'info');
        logWhatsAppMessage(orderDocId, message);
    }

    function openWhatsAppAlertsForOrder(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) {
            showAlert('×”×–×× ×” ×œ× × ××¦××”.', 'error');
            return;
        }
        
        showPage('whatsapp-alerts');
        document.getElementById('whatsapp-customer-name').value = order['×©× ×œ×§×•×—'] || '';
        document.getElementById('whatsapp-phone-number').value = order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || '';
        document.getElementById('whatsapp-address').value = order['×›×ª×•×‘×ª'] || '';
        document.getElementById('details-order-id').textContent = order['×ª×¢×•×“×”'] || '';

        if (order._effectiveStatus === '×—×•×¨×’') {
            document.getElementById('message-template-select').value = whatsappTemplates.findIndex(t => t.name.includes('×—×•×¨×’×ª')).toString();
        } else if (order._daysPassedCalculated >= (OVERDUE_THRESHOLD_DAYS - 2) && order._effectiveStatus === '×¤×ª×•×—') { 
            document.getElementById('message-template-select').value = whatsappTemplates.findIndex(t => t.name.includes('×œ×¤× ×™ ×—×¨×™×’×”')).toString();
        } else {
            document.getElementById('message-template-select').value = '';
        }
        loadWhatsAppTemplate();
    }

    // --- Main Data Loading and Processing ---
    async function loadOrders() {
        const response = await fetchData('list', { status: 'all' });
        if (response.success) {
            allOrders = response.data.map(order => {
                const orderDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
                const today = new Date();
                const daysPassed = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                order._daysPassedCalculated = daysPassed;

                if (order['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    order._effectiveStatus = '×¡×’×•×¨';
                } else if (daysPassed >= OVERDUE_THRESHOLD_DAYS) {
                    order._effectiveStatus = '×—×•×¨×’';
                } else {
                    order._effectiveStatus = '×¤×ª×•×—';
                }
                order.sheetRow = parseInt(order.sheetRow);
                order['Kanban Status'] = order['Kanban Status'] || null; 
                return order;
            });
            updateDashboard();
            filterTable();
            updateContainerInventory();
            renderTreatmentBoard();
            populateAgentFilter();
            if (currentPage === 'reports') {
                filterReports(); // Re-filter and display reports if on reports page
            }
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª.', 'error');
        }
    }

    // --- Dashboard Updates ---
    function updateDashboard() {
        const openOrders = allOrders.filter(o => o._effectiveStatus === '×¤×ª×•×—');
        const overdueOrders = allOrders.filter(o => o._effectiveStatus === '×—×•×¨×’');
        
        const containersInUse = new Set();
        allOrders.filter(o => o._effectiveStatus !== '×¡×’×•×¨').forEach(order => {
            String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(c => containersInUse.add(c));
            String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(c => containersInUse.delete(c));
        });
        
        const activeCustomers = new Set(allOrders.filter(o => o._effectiveStatus !== '×¡×’×•×¨').map(o => o['×©× ×œ×§×•×—']).filter(Boolean));

        document.getElementById('open-orders-count').textContent = openOrders.length;
        document.getElementById('overdue-orders-count').textContent = overdueOrders.length;
        document.getElementById('containers-in-use').textContent = containersInUse.size;
        document.getElementById('active-customers-count').textContent = activeCustomers.size;
        document.getElementById('overdue-customers-badge').textContent = overdueOrders.length;
        
        const actionTypeCounts = allOrders.reduce((acc, order) => {
            const type = order['×¡×•×’ ×¤×¢×•×œ×”'];
            if (type) {
                acc[type] = (acc[type] || 0) + 1;
            }
            return acc;
        }, {});

        document.getElementById('action-type-×”×•×¨×“×”-count').textContent = actionTypeCounts['×”×•×¨×“×”'] || 0;
        document.getElementById('action-type-×”×—×œ×¤×”-count').textContent = actionTypeCounts['×”×—×œ×¤×”'] || 0;
        document.getElementById('action-type-×”×¢×œ××”-count').textContent = actionTypeCounts['×”×¢×œ××”'] || 0;

        drawCharts();
    }

    // --- Order Table Rendering and Filtering ---
    function renderOrdersTable(ordersToRender) {
        const tableBody = document.querySelector('#orders-table tbody');
        tableBody.innerHTML = '';
        if (ordersToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-[var(--color-text-muted)]">××™×Ÿ ×”×–×× ×•×ª ×œ×”×¦×’×” ×‘×¡×™× ×•×Ÿ ×”× ×•×›×—×™.</td></tr>`;
            return;
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            const actionTypeClass = order['×¡×•×’ ×¤×¢×•×œ×”'] ? `action-type-${order['×¡×•×’ ×¤×¢×•×œ×”']}` : '';
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer ${actionTypeClass}`;
            
            if (order._effectiveStatus === '×—×•×¨×’') {
                row.classList.add('overdue-blinking');
            }

            row.dataset.sheetRow = order.sheetRow;
            row.onclick = (e) => {
                if (!e.target.closest('.action-icon-btn, .container-badge, .customer-name-link')) { 
                    showOrderDetailsModal(order.sheetRow);
                }
            };

            const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer hover:bg-[var(--color-primary)] hover:text-white transition-colors" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')"><i class="fas fa-box"></i> ${c.trim()}</span>`
            ).join(' ');

            const daysPassedHtml = order._effectiveStatus === '×—×•×¨×’' ?
                `<span class="overdue-text-blinking">${order._daysPassedCalculated || ''}</span>` :
                `${order._daysPassedCalculated || ''}`;

            row.innerHTML = `
                <td class="p-3 font-medium" data-label="×ª××¨×™×š">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                <td class="p-3 font-medium" data-label="×ª×¢×•×“×”">${order['×ª×¢×•×“×”'] || ''}</td>
                <td class="p-3 font-semibold customer-name-link cursor-pointer hover:text-[var(--color-primary)]" onclick="event.stopPropagation(); showCustomerProfile('${order['×©× ×œ×§×•×—']}')" data-label="×œ×§×•×—">${order['×©× ×œ×§×•×—'] || ''}</td>
                <td class="p-3 font-medium" data-label="×›×ª×•×‘×ª">${order['×›×ª×•×‘×ª'] || ''}</td>
                <td class="p-3" data-label="×¡×•×’ ×¤×¢×•×œ×”">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                <td class="p-3" data-label="×™××™× ×©×¢×‘×¨×•">${daysPassedHtml}</td>
                <td class="p-3" data-label="××›×•×œ×•×ª">${containerHTML}</td>
                <td class="p-3" data-label="×¡×˜×˜×•×¡"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3 whitespace-nowrap" data-label="×¤×¢×•×œ×•×ª">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="×©×œ×— WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="×¢×¨×•×š"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="×©×›×¤×œ"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    ${order._effectiveStatus !== '×¡×’×•×¨' ? `<button class="action-icon-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="×¡×’×•×¨ ×”×–×× ×”"><i class="fas fa-check-circle text-[var(--color-success)]"></i></button>` : ''}
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="××—×§"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </td>
            `;
        });
    }

    function filterTable(statusFilterParam = null, actionTypeFilterParam = null, isExplicitButtonFilter = false) {
        let searchText = document.getElementById('search-input').value.toLowerCase().trim();
        const selectedStatusFilter = document.getElementById('filter-status-select').value;
        const selectedActionTypeFilter = document.getElementById('filter-action-type-select').value;
        const selectedAgentFilter = document.getElementById('filter-agent-select').value;
        let showClosed = document.getElementById('show-closed-orders').checked;

        if (isExplicitButtonFilter) {
            if (statusFilterParam === '×—×•×¨×’') {
                showClosed = false;
                document.getElementById('show-closed-orders').checked = false;
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = '×—×•×¨×’';
                document.getElementById('filter-action-type-select').value = 'all';
                document.getElementById('filter-agent-select').value = 'all';
            } else if (actionTypeFilterParam) {
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = 'all';
                document.getElementById('filter-action-type-select').value = actionTypeFilterParam;
                document.getElementById('filter-agent-select').value = 'all';
                showClosed = document.getElementById('show-closed-orders').checked;
            } else if (statusFilterParam === '×¤×ª×•×—' || actionTypeFilterParam === '××›×•×œ×” ×‘×©×™××•×©' || actionTypeFilterParam === '×œ×§×•×— ×¤×¢×™×œ') {
                document.getElementById('search-input').value = '';
                document.getElementById('filter-status-select').value = statusFilterParam || 'all';
                document.getElementById('filter-action-type-select').value = 'all';
                document.getElementById('filter-agent-select').value = 'all';
                showClosed = false;
                document.getElementById('show-closed-orders').checked = false;
            }
        }

        const filtered = allOrders.filter(order => {
            let matchesSearch = true;
            if (searchText) {
                const isNumericSearch = !isNaN(parseFloat(searchText)) && isFinite(searchText);
                if (isNumericSearch) {
                    matchesSearch = String(order['×ª×¢×•×“×”'] || '').includes(searchText) ||
                                    String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').includes(searchText) ||
                                    String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').includes(searchText);
                } else {
                    matchesSearch = Object.values(order).some(val => 
                        String(val).toLowerCase().includes(searchText)
                    );
                }
            }
            
            let matchesStatus = true;
            const currentStatusFilter = isExplicitButtonFilter && statusFilterParam ? statusFilterParam : selectedStatusFilter;
            if (currentStatusFilter !== 'all') {
                matchesStatus = (order._effectiveStatus === currentStatusFilter);
            }

            let matchesActionType = true;
            const currentActionTypeFilter = isExplicitButtonFilter && actionTypeFilterParam ? actionTypeFilterParam : selectedActionTypeFilter;
            if (currentActionTypeFilter !== 'all') {
                if (currentActionTypeFilter === '××›×•×œ×” ×‘×©×™××•×©') {
                    matchesActionType = (String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).length > 0 && order._effectiveStatus !== '×¡×’×•×¨' && order['×¡×•×’ ×¤×¢×•×œ×”'] !== '×”×¢×œ××”');
                } else if (currentActionTypeFilter === '×œ×§×•×— ×¤×¢×™×œ') {
                     matchesActionType = (order._effectiveStatus !== '×¡×’×•×¨');
                }
                else {
                    matchesActionType = (order['×¡×•×’ ×¤×¢×•×œ×”'] === currentActionTypeFilter);
                }
            }

            let matchesAgent = true;
            if (selectedAgentFilter !== 'all') {
                matchesAgent = (order['×©× ×¡×•×›×Ÿ'] === selectedAgentFilter);
            }

            let matchesShowClosed = true;
            if (!showClosed) {
                matchesShowClosed = (order._effectiveStatus === '×¤×ª×•×—' || order._effectiveStatus === '×—×•×¨×’');
            }
            
            return matchesSearch && matchesStatus && matchesActionType && matchesAgent && matchesShowClosed;
        });
        renderOrdersTable(filtered);
    }
    
    function resetTableFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-status-select').value = 'all';
        document.getElementById('filter-action-type-select').value = 'all';
        document.getElementById('filter-agent-select').value = 'all';
        document.getElementById('show-closed-orders').checked = false;
        filterTable();
    }

    function populateAgentFilter() {
        const agentSelect = document.getElementById('filter-agent-select');
        agentSelect.innerHTML = '<option value="all">×›×œ ×”×¡×•×›× ×™×</option>';
        const uniqueAgents = [...new Set(allOrders.map(order => order['×©× ×¡×•×›×Ÿ']))].filter(Boolean).sort();
        uniqueAgents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent;
            option.textContent = agent;
            agentSelect.appendChild(option);
        });
    }

    // --- Date Formatting Utility ---
    function formatDate(dateInput) {
        if (!dateInput) return '';
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return dateInput;
        return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // --- Container Usage Validation ---
    function validateContainerUsage(containerNum, currentOrderSheetRow = null) {
        if (!containerNum) return true;

        const isContainerCurrentlyInUse = allOrders.some(order => {
            if (order.sheetRow === currentOrderSheetRow) {
                return false;
            }
            const containersTakenByOrder = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBroughtByOrder = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

            const isTaken = containersTakenByOrder.includes(containerNum);
            const isBrought = containersBroughtByOrder.includes(containerNum);

            return (order._effectiveStatus === '×¤×ª×•×—' || order._effectiveStatus === '×—×•×¨×’') && isTaken && !isBrought;
        });
        
        return !isContainerCurrentlyInUse;
    }

    // --- Order Modal (Add/Edit/Duplicate) Functions ---
    function openOrderModal(mode, sheetRow = null) {
        const form = document.getElementById('order-form');
        form.reset();
        currentEditingOrder = null;
        autoFillData = null;

        if (mode === 'add') {
            document.getElementById('modal-title').textContent = '×”×•×¡×£ ×”×–×× ×” ×—×“×©×”';
            document.getElementById('×ª××¨×™×š ×”×–×× ×”').valueAsDate = new Date();
            form.onsubmit = async e => {
                e.preventDefault();
                await addOrder();
            };
        } else if (mode === 'edit' && sheetRow) {
            document.getElementById('modal-title').textContent = '×¢×¨×•×š ×”×–×× ×”';
            currentEditingOrder = allOrders.find(order => order.sheetRow === sheetRow);
            if (currentEditingOrder) {
                Object.keys(currentEditingOrder).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        if (input.type === 'date' && currentEditingOrder[key]) {
                            input.value = new Date(currentEditingOrder[key]).toISOString().split('T')[0];
                        } else {
                            input.value = currentEditingOrder[key];
                        }
                    }
                });
                form.onsubmit = async e => {
                    e.preventDefault();
                    await editOrder(sheetRow);
                };
            }
        } else if (mode === 'duplicate' && sheetRow) {
            document.getElementById('modal-title').textContent = '×©×›×¤×œ ×”×–×× ×”';
            const originalOrder = allOrders.find(o => o.sheetRow === sheetRow);
            if (originalOrder) {
                Object.keys(originalOrder).forEach(key => {
                    const input = form.elements[key];
                    if (input && !['×ª×¢×•×“×”', '×ª××¨×™×š ×¡×’×™×¨×”', '×™××™× ×©×¢×‘×¨×•', '××¡×¤×¨×™ ××›×•×œ×•×ª', '_effectiveStatus', '_daysPassedCalculated', 'sheetRow', 'Kanban Status'].includes(key)) {
                         if (input.type === 'date' && originalOrder[key]) {
                            input.value = new Date(originalOrder[key]).toISOString().split('T')[0];
                        } else {
                            input.value = originalOrder[key];
                        }
                    }
                });
                document.getElementById('×ª××¨×™×š ×”×–×× ×”').valueAsDate = new Date();
                document.getElementById('×ª×¢×•×“×”').value = '';
                form.onsubmit = async e => {
                    e.preventDefault();
                    await addOrder();
                };
            }
        }
        handleActionTypeChange();
        openModal('order-modal');
    }

    function handleActionTypeChange() {
        const actionType = document.getElementById('×¡×•×’ ×¤×¢×•×œ×”').value;
        const takenDiv = document.getElementById('container-taken-div');
        const broughtDiv = document.getElementById('container-brought-div');
        takenDiv.classList.toggle('hidden', !['×”×•×¨×“×”', '×”×—×œ×¤×”'].includes(actionType));
        broughtDiv.classList.toggle('hidden', !['×”×¢×œ××”', '×”×—×œ×¤×”'].includes(actionType));
    }

    async function addOrder() {
        const form = document.getElementById('order-form');
        const formData = new FormData(form);
        const orderData = Object.fromEntries(formData.entries());
        
        const requiredFields = ['×ª××¨×™×š ×”×–×× ×”', '×ª×¢×•×“×”', '×©× ×¡×•×›×Ÿ', '×©× ×œ×§×•×—', '×›×ª×•×‘×ª', '×¡×•×’ ×¤×¢×•×œ×”'];
        for (const field of requiredFields) {
            if (!orderData[field] || String(orderData[field]).trim() === '') {
                showAlert(`×©×“×” ×—×•×‘×” ×—×¡×¨: ${field}`, 'error');
                return;
            }
        }

        if (['×”×•×¨×“×”', '×”×—×œ×¤×”'].includes(orderData['×¡×•×’ ×¤×¢×•×œ×”'])) {
            const containerTaken = String(orderData['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').trim();
            if (containerTaken && !validateContainerUsage(containerTaken)) {
                showAlert(`×©×™××• ×œ×‘: ××›×•×œ×” ${containerTaken} × ×¨××™×ª ×›×‘×¨ ×‘×©×™××•×© ×‘×”×–×× ×” ×¤×ª×•×—×” ××—×¨×ª. ×•×“××• ×©×–×• ×”×¤×¢×•×œ×” ×”×¨×¦×•×™×”.`, 'warning');
            }
        }

        orderData['×¡×˜×˜×•×¡'] = '×¤×ª×•×—';
        orderData['Kanban Status'] = null;

        const response = await fetchData('add', { data: JSON.stringify(orderData) });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('order-modal');
            await loadOrders();
            
            if (['×”×¢×œ××”', '×”×—×œ×¤×”'].includes(orderData['×¡×•×’ ×¤×¢×•×œ×”'])) {
                const containerBrought = String(orderData['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').trim();
                if (containerBrought) {
                    await closePreviousContainerOrders(containerBrought, orderData['×ª××¨×™×š ×”×–×× ×”']);
                }
            }
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×”×•×¡×¤×ª ×”×–×× ×”', 'error');
        }
    }

    async function editOrder(sheetRow) {
        const form = document.getElementById('order-form');
        const formData = new FormData(form);
        const updateData = Object.fromEntries(formData.entries());
        
        const requiredFields = ['×ª××¨×™×š ×”×–×× ×”', '×ª×¢×•×“×”', '×©× ×¡×•×›×Ÿ', '×©× ×œ×§×•×—', '×›×ª×•×‘×ª', '×¡×•×’ ×¤×¢×•×œ×”'];
        for (const field of requiredFields) {
            if (!updateData[field] || String(updateData[field]).trim() === '') {
                showAlert(`×©×“×” ×—×•×‘×” ×—×¡×¨: ${field}`, 'error');
                return;
            }
        }

        if (['×”×•×¨×“×”', '×”×—×œ×¤×”'].includes(updateData['×¡×•×’ ×¤×¢×•×œ×”'])) {
            const containerTaken = String(updateData['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').trim();
            if (containerTaken && !validateContainerUsage(containerTaken, sheetRow)) {
                showAlert(`××›×•×œ×” ${containerTaken} ×›×‘×¨ ×‘×©×™××•×© ×‘×”×–×× ×” ×¤×ª×•×—×” ××—×¨×ª. ×× × ×•×“× ×©×”×™× ×¤× ×•×™×”.`, 'error');
                return;
            }
        }

        if (updateData.hasOwnProperty('×¡×˜×˜×•×¡')) {
            delete updateData['×¡×˜×˜×•×¡'];
        }
        if (updateData.hasOwnProperty('Kanban Status')) {
            delete updateData['Kanban Status'];
        }
        
        const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('order-modal');
            await loadOrders();

            if (['×”×¢×œ××”', '×”×—×œ×¤×”'].includes(updateData['×¡×•×’ ×¤×¢×•×œ×”'])) {
                const containerBrought = String(updateData['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').trim();
                if (containerBrought) {
                    await closePreviousContainerOrders(containerBrought, updateData['×ª××¨×™×š ×”×–×× ×”']);
                }
            }
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×–×× ×”', 'error');
        }
    }

    async function closePreviousContainerOrders(containerNumber, closeDate) {
        const response = await fetchData('closePreviousContainerOrders', { containerNumber, closeDate });
        if (!response.success) {
            console.error("[closePreviousContainerOrders] Failed to update previous orders for container:", containerNumber, response.message);
        }
    }

    async function duplicateOrder(sheetRow) {
        openOrderModal('duplicate', sheetRow);
    }

    function openDeleteConfirmModal(sheetRow, orderId) {
        document.getElementById('delete-order-id').textContent = orderId;
        document.getElementById('confirm-delete-btn').onclick = () => deleteOrder(sheetRow);
        openModal('delete-confirm-modal');
    }

    async function deleteOrder(sheetRow) {
        const response = await fetchData('delete', { id: sheetRow });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('delete-confirm-modal');
            loadOrders();
        } else {
            showAlert(response.message || '×©×’×™××” ×‘××—×™×§×ª ×”×–×× ×”', 'error');
        }
    }
    
    // --- Autofill Customer Details ---
    function checkCustomerExistenceAndAutofill() {
        const customerName = document.getElementById('×©× ×œ×§×•×—').value.trim();
        const address = document.getElementById('×›×ª×•×‘×ª').value.trim();
        const phone = document.getElementById('×˜×œ×¤×•×Ÿ ×œ×§×•×—').value.trim();

        if (!customerName && !address && !phone) return;

        let latestOrder = allOrders
            .filter(o => {
                const matchesName = customerName ? o['×©× ×œ×§×•×—'] === customerName : true;
                const matchesAddress = address ? o['×›×ª×•×‘×ª'] === address : true;
                const matchesPhone = phone ? o['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] === phone : true;
                return matchesName && matchesAddress && matchesPhone;
            })
            .sort((a, b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”']))[0];

        if (latestOrder && !currentEditingOrder) {
            autoFillData = latestOrder;
            document.getElementById('autofill-customer-name-display').textContent = `×”×œ×§×•×— ${latestOrder['×©× ×œ×§×•×—']} ×–×•×”×”!`;
            document.getElementById('autofill-message').innerHTML = `×”×œ×§×•×— <b>${latestOrder['×©× ×œ×§×•×—']}</b> ×–×•×”×” ××”×–×× ×” ×§×•×“××ª ××ª××¨×™×š <b>${formatDate(latestOrder['×ª××¨×™×š ×”×–×× ×”'])}</b>. ×”×× ×‘×¨×¦×•× ×š ×œ××œ× ××ª ×¤×¨×˜×™×• ××•×˜×•××˜×™×ª?`;
            openModal('autofill-confirm-modal');
        }
    }

    function confirmAutofill(confirm) {
        if (confirm && autoFillData) {
            Object.keys(autoFillData).forEach(key => {
                const input = document.getElementById(key);
                if (input && !['×ª×¢×•×“×”', '×ª××¨×™×š ×”×–×× ×”', '×ª××¨×™×š ×¡×’×™×¨×”', '×™××™× ×©×¢×‘×¨×•', '××¡×¤×¨×™ ××›×•×œ×•×ª', '_effectiveStatus', '_daysPassedCalculated', 'sheetRow', 'Kanban Status'].includes(key)) {
                     if (input.type === 'date' && autoFillData[key]) {
                        input.value = new Date(autoFillData[key]).toISOString().split('T')[0];
                    } else {
                        input.value = autoFillData[key];
                    }
                }
            });
            document.getElementById('×ª××¨×™×š ×”×–×× ×”').valueAsDate = new Date();
            document.getElementById('×ª×¢×•×“×”').value = '';
            handleActionTypeChange();
        }
        closeModal('autofill-confirm-modal');
        autoFillData = null;
    }

    // --- Order Details Modal ---
    function showOrderDetailsModal(sheetRow) {
        const order = allOrders.find(o => o.sheetRow === sheetRow);
        if (!order) {
            showAlert('×¤×¨×˜×™ ×”×–×× ×” ×œ× × ××¦××•.', 'error');
            return;
        }

        document.getElementById('details-order-id').textContent = order['×ª×¢×•×“×”'] || '×œ× ×™×“×•×¢';
        const detailsContent = document.getElementById('order-details-content');
        detailsContent.innerHTML = `
            <p><strong>×ª××¨×™×š ×”×–×× ×”:</strong> ${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</p>
            <p><strong>×¡×˜×˜×•×¡:</strong> <span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></p>
            <p><strong>×¡×˜×˜×•×¡ ×§× ×‘×Ÿ:</strong> ${order['Kanban Status'] || '×œ× × ×§×‘×¢'}</p>
            <p><strong>×œ×§×•×—:</strong> ${order['×©× ×œ×§×•×—'] || ''}</p>
            <p><strong>×›×ª×•×‘×ª:</strong> ${order['×›×ª×•×‘×ª'] || ''}</p>
            <p><strong>×˜×œ×¤×•×Ÿ ×œ×§×•×—:</strong> ${order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || ''}</p>
            <p><strong>×¡×•×›×Ÿ:</strong> ${order['×©× ×¡×•×›×Ÿ'] || ''}</p>
            <p><strong>×¡×•×’ ×¤×¢×•×œ×”:</strong> ${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</p>
            <p><strong>××›×•×œ×” ×™×¨×“×”:</strong> ${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || ''}</p>
            <p><strong>××›×•×œ×” ×¢×œ×ª×”:</strong> ${order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}</p>
            <p><strong>×™××™× ×©×¢×‘×¨×•:</strong> ${order._daysPassedCalculated || ''}</p>
            <p><strong>×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™:</strong> ${formatDate(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'])}</p>
            <p><strong>×”×¢×¨×•×ª:</strong> ${order['×”×¢×¨×•×ª'] || ''}</p>
            ${order['×ª××¨×™×š ×¡×’×™×¨×”'] ? `<p><strong>×ª××¨×™×š ×¡×’×™×¨×”:</strong> ${formatDate(order['×ª××¨×™×š ×¡×’×™×¨×”'])}</p>` : ''}
        `;
        
        const actionButtonsDiv = document.querySelector('#order-details-modal .flex.justify-between.items-center');
        actionButtonsDiv.dataset.sheetRow = sheetRow;

        openModal('order-details-modal');
    }

    function editOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        closeModal('order-details-modal');
        openOrderModal('edit', parseInt(sheetRow));
    }

    function deleteOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        closeModal('order-details-modal');
        if (order) {
            openDeleteConfirmModal(parseInt(sheetRow), order['×ª×¢×•×“×”']);
        }
    }

    function duplicateOrderFromDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        closeModal('order-details-modal');
        openOrderModal('duplicate', parseInt(sheetRow));
    }

    // --- WhatsApp Sharing from Order Details ---
    function shareOrderDetailsOnWhatsApp() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        if (!order) {
            showAlert('×œ× × ×™×ª×Ÿ ×œ×©×ª×£: ×¤×¨×˜×™ ×”×–×× ×” ×œ× × ××¦××•.', 'error');
            return;
        }

        let message = `*×¤×¨×˜×™ ×”×–×× ×” - ×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ*\n\n`;
        message += `*×ª×¢×•×“×”:* ${order['×ª×¢×•×“×”'] || ''}\n`;
        message += `*×œ×§×•×—:* ${order['×©× ×œ×§×•×—'] || ''}\n`;
        message += `*×›×ª×•×‘×ª:* ${order['×›×ª×•×‘×ª'] || ''}\n`;
        message += `*×˜×œ×¤×•×Ÿ:* ${order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || ''}\n`;
        message += `*×¡×•×’ ×¤×¢×•×œ×”:* ${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}\n`;
        if (order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”']) { message += `*××›×•×œ×” ×™×¨×“×”:* ${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”']}\n`; }
        if (order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”']) { message += `*××›×•×œ×” ×¢×œ×ª×”:* ${order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”']}\n`; }
        message += `*×¡×˜×˜×•×¡:* ${order._effectiveStatus || ''}\n`;
        message += `*×ª××¨×™×š ×”×–×× ×”:* ${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}\n`;
        if (order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) { message += `*×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™:* ${formatDate(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'])}\n`; }
        if (order['×”×¢×¨×•×ª']) { message += `*×”×¢×¨×•×ª:* ${order['×”×¢×¨×•×ª']}\n`; }

        const whatsappUrl = `https://wa.me/${order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || ''}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        showAlert('×¤×•×ª×— WhatsApp ×œ×©×™×ª×•×£ ×¤×¨×˜×™ ×”×–×× ×”...', 'info');
        logWhatsAppMessage(order['×ª×¢×•×“×”'], message); // Log the shared message
    }

    // --- Printing Order Details ---
    function printOrderDetails() {
        const sheetRow = document.querySelector('#order-details-modal .flex.justify-between.items-center').dataset.sheetRow;
        const order = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        if (!order) {
            showAlert('×œ× × ×™×ª×Ÿ ×œ×”×“×¤×™×¡: ×¤×¨×˜×™ ×”×–×× ×” ×œ× × ××¦××•.', 'error');
            return;
        }
        
        printOrderDocument(order); // Call the new, advanced printing function
    }


    // --- Container & Customer History Modals ---
    function showContainerHistory(containerNumber) {
        document.getElementById('history-container-number').textContent = containerNumber;
        const historyTableBody = document.getElementById('container-history-table-body');
        historyTableBody.innerHTML = '';
        document.getElementById('no-container-history').classList.add('hidden');

        const containerMovements = allOrders
            .filter(order => {
                const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                return containersTaken.includes(containerNumber) || containersBrought.includes(containerNumber);
            })
            .sort((a, b) => new Date(a['×ª××¨×™×š ×”×–×× ×”']) - new Date(b['×ª××¨×™×š ×”×–×× ×”']));

        if (containerMovements.length === 0) {
            document.getElementById('no-container-history').classList.remove('hidden');
        } else {
            containerMovements.forEach(order => {
                const startDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
                const endDate = order['×ª××¨×™×š ×¡×’×™×¨×”'] ? new Date(order['×ª××¨×™×š ×¡×’×™×¨×”']) : (order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? new Date(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) : new Date());
                
                let durationDays = 'N/A';
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    durationDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
                    durationDays = Math.max(0, durationDays);
                }

                const row = historyTableBody.insertRow();
                row.className = 'border-b border-[var(--color-border)]';
                row.innerHTML = `
                    <td class="p-2">${order['×ª×¢×•×“×”'] || ''}</td>
                    <td class="p-2 font-medium">${order['×©× ×œ×§×•×—'] || ''}</td>
                    <td class="p-2">${order['×›×ª×•×‘×ª'] || ''}</td>
                    <td class="p-2">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                    <td class="p-2">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                    <td class="p-2">${order['×ª××¨×™×š ×¡×’×™×¨×”'] ? formatDate(order['×ª××¨×™×š ×¡×’×™×¨×”']) : (order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? formatDate(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) : '×˜×¨× × ×¡×’×¨')}</td>
                    <td class="p-2">${durationDays !== 'N/A' ? `${durationDays} ×™××™×` : 'N/A'}</td>
                `;
            });
        }
        openModal('container-history-modal');
    }

    function showCustomerHistory(customerName) {
        document.getElementById('history-customer-name').textContent = customerName;
        const historyTableBody = document.getElementById('customer-history-table-body');
        historyTableBody.innerHTML = '';
        document.getElementById('no-customer-history').classList.add('hidden');

        const customerOrders = allOrders
            .filter(order => order['×©× ×œ×§×•×—'] === customerName)
            .sort((a, b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”']));

        if (customerOrders.length === 0) {
            document.getElementById('no-customer-history').classList.remove('hidden');
        } else {
            customerOrders.forEach(order => {
                const row = historyTableBody.insertRow();
                row.className = 'border-b border-[var(--color-border)] cursor-pointer';
                row.onclick = () => {
                    closeModal('customer-history-modal');
                    showOrderDetailsModal(order.sheetRow);
                };
                row.innerHTML = `
                    <td class="p-2">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                    <td class="p-2">${order['×ª×¢×•×“×”'] || ''}</td>
                    <td class="p-2">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                    <td class="p-2">${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || ''}</td>
                    <td class="p-2">${order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}</td>
                    <td class="p-2"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                    <td class="p-2">${order['×”×¢×¨×•×ª'] || ''}</td>
                `;
            });
        }
        openModal('customer-history-modal');
    }

    // --- WhatsApp Sharing from Customer History ---
    function shareCustomerHistoryOnWhatsApp() {
        const customerName = document.getElementById('history-customer-name').textContent;
        const customerOrders = allOrders.filter(order => order['×©× ×œ×§×•×—'] === customerName);
        
        if (!customerOrders.length) {
            showAlert('××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ×©×ª×£ ×¢×‘×•×¨ ×œ×§×•×— ×–×”.', 'warning');
            return;
        }

        let message = `*×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ×œ×§×•×—: ${customerName}*\n\n`;
        customerOrders.slice(0, 5).forEach(order => { // Share up to 5 latest orders for brevity
            message += `*×ª×¢×•×“×”:* ${order['×ª×¢×•×“×”']}, *×¤×¢×•×œ×”:* ${order['×¡×•×’ ×¤×¢×•×œ×”']}, *×ª××¨×™×š:* ${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}, *×¡×˜×˜×•×¡:* ${order._effectiveStatus}\n`;
        });
        if (customerOrders.length > 5) {
            message += `×•×¢×•×“ ${customerOrders.length - 5} ×”×–×× ×•×ª...\n`;
        }
        message += `\n×œ×¤×¨×˜×™× × ×•×¡×¤×™×, ×¦×•×¨ ×§×©×¨.`;

        const phoneNumber = customerOrders[0]['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || ''; // Get phone from first order
        if (!phoneNumber) {
            showAlert('×œ× × ××¦× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×œ×§×•×— ×–×”.', 'warning');
            return;
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        showAlert('×¤×•×ª×— WhatsApp ×œ×©×™×ª×•×£ ×”×™×¡×˜×•×¨×™×™×ª ×œ×§×•×—...', 'info');
        // No doc ID for logging customer history, can log with customer name if needed
        logWhatsAppMessage(`CustomerHistory_${customerName}`, message);
    }

    // --- Printing Customer History ---
    function printCustomerHistory() {
        const customerName = document.getElementById('history-customer-name').textContent;
        const customerOrders = allOrders.filter(order => order['×©× ×œ×§×•×—'] === customerName);
        
        if (!customerOrders.length) {
            showAlert('××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ×”×“×¤×¡×” ×¢×‘×•×¨ ×œ×§×•×— ×–×”.', 'warning');
            return;
        }

        let tableRowsHtml = customerOrders.map(order => `
            <tr>
                <td>${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                <td>${order['×ª×¢×•×“×”'] || ''}</td>
                <td>${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                <td>${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || ''}</td>
                <td>${order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}</td>
                <td>${order._effectiveStatus || ''}</td>
                <td>${order['×”×¢×¨×•×ª'] || ''}</td>
            </tr>
        `).join('');

        let printContent = `
            <div id="print-area" style="direction: rtl; text-align: right; margin: 0 auto; max-width: 900px;">
                <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="Company Logo" style="max-width: 150px; margin-bottom: 20px; display: block;">
                <h1 style="font-size: 24px; color: #2F4F4F; margin-bottom: 20px;">×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ×œ×§×•×—: ${customerName}</h1>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">×ª××¨×™×š ×”×–×× ×”</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">×ª×¢×•×“×”</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">×¡×•×’ ×¤×¢×•×œ×”</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">××›×•×œ×” ×™×¨×“×”</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">××›×•×œ×” ×¢×œ×ª×”</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">×¡×˜×˜×•×¡</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>${tableRowsHtml}</tbody>
                </table>
            </div>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>×”×“×¤×¡×ª ×”×™×¡×˜×•×¨×™×™×ª ×œ×§×•×—</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            body { font-family: 'Rubik', sans-serif; margin: 0; padding: 0; }
            #print-area { width: 100%; padding: 20px; box-sizing: border-box; }
            #print-area img { max-width: 150px; margin-bottom: 20px; }
            #print-area h1 { font-size: 24px; color: #2F4F4F; margin-bottom: 20px; }
            #print-area table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            #print-area th, #print-area td { border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 13px; }
            #print-area th { background-color: #f2f2f2; }
            @media print {
                body { margin: 0; }
            }
        `);
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }


    // --- Close Order Modal ---
    function openCloseOrderModal(sheetRow, orderId) {
        const confirmBtn = document.getElementById('confirm-close-order-btn');
        confirmBtn.dataset.sheetRow = sheetRow;
        
        document.getElementById('close-order-id-display').textContent = orderId;
        document.getElementById('close-order-notes').value = '';
        
        confirmBtn.onclick = async () => {
            const notes = document.getElementById('close-order-notes').value;
            const sheetRowToClose = parseInt(confirmBtn.dataset.sheetRow);
            if (isNaN(sheetRowToClose)) {
                showAlert('×©×’×™××”: ××¡×¤×¨ ×”×–×× ×” ×œ× ×—×•×§×™. ×× × ×¨×¢× ×Ÿ ×•× ×¡×” ×©×•×‘.', 'error');
                return;
            }
            await closeOrderConfirmation(sheetRowToClose, notes);
        };
        openModal('close-order-modal');
    }

    async function closeOrderConfirmation(sheetRow, notes) {
        const response = await fetchData('close', { sheetRow: sheetRow, notes: notes });
        if (response.success) {
            showAlert(response.message, 'success');
            closeModal('close-order-modal');
            loadOrders();
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×¡×’×™×¨×ª ×”×–×× ×”', 'error');
        }
    }


    // --- Chart.js Rendering for Dashboard ---
    function drawCharts() {
        const customerData = allOrders.reduce((acc, order) => {
            if (order._effectiveStatus !== '×¡×’×•×¨') {
                const count = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).length;
                if (count > 0 && order['×¡×•×’ ×¤×¢×•×œ×”'] !== '×”×¢×œ××”') {
                    acc[order['×©× ×œ×§×•×—']] = (acc[order['×©× ×œ×§×•×—']] || 0) + count;
                }
            }
            return acc;
        }, {});
        const sortedCustomers = Object.entries(customerData).sort((a, b) => b[1] - a[1]).slice(0, 10);

        const statusData = allOrders.reduce((acc, order) => {
            const status = order._effectiveStatus || '×œ× ×™×“×•×¢';
            acc[status] = (acc[status] || 0) + 1;
            return acc;
        }, {});

        const actionTypeChartData = allOrders.reduce((acc, order) => {
            const actionType = order['×¡×•×’ ×¤×¢×•×œ×”'] || '×œ× ×™×“×•×¢';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        const computedStyle = getComputedStyle(document.documentElement);
        const surfaceColor = computedStyle.getPropertyValue('--color-surface').trim();
        const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
        const dangerColor = computedStyle.getPropertyValue('--color-danger').trim();
        const successColor = computedStyle.getPropertyValue('--color-success').trim();
        const warningColor = computedStyle.getPropertyValue('--color-warning').trim();
        const textBaseColor = computedStyle.getPropertyValue('--color-text-base').trim();

        const chartColors = {
            '×¤×ª×•×—': successColor,
            '×—×•×¨×’': dangerColor,
            '×¡×’×•×¨': 'rgba(108, 117, 125, 0.8)',
            '×”×•×¨×“×”': successColor,
            '×”×—×œ×¤×”': warningColor,
            '×”×¢×œ××”': dangerColor
        };

        const getOpaqueColor = (color) => {
            if (color.startsWith('rgba')) {
                return color.replace(/, ?\d(\.\d+)?\)$/, ')').replace('rgba', 'rgb');
            }
            return color;
        };


        if (charts.customerChart) charts.customerChart.destroy();
        charts.customerChart = new Chart(document.getElementById('chart-containers-by-customer').getContext('2d'), {
            type: 'bar',
            data: {
                labels: sortedCustomers.map(c => c[0]),
                datasets: [{
                    label: '××¡×¤×¨ ××›×•×œ×•×ª ×‘×©×™××•×©',
                    data: sortedCustomers.map(c => c[1]),
                    backgroundColor: primaryColor,
                    borderColor: getOpaqueColor(primaryColor),
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false }
                    },
                    y: {
                        grid: { display: false }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const customerName = sortedCustomers[index][0];
                        document.getElementById('search-input').value = customerName;
                        filterTable();
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });

        if (charts.statusChart) charts.statusChart.destroy();
        charts.statusChart = new Chart(document.getElementById('chart-status-pie').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: Object.keys(statusData).map(status => chartColors[status] || '#bdc3c7'),
                    borderColor: surfaceColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            color: textBaseColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const statusClicked = Object.keys(statusData)[index];
                        document.getElementById('search-input').value = '';
                        document.getElementById('show-closed-orders').checked = (statusClicked === '×¡×’×•×¨');
                        document.getElementById('filter-status-select').value = statusClicked;
                        filterTable(statusClicked, null, true);
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });

        if (charts.actionTypeChart) charts.actionTypeChart.destroy();
        charts.actionTypeChart = new Chart(document.getElementById('chart-action-type').getContext('2d'), {
            type: 'bar',
            data: {
                labels: Object.keys(actionTypeChartData),
                datasets: [{
                    label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                    data: Object.values(actionTypeChartData),
                    backgroundColor: Object.keys(actionTypeChartData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: Object.keys(actionTypeChartData).map(type => getOpaqueColor(chartColors[type] || '#bdc3c7')),
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { display: false }
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const actionTypeClicked = Object.keys(actionTypeChartData)[index];
                        document.getElementById('search-input').value = '';
                        document.getElementById('filter-action-type-select').value = actionTypeClicked;
                        filterTable(null, actionTypeClicked, true);
                        showPage('dashboard');
                        scrollToOrdersTable();
                    }
                }
            }
        });
    }

    // --- Container Inventory Updates ---
    function updateContainerInventory() {
        const inUseTableBody = document.querySelector('#containers-in-use-table tbody');
        const availableTableBody = document.querySelector('#containers-available-table tbody');
        inUseTableBody.innerHTML = '';
        availableTableBody.innerHTML = '';

        const containerStates = {};

        [...allOrders].sort((a, b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”'])).forEach(order => {
            const orderDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
            const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

            containersBrought.forEach(c => {
                 if (c && (!containerStates[c] || orderDate > containerStates[c].lastRelevantActivityDate)) {
                    containerStates[c] = {
                        status: 'available',
                        lastRelevantActivityDate: orderDate
                    };
                }
            });
            containersTaken.forEach(c => {
                if (c && !containersBrought.includes(c)) {
                    if (!containerStates[c] || orderDate > containerStates[c].lastRelevantActivityDate) {
                        if (order._effectiveStatus !== '×¡×’×•×¨') {
                            containerStates[c] = {
                                status: 'in-use',
                                lastRelevantActivityDate: orderDate,
                                currentOrder: order
                            };
                        } else {
                            containerStates[c] = {
                                status: 'available',
                                lastRelevantActivityDate: orderDate
                            };
                        }
                    }
                }
            });
        });

        Object.entries(containerStates).sort((a,b) => a[0].localeCompare(b[0])).forEach(([num, state]) => {
            const row = document.createElement('tr');
            row.className = 'border-b border-[var(--color-border)]';
            if (state.status === 'in-use') {
                row.innerHTML = `<td class="p-3"><span class="cursor-pointer hover:text-[var(--color-primary)]" onclick="showContainerHistory('${num}')"><i class="fas fa-box"></i> ${num}</span></td><td class="p-3">${state.currentOrder['×©× ×œ×§×•×—']}</td><td class="p-3">${formatDate(state.currentOrder['×ª××¨×™×š ×”×–×× ×”'])}</td>`;
                inUseTableBody.appendChild(row);
            } else {
                let estimatedAvailableDate = new Date(state.lastRelevantActivityDate);
                
                row.innerHTML = `<td class="p-3"><span class="cursor-pointer hover:text-[var(--color-primary)]" onclick="showContainerHistory('${num}')"><i class="fas fa-box"></i> ${num}</span></td><td class="p-3">${formatDate(estimatedAvailableDate)}</td>`;
                availableTableBody.appendChild(row);
            }
        });
    }


    // --- Kanban Board (Treatment Board) ---
    function renderTreatmentBoard() {
        const columns = {
            overdue: document.getElementById('column-overdue'),
            'in-progress': document.getElementById('column-in-progress'),
            resolved: document.getElementById('column-resolved'),
        };
        Object.values(columns).forEach(col => col.querySelectorAll('.kanban-item').forEach(item => item.remove()));

        const ordersForTreatment = allOrders.filter(o => 
            (o._effectiveStatus === '×—×•×¨×’' && o['Kanban Status'] !== '×˜×•×¤×œ×•') || 
            (o['Kanban Status'] === '×‘×˜×™×¤×•×œ')
        ); 

        document.getElementById('no-treatment-orders').classList.toggle('hidden', ordersForTreatment.length > 0);

        ordersForTreatment.forEach(order => {
            const item = document.createElement('div');
            item.className = 'kanban-item card p-4 cursor-grab bg-white border border-[var(--color-border)] rounded-lg shadow-sm';
            item.draggable = true;
            item.dataset.sheetRow = order.sheetRow;
            item.ondragstart = e => e.dataTransfer.setData('text/plain', order.sheetRow);
            
            const daysPassedHtml = order._effectiveStatus === '×—×•×¨×’' ?
                `<span class="overdue-text-blinking">${order._daysPassedCalculated || 0}</span>` :
                `${order._daysPassedCalculated || 0}`;

            item.innerHTML = `
                <p class="font-bold text-lg text-[var(--color-text-base)]">${order['×©× ×œ×§×•×—']}</p>
                <p class="text-sm text-[var(--color-text-muted)]">×ª×¢×•×“×”: ${order['×ª×¢×•×“×”']}</p>
                <p class="text-sm mt-2"><span class="font-semibold text-[var(--color-danger)]">${daysPassedHtml}</span> ×™××™× ×©×¢×‘×¨×•</p>
                <div class="flex justify-end gap-1 mt-3">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="×©×œ×— WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="×¢×¨×•×š"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="×©×›×¤×œ"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    ${order._effectiveStatus !== '×¡×’×•×¨' ? `<button class="action-icon-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="×¡×’×•×¨ ×”×–×× ×”"><i class="fas fa-check-circle text-[var(--color-success)]"></i></button>` : ''}
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="××—×§"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </div>
            `;
            
            let targetColumnElement;
            if (order['Kanban Status'] === '×‘×˜×™×¤×•×œ') {
                targetColumnElement = columns['in-progress'];
            } else if (order._effectiveStatus === '×—×•×¨×’' && order['Kanban Status'] !== '×˜×•×¤×œ×•') {
                targetColumnElement = columns['overdue'];
            } else {
                return; 
            }
            targetColumnElement.appendChild(item);
        });
    }
    
    function allowDrop(event) { event.preventDefault(); }

    async function drop(event) {
        event.preventDefault();
        const sheetRow = event.dataTransfer.getData('text/plain');
        const targetColumn = event.currentTarget;
        const currentOrder = allOrders.find(o => o.sheetRow === parseInt(sheetRow));
        if (!currentOrder) {
            return;
        }

        let updateData = {};
        if (targetColumn.id === 'column-overdue') {
            updateData['Kanban Status'] = null;
        } else if (targetColumn.id === 'column-in-progress') {
            updateData['Kanban Status'] = '×‘×˜×™×¤×•×œ';
        } else if (targetColumn.id === 'column-resolved') {
            updateData['Kanban Status'] = '×˜×•×¤×œ×•';
            updateData['×¡×˜×˜×•×¡'] = '×¡×’×•×¨';
            updateData['×ª××¨×™×š ×¡×’×™×¨×”'] = new Date().toISOString().split('T')[0];
            updateData['×”×¢×¨×•×ª ×¡×™×•×'] = '× ×¡×’×¨ ××•×˜×•××˜×™×ª ××œ×•×— ×”×§× ×‘×Ÿ.';
        }

        const response = await fetchData('edit', { id: sheetRow, data: JSON.stringify(updateData) });
        if (response.success) {
            showAlert('×¡×˜×˜×•×¡ ×”×–×× ×” ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
            loadOrders();
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡', 'error');
        }
    }

    // --- Data Refresh ---
    function refreshData() {
        showAlert('××¨×¢× ×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.', 'info');
        loadOrders();
    }

    // --- Page Navigation ---
    let currentPage = 'dashboard'; // Track current page

    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        document.querySelectorAll('.nav-tab-btn').forEach(b => b.classList.toggle('active', b.id === `nav-${pageId}`));
        
        currentPage = pageId; // Update current page tracker

        if (pageId === 'whatsapp-alerts') {
            populateWhatsAppTemplates();
        } else if (pageId === 'reports') {
            // Set default date range for reports to current month
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('report-start-date').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = lastDayOfMonth.toISOString().split('T')[0];
            filterReports(); // Automatically filter reports for current month
        }
    }

    // --- WhatsApp Templates and Typing Effect ---
    const whatsappTemplates = [
        { name: '×‘×¨×›×” - ×—. ×¡×‘×Ÿ', message: '×©×œ×•× [×©× ×œ×§×•×—] ×™×§×¨/×”, ×ª×•×“×” ×©×‘×—×¨×ª ×‘-×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ! ×× ×• ×œ×¨×©×•×ª×š ×‘×›×œ ×©××œ×”. ğŸ¤”ğŸ‘·â€â™‚ï¸ğŸ—ï¸' },
        { name: '×”×¦×‘×ª ××›×•×œ×” - ×”× ×—×™×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×œ×”×–×× ×” [×ª×¢×•×“×”] ×”×•×¦×‘×” ×‘×”×¦×œ×—×”. ×× × ×•×•×“× ×’×™×©×” × ×•×—×” ×œ×¤×™× ×•×™. ×œ×©××œ×•×ª: [×˜×œ×¤×•×Ÿ ×¢×¡×§].' },
        { name: '×”×ª×¨××” - ×œ×¤× ×™ ×—×¨×™×’×” (8 ×™××™×)', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] × ××¦××ª ××¦×œ×š ×›-8 ×™××™×. ×œ×ª×©×•××ª ×œ×‘×š, ××¢×œ 10 ×™××™× ××ª××¨×™×š ×”×–×× ×”, ×”××›×•×œ×” × ×—×©×‘×ª ×—×•×¨×’×ª. ×× × ×¦×•×¨ ×§×©×¨ ×œ×ª×™××•× ×”××©×š. âš ï¸' },
        { name: '×”×ª×¨××” - ×—×•×¨×’×ª (10 ×™××™× +)', message: '×”×•×“×¢×” ×—×©×•×‘×”: ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] ×—×•×¨×’×ª ×××•×¢×“ ×”×©×›×™×¨×•×ª ×‘-[×™××™× ×—×•×¨×’×™×] ×™××™×. ×× × ×¦×•×¨ ×§×©×¨ ×‘×”×§×“× ×œ×ª×™××•× ×”×—×œ×¤×”/×¤×™× ×•×™ ×“×—×•×£: [×˜×œ×¤×•×Ÿ ×¢×¡×§]. ğŸš¨' },
        { name: '×ª×™××•× ×”×—×œ×¤×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×œ×’×‘×™ ×”×–×× ×” [×ª×¢×•×“×”], × ×©××— ×œ×ª×× ×”×—×œ×¤×”. ××ª×™ × ×•×— ×œ×š ×©× ×’×™×¢? ×× × ×”×©×‘ ×œ×”×•×“×¢×” ×–×•. ğŸ—“ï¸' },
        { name: '×ª×™××•× ×”×•×¦××”', message: '×©×œ×•× [×©× ×œ×§×•×—], × ×©××— ×œ×ª×× ×”×•×¦××ª ××›×•×œ×” ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ××ª×™ × ×•×— ×œ×š ×©× ×’×™×¢? ×× × ×”×©×‘ ×œ×”×•×“×¢×” ×–×•. ğŸ—“ï¸' },
        { name: '×ª×–×›×•×¨×ª - ×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™', message: '×©×œ×•× [×©× ×œ×§×•×—], ×ª×–×›×•×¨×ª: ×ª××¨×™×š ×”×¡×™×•× ×”×¦×¤×•×™ ×©×œ ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] ×”×•× ×‘-[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]. ×× × ×¦×•×¨ ×§×©×¨ ×× ×ª×¨×¦×” ×œ×”××¨×™×š ××• ×œ×ª×× ×¤×™× ×•×™. ğŸ””' },
        { name: '×”×•×“×¢×” ×›×œ×œ×™×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×‘×”××©×š ×œ×”×–×× ×” [×ª×¢×•×“×”], ×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ...' },
        { name: '×”×•×“×¢×” ×¢×œ ×”×’×¢×ª ××›×•×œ×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] ×”×’×™×¢×” ×œ×™×¢×“×”. ×ª×•×“×” ×©×‘×—×¨×ª ×‘× ×•! ğŸ‰' },
        { name: '×”×•×“×¢×” ×¢×œ ××™×¡×•×£ ××›×•×œ×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”××›×•×œ×” ×‘×”×–×× ×” [×ª×¢×•×“×”] × ××¡×¤×” ×‘×”×¦×œ×—×”. × ×©××— ×œ×©×¨×ª ××•×ª×š ×©×•×‘ ×‘×¢×ª×™×“! ğŸ‘‹' },
        { name: '×©××œ×•×ª ×›×œ×œ×™×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ×¢×•××“×™× ×œ×¨×©×•×ª×š ×œ×›×œ ×©××œ×” ××• ×‘×§×©×” ×œ×’×‘×™ ×”×©×™×¨×•×ª ×©×œ× ×•. â“' },
        { name: '×ª×œ×•× ×”/×‘×¢×™×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”×‘× ×• ×©×™×© ×œ×š ×‘×¢×™×” ×¢× ×”×–×× ×” [×ª×¢×•×“×”]. ×× ×• ××¦×˜×¢×¨×™× ×¢×œ ××™ ×”× ×•×—×•×ª ×•× ×—×–×•×¨ ××œ×™×š ×‘×”×§×“× ×œ×˜×¤×œ ×‘×¢× ×™×™×Ÿ. ğŸ˜”' },
        { name: '×‘×§×©×ª ×—×•×•×ª ×“×¢×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××§×•×•×™× ×©× ×”× ×™×ª ××”×©×™×¨×•×ª ×©×œ× ×• ×‘×”×–×× ×” [×ª×¢×•×“×”]. × ×©××— ×× ×ª×•×›×œ/×™ ×œ×”×©××™×¨ ×—×•×•×ª ×“×¢×ª ×§×¦×¨×”. â­' },
        { name: '×”×¦×¢×ª ×©×™×¨×•×ª×™× × ×•×¡×¤×™×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×¨××™× ×• ×©××ª×” ×œ×§×•×— ×¤×¢×™×œ. ××•×œ×™ ×™×¢× ×™×™×Ÿ ××•×ª×š ×œ×œ××•×“ ×¢×œ ×”×©×™×¨×•×ª×™× ×”×—×“×©×™× ×©×œ× ×•? âœ¨' },
        { name: '×¢×“×›×•×Ÿ ×–××™× ×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×¨×¦×™× ×• ×œ×¢×“×›×Ÿ ×œ×’×‘×™ ×–××™× ×•×ª ×”××›×•×œ×•×ª. ×›×¨×’×¢ ×™×© ×œ× ×•... â„¹ï¸' },
        { name: '××™×©×•×¨ ×”×–×× ×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”×–×× ×ª×š ××¡×¤×¨ [×ª×¢×•×“×”] ××•×©×¨×” ×‘×”×¦×œ×—×”! ×ª××¨×™×š ××¡×¤×§×” ×¦×¤×•×™: [×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]. âœ…' },
        { name: '×”×•×“×¢×” ×¢×œ ×¢×™×›×•×‘', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××ª× ×¦×œ×™× ×¢×œ ×¢×™×›×•×‘ ×§×œ ×‘××¡×¤×§×ª ×”××›×•×œ×” ×œ×”×–×× ×” [×ª×¢×•×“×”]. ×× ×• ×¦×•×¤×™× ×©×ª×’×™×¢ ×‘-[×ª××¨×™×š ×—×“×©]. â³' },
        { name: '×ª×•×“×” ×¢×œ ×ª×©×œ×•×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×§×™×‘×œ× ×• ××ª ×”×ª×©×œ×•× ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ×ª×•×“×” ×¨×‘×”! ğŸ™' },
        { name: '×‘×§×©×ª ×ª×©×œ×•×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×ª×–×›×•×¨×ª ×œ×’×‘×™ ×ª×©×œ×•× ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ×× × ×‘×¦×¢ ××ª ×”×ª×©×œ×•× ×‘×”×§×“×. ğŸ’¸' },
        { name: '×¤× ×•×™ ×‘××§×•×', message: '×©×œ×•× [×©× ×œ×§×•×—], ×œ×’×‘×™ ×”×–×× ×” [×ª×¢×•×“×”], × ××©×¨ ×›×™ ×‘×•×¦×¢ ×¤×™× ×•×™ ××›×•×œ×” ×‘××ª×¨. ×× ×• ××¢×¨×™×›×™× ××ª ×©×™×ª×•×£ ×”×¤×¢×•×œ×”. ğŸ‘' },
        { name: '××™×©×•×¨ ×§×‘×œ×ª ××¡××›×™×', message: '×©×œ×•× [×©× ×œ×§×•×—], ××™×©×•×¨ ×§×‘×œ×ª ×”××¡××›×™× ×”×“×¨×•×©×™× ×¢×‘×•×¨ ×”×–×× ×” [×ª×¢×•×“×”]. ×ª×•×“×” ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×”. ğŸ“„' },
        { name: '×¢×“×›×•×Ÿ ×©×¢×•×ª ×¤×¢×™×œ×•×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×œ×ª×©×•××ª ×œ×™×‘×š, ×©×¢×•×ª ×”×¤×¢×™×œ×•×ª ×©×œ× ×• ×¢×•×“×›× ×•. ×¤×¨×˜×™× ×‘××ª×¨: [×§×™×©×•×¨ ×œ××ª×¨]. â°' },
        { name: '×”×•×“×¢×” ×¢×œ ×©×™×¨×•×ª ×—×“×©', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ×©××—×™× ×œ×”×•×“×™×¢ ×¢×œ ×©×™×¨×•×ª ×—×“×© ×©×œ× ×•: [×©× ×©×™×¨×•×ª]. ×œ×¤×¨×˜×™× × ×•×¡×¤×™×: [×§×™×©×•×¨]. ğŸ†•' },
        { name: '××™×¨×•×¢ ×—×‘×¨×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××–××™× ×™× ××•×ª×š ×œ××™×¨×•×¢ ×—×‘×¨×” ××™×•×—×“ ×©×™×ª×§×™×™× ×‘-[×ª××¨×™×š ××™×¨×•×¢]. ×¤×¨×˜×™× ×•×”×¨×©××”: [×§×™×©×•×¨]. ğŸ¥³' },
        { name: '×˜×™×¤×™× ×œ×ª×—×–×•×§×”', message: '×©×œ×•× [×©× ×œ×§×•×—], ×”× ×” ×›××” ×˜×™×¤×™× ×—×©×•×‘×™× ×œ×ª×—×–×•×§×” × ×›×•× ×” ×©×œ ×”××›×•×œ×” ×©×œ×š. ğŸ’¡' },
        { name: '×©×™× ×•×™ ×¤×¨×˜×™ ×§×©×¨', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×©×™× ×™×ª ×¤×¨×˜×™ ×§×©×¨, ×× × ×¢×“×›×Ÿ ××•×ª× ×• ×›×“×™ ×©× ×•×›×œ ×œ×”××©×™×š ×œ×ª×ª ×©×™×¨×•×ª ××™×˜×‘×™. ğŸ“' },
        { name: '×¡×§×¨ ×©×‘×™×¢×•×ª ×¨×¦×•×Ÿ', message: '×©×œ×•× [×©× ×œ×§×•×—], ×× ×• ××‘×§×©×™× ××ª ×¢×–×¨×ª×š ×‘××™×œ×•×™ ×¡×§×¨ ×©×‘×™×¢×•×ª ×¨×¦×•×Ÿ ×§×¦×¨ ×›×“×™ ×©× ×•×›×œ ×œ×”×©×ª×¤×¨. ğŸ˜Š' },
        { name: '×—×’ ×©××—', message: '×—×’ ×©××— [×©× ×œ×§×•×—]! ××›×•×œ× ×• ×‘-×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ. ğŸŠ' },
        { name: '×©× ×” ×˜×•×‘×”', message: '×©× ×” ×˜×•×‘×” ×•××‘×•×¨×›×ª [×©× ×œ×§×•×—]! ×××—×œ×™× ×œ×š ×©× ×” ×©×œ ×”×¦×œ×—×” ×•×©×’×©×•×’. ğŸŒŸ' },
        { name: '×¡×•×£ ×©× ×” ××–×¨×—×™×ª', message: '×©×œ×•× [×©× ×œ×§×•×—], ×ª×•×“×” ×¢×œ ×©× ×” × ×¤×œ××” ×©×œ ×©×™×ª×•×£ ×¤×¢×•×œ×”. × ×©××— ×œ×”××©×™×š ×œ×©×¨×ª ××•×ª×š ×’× ×‘×©× ×” ×”×‘××”! ğŸ‘‹' }
    ];

    let currentTypingIndex = 0;
    let currentTypingTemplateMessage = '';
    let typingInterval = null;

    function populateWhatsAppTemplates() {
        const select = document.getElementById('message-template-select');
        select.innerHTML = '<option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>';
        whatsappTemplates.forEach((template, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = template.name;
            select.appendChild(option);
        });
    }

    function loadWhatsAppTemplate() {
        const select = document.getElementById('message-template-select');
        const messageInput = document.getElementById('whatsapp-message-input');
        const selectedIndex = select.value;

        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        messageInput.value = '';

        if (selectedIndex !== "") {
            const template = whatsappTemplates[parseInt(selectedIndex)];
            let message = template.message;
            
            const customerName = document.getElementById('whatsapp-customer-name').value;
            const address = document.getElementById('whatsapp-address').value;
            const orderId = document.getElementById('details-order-id').textContent;
            
            message = message.replace('[×©× ×œ×§×•×—]', customerName || '×”×œ×§×•×—');
            message = message.replace('[×ª×¢×•×“×”]', orderId || '×œ× ×™×“×•×¢');
            message = message.replace('[×˜×œ×¤×•×Ÿ ×¢×¡×§]', '050-1234567');
            message = message.replace('[×›×ª×•×‘×ª]', address || '');
            
            const selectedOrder = allOrders.find(o => o['×ª×¢×•×“×”'] === orderId);
            if (selectedOrder) {
                if (selectedOrder._effectiveStatus === '×—×•×¨×’' && selectedOrder._daysPassedCalculated) {
                    message = message.replace('[×™××™× ×—×•×¨×’×™×]', selectedOrder._daysPassedCalculated);
                }
                if (selectedOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']) {
                    message = message.replace('[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]', formatDate(selectedOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']));
                }
                 if (selectedOrder['×ª××¨×™×š ×—×“×©']) { 
                    message = message.replace('[×ª××¨×™×š ×—×“×©]', formatDate(selectedOrder['×ª××¨×™×š ×—×“×©']));
                }
            }

            message = message.replace(/\[.*?\]/g, ''); 

            currentTypingTemplateMessage = message;
            currentTypingIndex = 0;
            messageInput.classList.add('typing-effect');
            typingInterval = setInterval(() => {
                if (currentTypingIndex < currentTypingTemplateMessage.length) {
                    messageInput.value += currentTypingTemplateMessage.charAt(currentTypingIndex);
                    currentTypingIndex++;
                    messageInput.scrollTop = messageInput.scrollHeight;
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    messageInput.classList.remove('typing-effect');
                }
            }, 30);
        } else {
            messageInput.value = '';
            messageInput.classList.remove('typing-effect');
        }
    }

    function clearWhatsAppMessage() {
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        document.getElementById('whatsapp-message-input').value = '';
        document.getElementById('whatsapp-message-input').classList.remove('typing-effect');
        document.getElementById('message-template-select').value = '';
        document.getElementById('whatsapp-customer-name').value = '';
        document.getElementById('whatsapp-phone-number').value = '';
        document.getElementById('whatsapp-address').value = '';
        document.getElementById('details-order-id').textContent = '';
    }

    // --- Reports Page Logic ---
    let reportsOrdersToDisplay = [];
    const REPORTS_INITIAL_DISPLAY_LIMIT = 20;
    let currentReportsDisplayCount = 0;

    function filterReports() {
        const startDateInput = document.getElementById('report-start-date').value;
        const endDateInput = document.getElementById('report-end-date').value;

        let filteredReports = allOrders;

        if (startDateInput) {
            const startDate = new Date(startDateInput);
            filteredReports = filteredReports.filter(order => new Date(order['×ª××¨×™×š ×”×–×× ×”']) >= startDate);
        }
        if (endDateInput) {
            const endDate = new Date(endDateInput);
            filteredReports = filteredReports.filter(order => new Date(order['×ª××¨×™×š ×”×–×× ×”']) <= endDate);
        }

        // Sort by date (newest first) for reports
        filteredReports.sort((a, b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”']));
        
        reportsOrdersToDisplay = filteredReports;
        currentReportsDisplayCount = REPORTS_INITIAL_DISPLAY_LIMIT;

        updateReportSummaries(filteredReports);
        drawReportCharts(filteredReports);
        renderReportTable(reportsOrdersToDisplay.slice(0, currentReportsDisplayCount));
    }

    function resetReportFilters() {
        document.getElementById('report-start-date').value = '';
        document.getElementById('report-end-date').value = '';
        filterReports(); // Re-filter with no dates
    }

    function updateReportSummaries(orders) {
        let downloads = 0;
        let exchanges = 0;
        let uploads = 0;

        orders.forEach(order => {
            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¨×“×”') downloads++;
            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×—×œ×¤×”') exchanges++;
            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¢×œ××”') uploads++;
        });

        document.getElementById('summary-downloads').textContent = downloads;
        document.getElementById('summary-exchanges').textContent = exchanges;
        document.getElementById('summary-uploads').textContent = uploads;
    }

    function drawReportCharts(orders) {
        const computedStyle = getComputedStyle(document.documentElement);
        const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
        const dangerColor = computedStyle.getPropertyValue('--color-danger').trim();
        const successColor = computedStyle.getPropertyValue('--color-success').trim();
        const warningColor = computedStyle.getPropertyValue('--color-warning').trim();
        const textBaseColor = computedStyle.getPropertyValue('--color-text-base').trim();
        const surfaceColor = computedStyle.getPropertyValue('--color-surface').trim();

        const chartColors = {
            '×”×•×¨×“×”': successColor,
            '×”×—×œ×¤×”': warningColor,
            '×”×¢×œ××”': dangerColor
        };
        const getOpaqueColor = (color) => {
            if (color.startsWith('rgba')) {
                return color.replace(/, ?\d(\.\d+)?\)$/, ')').replace('rgba', 'rgb');
            }
            return color;
        };

        // Monthly Actions Chart
        const monthlyData = orders.reduce((acc, order) => {
            const date = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
            const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            if (!acc[monthYear]) {
                acc[monthYear] = { '×”×•×¨×“×”': 0, '×”×—×œ×¤×”': 0, '×”×¢×œ××”': 0 };
            }
            if (order['×¡×•×’ ×¤×¢×•×œ×”']) {
                acc[monthYear][order['×¡×•×’ ×¤×¢×•×œ×”']]++;
            }
            return acc;
        }, {});

        const sortedMonths = Object.keys(monthlyData).sort();
        const monthlyDownloads = sortedMonths.map(month => monthlyData[month]['×”×•×¨×“×”']);
        const monthlyExchanges = sortedMonths.map(month => monthlyData[month]['×”×—×œ×¤×”']);
        const monthlyUploads = sortedMonths.map(month => monthlyData[month]['×”×¢×œ××”']);

        if (charts.reportsMonthlyActions) charts.reportsMonthlyActions.destroy();
        charts.reportsMonthlyActions = new Chart(document.getElementById('chart-reports-monthly-actions').getContext('2d'), {
            type: 'bar',
            data: {
                labels: sortedMonths,
                datasets: [
                    {
                        label: '×”×•×¨×“×•×ª ğŸ“¦â¬‡ï¸',
                        data: monthlyDownloads,
                        backgroundColor: chartColors['×”×•×¨×“×”'],
                        borderColor: getOpaqueColor(chartColors['×”×•×¨×“×”']),
                        borderWidth: 1,
                        borderRadius: 5
                    },
                    {
                        label: '×”×—×œ×¤×•×ª ğŸ”„',
                        data: monthlyExchanges,
                        backgroundColor: chartColors['×”×—×œ×¤×”'],
                        borderColor: getOpaqueColor(chartColors['×”×—×œ×¤×”']),
                        borderWidth: 1,
                        borderRadius: 5
                    },
                    {
                        label: '×”×¢×œ××•×ª â¬†ï¸',
                        data: monthlyUploads,
                        backgroundColor: chartColors['×”×¢×œ××”'],
                        borderColor: getOpaqueColor(chartColors['×”×¢×œ××”']),
                        borderWidth: 1,
                        borderRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textBaseColor
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                        grid: { display: false }
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        grid: { display: true, color: 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });

        // Action Distribution Chart (Pie/Doughnut)
        const actionDistributionData = orders.reduce((acc, order) => {
            const actionType = order['×¡×•×’ ×¤×¢×•×œ×”'];
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        if (charts.reportsActionDistribution) charts.reportsActionDistribution.destroy();
        charts.reportsActionDistribution = new Chart(document.getElementById('chart-reports-action-distribution').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(actionDistributionData),
                datasets: [{
                    data: Object.values(actionDistributionData),
                    backgroundColor: Object.keys(actionDistributionData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: surfaceColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textBaseColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderReportTable(ordersToRender) {
        const tableBody = document.querySelector('#reports-orders-table tbody');
        tableBody.innerHTML = '';
        const noOrdersMessage = document.getElementById('no-report-orders');
        const loadMoreContainer = document.getElementById('reports-load-more-container');

        if (reportsOrdersToDisplay.length === 0) {
            noOrdersMessage.classList.remove('hidden');
            loadMoreContainer.classList.add('hidden');
            return;
        } else {
            noOrdersMessage.classList.add('hidden');
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer`;
            row.onclick = () => showOrderDetailsModal(order.sheetRow);

            const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')"><i class="fas fa-box"></i> ${c.trim()}</span>`
            ).join(' ');

            let actionEmoji = '';
            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¨×“×”') actionEmoji = 'ğŸ“¦â¬‡ï¸';
            else if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×—×œ×¤×”') actionEmoji = 'ğŸ”„';
            else if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¢×œ××”') actionEmoji = 'â¬†ï¸';

            row.innerHTML = `
                <td class="p-3">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                <td class="p-3">${order['×ª×¢×•×“×”'] || ''}</td>
                <td class="p-3">${order['×©× ×œ×§×•×—'] || ''}</td>
                <td class="p-3">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''} ${actionEmoji}</td>
                <td class="p-3">${containerHTML}</td>
                <td class="p-3"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
            `;
        });

        // Show/hide Load More button
        if (currentReportsDisplayCount < reportsOrdersToDisplay.length) {
            loadMoreContainer.classList.remove('hidden');
        } else {
            loadMoreContainer.classList.add('hidden');
        }
    }

    function loadMoreReportOrders() {
        currentReportsDisplayCount += REPORTS_INITIAL_DISPLAY_LIMIT;
        renderReportTable(reportsOrdersToDisplay.slice(0, currentReportsDisplayCount));
    }

    async function sendReportsByEmail() {
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const filteredOrders = reportsOrdersToDisplay; // Use the already filtered data

        if (filteredOrders.length === 0) {
            showAlert('××™×Ÿ × ×ª×•× ×™× ×‘×“×•×— ×œ×©×œ×™×—×” ×‘××™×™×œ.', 'warning');
            return;
        }

        // Prepare email content (simplified for this example, a full HTML report would be complex)
        let emailBody = `
            ×©×œ×•× ×¨×‘,
            ××¦"×‘ ×¡×™×›×•× ×¤×¢×™×œ×•×ª ××›×•×œ×•×ª ×œ×ª×§×•×¤×”: ${formatDate(startDate || '×”×ª×—×œ×”')} - ${formatDate(endDate || '×”×™×•×')}.

            *×¡×™×›×•××™×:*
            ×¡×”"×› ×”×•×¨×“×•×ª: ${document.getElementById('summary-downloads').textContent}
            ×¡×”"×› ×”×—×œ×¤×•×ª: ${document.getElementById('summary-exchanges').textContent}
            ×¡×”"×› ×”×¢×œ××•×ª: ${document.getElementById('summary-uploads').textContent}

            *×”×–×× ×•×ª ×¨×œ×•×•× ×˜×™×•×ª:*
        `;

        filteredOrders.forEach(order => {
            emailBody += `
            - ×ª×¢×•×“×”: ${order['×ª×¢×•×“×”']}, ×œ×§×•×—: ${order['×©× ×œ×§×•×—']}, ×¤×¢×•×œ×”: ${order['×¡×•×’ ×¤×¢×•×œ×”']}, ×ª××¨×™×š: ${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}, ×¡×˜×˜×•×¡: ${order._effectiveStatus}
            `;
        });

        emailBody += `
            \n×‘×‘×¨×›×”,
            ×¦×•×•×ª ×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ
        `;

        const recipientEmail = prompt("×”×–×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ ×œ×©×œ×™×—×ª ×”×“×•×—:");
        if (!recipientEmail || !recipientEmail.includes('@')) {
            showAlert('×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×—×•×§×™×ª.', 'error');
            return;
        }

        showAlert('×©×•×œ×— ×“×•×— ×‘××™×™×œ... ×× × ×”××ª×Ÿ.', 'info');
        const response = await fetchData('sendReportEmail', {
            recipient: recipientEmail,
            subject: `×“×•×— ×¤×¢×™×œ×•×ª ××›×•×œ×•×ª: ${formatDate(startDate || '×”×ª×—×œ×”')} - ${formatDate(endDate || '×”×™×•×')}`,
            body: emailBody
        }, EMAIL_SCRIPT_URL); // Pass the email script URL specifically

        if (response.success) {
            showAlert('×”×“×•×— × ×©×œ×— ×‘×”×¦×œ×—×” ×œ××™×™×œ!', 'success');
        } else {
            showAlert(response.message || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×•×—.', 'error');
        }
    }


    // --- Scroll to Top Functionality ---
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

    window.onscroll = function() {
        if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
            scrollToTopBtn.style.display = "block";
            scrollToTopBtn.style.opacity = "1";
        } else {
            scrollToTopBtn.style.opacity = "0";
            setTimeout(() => { scrollToTopBtn.style.display = "none"; }, 300);
        }
    };

    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });
    }

    function scrollToOrdersTable() {
        document.getElementById('orders-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // --- New Function: Show Customer Profile ---
    function showCustomerProfile(customerName) {
        const customerOrders = allOrders.filter(o => o['×©× ×œ×§×•×—'] === customerName);
        if (customerOrders.length === 0) {
            showAlert('×œ× × ××¦××• ×”×–×× ×•×ª ×¢×‘×•×¨ ×œ×§×•×— ×–×”.', 'warning');
            return;
        }

        const openOrders = customerOrders.filter(o => o._effectiveStatus === '×¤×ª×•×—').length;
        const overdueOrders = customerOrders.filter(o => o._effectiveStatus === '×—×•×¨×’').length;
        const totalOrders = customerOrders.length;
        
        const lastOrder = customerOrders.sort((a,b) => new Date(b['×ª××¨×™×š ×”×–×× ×”']) - new Date(a['×ª××¨×™×š ×”×–×× ×”']))[0];
        const lastOrderDate = lastOrder ? formatDate(lastOrder['×ª××¨×™×š ×”×–×× ×”']) : 'N/A';

        // Update modal title and stats
        document.getElementById('profile-customer-name').textContent = `×¤×¨×•×¤×™×œ ×œ×§×•×—: ${customerName}`;
        const profileContent = document.getElementById('customer-profile-content');
        profileContent.innerHTML = `
            <div class="card p-6 bg-gray-50 border border-gray-200">
                <p class="text-sm font-medium text-gray-500">××¡×¤×¨ ×”×–×× ×•×ª ×›×•×œ×œ</p>
                <p class="text-4xl font-bold text-gray-800 mt-2">${totalOrders}</p>
            </div>
            <div class="card p-6 bg-green-50 border border-green-200">
                <p class="text-sm font-medium text-green-700">×”×–×× ×•×ª ×¤×ª×•×—×•×ª ×›×¨×’×¢</p>
                <p class="text-4xl font-bold text-green-800 mt-2">${openOrders}</p>
            </div>
            <div class="card p-6 bg-red-50 border border-red-200">
                <p class="text-sm font-medium text-red-700">×”×–×× ×•×ª ×—×•×¨×’×•×ª</p>
                <p class="text-4xl font-bold text-red-800 mt-2">${overdueOrders}</p>
            </div>
            <div class="card p-6 bg-blue-50 border border-blue-200">
                <p class="text-sm font-medium text-blue-700">×ª××¨×™×š ×”×–×× ×” ××—×¨×•× ×”</p>
                <p class="text-xl font-bold text-blue-800 mt-2">${lastOrderDate}</p>
            </div>
            <div class="card p-6 md:col-span-2">
                <h3 class="text-lg font-bold text-gray-800 mb-4">×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×¤×¢×•×œ×•×ª</h3>
                <canvas id="profile-action-type-chart"></canvas>
            </div>
        `;
        
        // Render orders table in the profile modal
        const tableBody = document.querySelector('#customer-profile-orders-table tbody');
        tableBody.innerHTML = '';
        customerOrders.forEach(order => {
             const row = tableBody.insertRow();
             row.className = `border-b border-gray-200 cursor-pointer`;
             row.onclick = () => {
                 closeModal('customer-profile-modal');
                 showOrderDetailsModal(order.sheetRow);
             };
             row.innerHTML = `
                <td class="p-3">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                <td class="p-3">${order['×ª×¢×•×“×”'] || ''}</td>
                <td class="p-3">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                <td class="p-3"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3">${order._daysPassedCalculated || ''}</td>
                <td class="p-3">
                    <button class="action-icon-btn" onclick="event.stopPropagation(); printOrderDocument(allOrders.find(o => o.sheetRow === ${order.sheetRow}))" title="×”×“×¤×¡">
                        <i class="fas fa-print"></i>
                    </button>
                </td>
            `;
        });
        
        // Draw the chart
        drawCustomerProfileCharts(customerOrders);

        openModal('customer-profile-modal');
    }

    // --- New Function: Draw Customer Profile Charts ---
    function drawCustomerProfileCharts(orders) {
        if (charts.customerProfileActionChart) {
            charts.customerProfileActionChart.destroy();
        }

        const actionTypeData = orders.reduce((acc, order) => {
            const actionType = order['×¡×•×’ ×¤×¢×•×œ×”'] || '×œ× ×™×“×•×¢';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        const chartColors = {
            '×”×•×¨×“×”': 'rgb(76, 175, 80)',
            '×”×—×œ×¤×”': 'rgb(255, 193, 7)',
            '×”×¢×œ××”': 'rgb(214, 69, 69)'
        };

        const ctx = document.getElementById('profile-action-type-chart').getContext('2d');
        charts.customerProfileActionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(actionTypeData),
                datasets: [{
                    data: Object.values(actionTypeData),
                    backgroundColor: Object.keys(actionTypeData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#2F4F4F'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- New Function: Update `renderOrdersTable` to include the customer profile link ---
    // The previous implementation of renderOrdersTable is now replaced with this.
    // The change is in the <td> for the customer name.
    function renderOrdersTable(ordersToRender) {
        const tableBody = document.querySelector('#orders-table tbody');
        tableBody.innerHTML = '';
        if (ordersToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-[var(--color-text-muted)]">××™×Ÿ ×”×–×× ×•×ª ×œ×”×¦×’×” ×‘×¡×™× ×•×Ÿ ×”× ×•×›×—×™.</td></tr>`;
            return;
        }

        ordersToRender.forEach(order => {
            const row = tableBody.insertRow();
            const actionTypeClass = order['×¡×•×’ ×¤×¢×•×œ×”'] ? `action-type-${order['×¡×•×’ ×¤×¢×•×œ×”']}` : '';
            row.className = `border-b border-[var(--color-border)] transition-colors cursor-pointer ${actionTypeClass}`;
            
            if (order._effectiveStatus === '×—×•×¨×’') {
                row.classList.add('overdue-blinking');
            }

            row.dataset.sheetRow = order.sheetRow;
            row.onclick = (e) => {
                if (!e.target.closest('.action-icon-btn, .container-badge, .customer-name-link')) { 
                    showOrderDetailsModal(order.sheetRow);
                }
            };

            const containersTaken = String(order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const containersBrought = String(order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
            const allContainers = new Set([...containersTaken, ...containersBrought]);
            
            const containerHTML = [...allContainers].filter(Boolean).map(c => 
                `<span class="container-badge inline-block bg-[var(--color-secondary)] text-[var(--color-text-base)] text-xs font-semibold px-2.5 py-0.5 rounded-full cursor-pointer hover:bg-[var(--color-primary)] hover:text-white transition-colors" onclick="event.stopPropagation(); showContainerHistory('${c.trim()}')"><i class="fas fa-box"></i> ${c.trim()}</span>`
            ).join(' ');

            const daysPassedHtml = order._effectiveStatus === '×—×•×¨×’' ?
                `<span class="overdue-text-blinking">${order._daysPassedCalculated || ''}</span>` :
                `${order._daysPassedCalculated || ''}`;

            row.innerHTML = `
                <td class="p-3 font-medium" data-label="×ª××¨×™×š">${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</td>
                <td class="p-3 font-medium" data-label="×ª×¢×•×“×”">${order['×ª×¢×•×“×”'] || ''}</td>
                <td class="p-3 font-semibold customer-name-link cursor-pointer hover:text-[var(--color-primary)]" onclick="event.stopPropagation(); showCustomerProfile('${order['×©× ×œ×§×•×—']}')" data-label="×œ×§×•×—">${order['×©× ×œ×§×•×—'] || ''}</td>
                <td class="p-3 font-medium" data-label="×›×ª×•×‘×ª">${order['×›×ª×•×‘×ª'] || ''}</td>
                <td class="p-3" data-label="×¡×•×’ ×¤×¢×•×œ×”">${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
                <td class="p-3" data-label="×™××™× ×©×¢×‘×¨×•">${daysPassedHtml}</td>
                <td class="p-3" data-label="××›×•×œ×•×ª">${containerHTML}</td>
                <td class="p-3" data-label="×¡×˜×˜×•×¡"><span class="status-${(order._effectiveStatus || '').replace(/[/ ]/g, '-').toLowerCase()}">${order._effectiveStatus || ''}</span></td>
                <td class="p-3 whitespace-nowrap" data-label="×¤×¢×•×œ×•×ª">
                    <button class="action-icon-btn whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppAlertsForOrder(${order.sheetRow})" title="×©×œ×— WhatsApp"><i class="fab fa-whatsapp text-green-500"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openOrderModal('edit', ${order.sheetRow})" title="×¢×¨×•×š"><i class="fas fa-edit text-[var(--color-info)]"></i></button>
                    <button class="action-icon-btn" onclick="event.stopPropagation(); duplicateOrder(${order.sheetRow})" title="×©×›×¤×œ"><i class="fas fa-copy text-[var(--color-primary)]"></i></button>
                    ${order._effectiveStatus !== '×¡×’×•×¨' ? `<button class="action-icon-btn" onclick="event.stopPropagation(); openCloseOrderModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="×¡×’×•×¨ ×”×–×× ×”"><i class="fas fa-check-circle text-[var(--color-success)]"></i></button>` : ''}
                    <button class="action-icon-btn" onclick="event.stopPropagation(); openDeleteConfirmModal(${order.sheetRow}, '${order['×ª×¢×•×“×”']}')" title="××—×§"><i class="fas fa-trash text-[var(--color-danger)]"></i></button>
                </td>
            `;
        });
    }

    // --- New Function: Draw Customer Profile Charts ---
    function drawCustomerProfileCharts(orders) {
        if (charts.customerProfileActionChart) {
            charts.customerProfileActionChart.destroy();
        }

        const actionTypeData = orders.reduce((acc, order) => {
            const actionType = order['×¡×•×’ ×¤×¢×•×œ×”'] || '×œ× ×™×“×•×¢';
            acc[actionType] = (acc[actionType] || 0) + 1;
            return acc;
        }, {});

        const chartColors = {
            '×”×•×¨×“×”': 'rgb(76, 175, 80)',
            '×”×—×œ×¤×”': 'rgb(255, 193, 7)',
            '×”×¢×œ××”': 'rgb(214, 69, 69)'
        };

        const ctx = document.getElementById('profile-action-type-chart').getContext('2d');
        charts.customerProfileActionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(actionTypeData),
                datasets: [{
                    data: Object.values(actionTypeData),
                    backgroundColor: Object.keys(actionTypeData).map(type => chartColors[type] || '#bdc3c7'),
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#2F4F4F'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Initial Application Load ---
    window.onload = () => {
        initializeTheme();
        loadOrders();
        populateWhatsAppTemplates();
    };

    // --- Printing Order Document (New Function) ---
    function printOrderDocument(order) {
        if (!order) {
            showAlert('×œ× × ×™×ª×Ÿ ×œ×”×“×¤×™×¡: ×¤×¨×˜×™ ×”×–×× ×” ×œ× × ××¦××•.', 'error');
            return;
        }

        // Calculate overdue days
        const orderDate = new Date(order['×ª××¨×™×š ×”×–×× ×”']);
        const today = new Date();
        const overdueDays = Math.max(0, Math.floor((today - orderDate) / (1000 * 60 * 60 * 24)));
        const isOverdue = overdueDays > 10; // Assuming 10 days is the threshold

        // Generate the HTML for the print document
        const printContent = `
            <div class="print-area-container ${isOverdue ? 'overdue-document' : ''}">
                <div class="header">
                    <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" alt="×œ×•×’×• ×—×‘×¨×”" class="logo">
                    <div class="text-left">
                        <p class="text-sm font-medium text-gray-700">×ª××¨×™×š: ${formatDate(today)}</p>
                        <p class="text-sm font-medium text-gray-700">××¡×¤×¨ ×”×–×× ×”: ${order['×ª×¢×•×“×”'] || 'N/A'}</p>
                    </div>
                </div>

                ${isOverdue ? `
                <div class="mb-4 text-center">
                    <h2 class="overdue-title">×”×–×× ×” ×—×•×¨×’×ª</h2>
                </div>` : ''}

                <div class="details-grid">
                    <div class="detail-item">
                        <p><strong>×©× ×œ×§×•×—:</strong> ${order['×©× ×œ×§×•×—'] || ''}</p>
                        <p><strong>×›×ª×•×‘×ª:</strong> ${order['×›×ª×•×‘×ª'] || ''}</p>
                        <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] || ''}</p>
                    </div>
                    <div class="detail-item">
                        <p><strong>×¡×•×›×Ÿ ××›×™×¨×•×ª:</strong> ${order['×©× ×¡×•×›×Ÿ'] || ''}</p>
                        <p><strong>×ª××¨×™×š ×”×–×× ×”:</strong> ${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</p>
                        ${isOverdue ? `
                        <p><strong>××¡×¤×¨ ×™××™× ×—×¨×™×’×™×:</strong> <span class="overdue-marker">${overdueDays}</span> ×™××™×</p>
                        ` : ''}
                    </div>
                </div>

                <h3 class="section-title">×¤×¨×˜×™ ×”×–×× ×”</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>×ª×™××•×¨ ×¤×¨×™×˜</th>
                                <th>×›××•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    ×”×©×›×¨×ª ××›×•×œ×”: ${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || 'N/A'}
                                    <br>
                                    <span class="text-sm text-gray-500">
                                        ×¡×•×’ ×¤×¢×•×œ×”: ${order['×¡×•×’ ×¤×¢×•×œ×”'] || ''}
                                    </span>
                                </td>
                                <td>1</td>
                            </tr>
                            ${isOverdue ? `
                            <tr>
                                <td class="text-red-600 font-bold">×ª×•×¡×¤×ª ×¢×‘×•×¨ ×—×¨×™×’×” ×‘×™××™×</td>
                                <td>1</td>
                            </tr>` : ''}
                        </tbody>
                    </table>
                </div>

                <div class="mt-6">
                    <h3 class="section-title">×”×¢×¨×•×ª</h3>
                    <div class="detail-item">
                        <p>${order['×”×¢×¨×•×ª'] || ''}</p>
                        ${isOverdue ? `<p class="mt-2 text-red-600 font-bold">×”×¢×¨×” ×—×©×•×‘×”: ×‘×©×œ ×—×¨×™×’×” ××”××•×¢×“ ×”××§×•×¨×™, ×™×© ×œ×ª×× ×¤×™× ×•×™ ×‘×”×§×“×.</p>` : ''}
                    </div>
                </div>

                <div class="footer">
                    <p>×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¢"× | ×¨×—' ×”××œ××›×” 10, ×”×¨×¦×œ×™×” | ×˜×œ: 09-1234567 | ××™××™×™×œ: info@hsaban.co.il</p>
                    <p>Â© ${new Date().getFullYear()} ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.</p>
                </div>
            </div>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>×”×“×¤×¡×ª ××¡××š ×”×–×× ×”</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap');
            body { font-family: 'Rubik', sans-serif; background-color: #ffffff; margin: 0; padding: 0; }
            .print-area-container {
                direction: rtl; 
                text-align: right; 
                margin: 0 auto; 
                max-width: 800px;
                padding: 2rem;
                box-sizing: border-box;
            }
            .overdue-document {
                border: 2px solid #dc2626; /* Add a red border for overdue documents */
                padding: 1.5rem;
                box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
            }
            .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem; }
            .logo { max-width: 150px; height: auto; }
            .overdue-title { font-size: 1.75rem; color: #dc2626 !important; -webkit-print-color-adjust: exact; text-shadow: none; font-weight: 700; }
            .overdue-marker { font-weight: 700; color: #dc2626 !important; -webkit-print-color-adjust: exact; background-color: #fef2f2; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
            .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
            .detail-item { background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem; }
            .detail-item strong { color: #475569; }
            .section-title { font-size: 1.5rem; font-weight: 600; color: #334155; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; }
            .table-container { border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
            table { width: 100%; border-collapse: collapse; text-align: right; }
            th, td { padding: 1rem; border-bottom: 1px solid #e2e8f0; }
            th { background-color: #e2e8f0; font-weight: 600; color: #334155; }
            .footer { margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 0.875rem; }
            /* Hide non-print elements */
            @media print {
                body * { visibility: hidden; }
                .print-area-container, .print-area-container * { visibility: visible; }
                .print-area-container { position: absolute; left: 0; top: 0; width: 100%; box-sizing: border-box; }
            }
        `);
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }
</script>

</body>
</html>
